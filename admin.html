<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スタッフ管理</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#fafafa;--card:#fff}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:900px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.4rem;margin:0 0 .75rem}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:12px 0}
  input,button{border:1px solid var(--bd);border-radius:10px;padding:8px 10px;font-size:15px;background:#fff}
  button{background:#111827;color:#fff;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:#111827}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--bd);padding:6px 8px;text-align:left}
  th{background:#f8fafc}
  .note{color:var(--muted);font-size:.92rem}
</style>
</head>
<body>
<h1>スタッフ管理</h1>

<div class="card">
  <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="newName" placeholder="新規スタッフ名" style="min-width:240px">
    <button id="addBtn">＋ 追加</button>
    <button id="backBtn" class="ghost" style="margin-left:auto">← 提出画面へ</button>
  </div>
  <p class="note" style="margin-top:6px">※ ドロップダウンには「表示」にチェックが入っている人だけが並び、<br>並び順は <code>display_order</code>（小さいほど上）→ 名前 で決まります。</p>
</div>

<div class="card">
  <table id="tbl">
    <thead>
      <tr><th style="width:80px">順序</th><th>名前</th><th style="width:80px">表示</th><th style="width:160px">操作</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const SUPABASE_URL  = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const $ = s => document.querySelector(s);
$('#backBtn').onclick = ()=> location.href='index.html';

async function load(){
  const { data, error } = await supa
    .from('staff')
    .select('id,name,include,display_order')
    .order('display_order',{ascending:true})
    .order('name',{ascending:true});
  if(error){ alert('取得エラー：'+error.message); return; }

  const tbody = $('#tbl tbody'); tbody.innerHTML='';
  (data||[]).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><input type="number" min="1" value="${r.display_order}" data-id="${r.id}" class="ord" style="width:72px"></td>
      <td>${r.name}</td>
      <td style="text-align:center"><input type="checkbox" class="inc" data-id="${r.id}" ${r.include?'checked':''}></td>
      <td>
        <button class="save" data-id="${r.id}">保存</button>
        <button class="del ghost" data-id="${r.id}" style="margin-left:6px">削除</button>
      </td>`;
    tbody.appendChild(tr);
  });

  tbody.querySelectorAll('.save').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = +btn.dataset.id;
      const ord = +tbody.querySelector(`.ord[data-id="${id}"]`).value || 999;
      const inc = tbody.querySelector(`.inc[data-id="${id}"]`).checked;
      const { error } = await supa.from('staff').update({ display_order: ord, include: inc }).eq('id', id);
      if(error){ alert('保存エラー：'+error.message); return; }
      await load();
    };
  });
  tbody.querySelectorAll('.del').forEach(btn=>{
    btn.onclick = async ()=>{
      const id = +btn.dataset.id;
      if(!confirm('削除しますか？（この名前に結びつく提出は参照制約により削除できない場合があります）')) return;
      const { error } = await supa.from('staff').delete().eq('id', id);
      if(error){ alert('削除エラー：'+error.message); return; }
      await load();
    };
  });
}

$('#addBtn').onclick = async ()=>{
  const name = ($('#newName').value||'').trim();
  if(!name){ alert('名前を入力してください'); return; }
  // 重複回避（UNIQUE name）
  const { data:exists } = await supa.from('staff').select('id').eq('name', name).limit(1);
  if(exists && exists.length){ alert('その名前は既にあります'); return; }

  // 末尾に追加（現在の最大+10 を仮ルール）
  const { data:maxRow } = await supa.from('staff').select('display_order').order('display_order',{ascending:false}).limit(1);
  const base = (maxRow && maxRow.length ? maxRow[0].display_order : 0) + 10;

  const { error } = await supa.from('staff').insert({ name, display_order: base, include: true });
  if(error){ alert('追加エラー：'+error.message); return; }
  $('#newName').value='';
  await load();
};

load();
</script>
</body>
</html>
