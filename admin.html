<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>スタッフ管理（Web管理画面）</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111827;--bd:#e5e7eb;--muted:#6b7280;--card:#fff;--bg:#fafafa;--btn:#111827;--warn:#dc2626}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:980px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.5rem;margin:0 0 .75rem}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  input,button{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:var(--btn);color:#fff;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  button.warn{background:var(--warn)}
  button:disabled{opacity:.55;cursor:not-allowed}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:8px;font-size:14px;text-align:left;vertical-align:middle}
  th{background:#f8fafc}
  td.center,th.center{text-align:center}
  .nameCell{display:flex;gap:8px;align-items:center}
  .nameCell input{flex:1}
  .right{margin-left:auto}
  .small{font-size:.9rem}
  .err{color:#b91c1c;font-weight:700}
  .ok{color:#16a34a;font-weight:700}
</style>
</head>
<body>
<h1>スタッフ管理</h1>

<!-- パスワードゲート -->
<div class="card" id="gate">
  <p class="muted">閲覧・編集にはパスワードが必要です。</p>
  <form id="pwForm">
    <input type="password" id="pw" placeholder="パスワード" required />
    <button type="submit">入室</button>
  </form>
  <p id="pwMsg" class="muted"></p>
</div>

<!-- 本体 -->
<div id="app" class="card" style="display:none">
  <div class="row">
    <strong>スタッフ一覧</strong>
    <span class="muted small">（表示順は上から。チェックOFFはフォームに出しません）</span>
    <button id="toForm" class="ghost right">← 提出画面へ</button>
  </div>

  <div class="row" style="margin-top:8px">
    <input id="newName" placeholder="新しいスタッフ名を入力" style="min-width:260px" />
    <button id="addBtn">＋ 追加</button>
    <button id="saveOrderBtn" class="ghost">順序を保存</button>
    <span id="msg" class="small muted"></span>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:48px" class="center">順序</th>
        <th>名前</th>
        <th style="width:110px" class="center">表示</th>
        <th style="width:180px" class="center">操作</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>

<script>
/* ====== Supabase 接続（自身のプロジェクトに置き換え） ====== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI"; // ★改行なし
let supa = null;

/* ====== ゲート（kdt） ====== */
const gate = document.getElementById('gate');
const app  = document.getElementById('app');
document.getElementById('pwForm').onsubmit = (e)=>{
  e.preventDefault();
  if ((document.getElementById('pw').value || '').trim() !== 'kdt'){
    document.getElementById('pwMsg').textContent = 'パスワードが違います。';
    return;
  }
  // 表示
  gate.style.display='none'; app.style.display='';
  sessionStorage.setItem('admin_authed','1');
  try{
    supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }catch(err){
    setMsg('Supabase 初期化エラー：'+err.message, true);
    return;
  }
  init();
};
// 既認証ならスキップ
if (sessionStorage.getItem('admin_authed') === '1'){
  gate.style.display='none'; app.style.display='';
  try{
    supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    init();
  }catch(err){
    setMsg('Supabase 初期化エラー：'+err.message, true);
  }
}

/* ====== 画面操作 ====== */
document.getElementById('toForm').onclick = () => {
  location.href = new URL('index.html', location.href).href;
};
document.getElementById('addBtn').onclick = addStaff;
document.getElementById('saveOrderBtn').onclick = saveOrder;

const tbody = document.getElementById('tbody');
const msgEl = document.getElementById('msg');

function setMsg(text, isErr=false){
  msgEl.textContent = text;
  msgEl.className = 'small ' + (isErr ? 'err' : 'ok');
  if(!text) msgEl.className = 'small muted';
}

/* ====== データ取得 ====== */
async function fetchStaff(){
  // staff_order を先に取得して順序マップを作る
  const { data: orders } = await supa.from('staff_order').select('name, sort');
  const orderMap = new Map((orders || []).map(r => [r.name, r.sort]));

  // staff を取得
  const { data: staff, error } = await supa
    .from('staff')
    .select('name, include, is_admin')
    .order('name', { ascending: true });

  if (error){ setMsg('読み込みエラー：'+error.message, true); return []; }

  // 並び替え：sort → name
  const rows = (staff || []).map(r => ({
    name: r.name,
    include: !!r.include,
    is_admin: !!r.is_admin,
    sort: orderMap.get(r.name) ?? 999999   // 未設定は最後
  }));
  rows.sort((a,b)=>{
    if(a.sort !== b.sort) return a.sort - b.sort;
    return a.name.localeCompare(b.name, 'ja');
  });
  return rows;
}

/* ====== テーブル描画 ====== */
function renderTable(rows){
  tbody.innerHTML = '';
  rows.forEach((r, idx) => {
    const tr = document.createElement('tr');

    // 順序（表示用）
    const tdOrder = document.createElement('td');
    tdOrder.className = 'center';
    tdOrder.textContent = idx+1;
    tr.appendChild(tdOrder);

    // 名前（インライン編集可能）
    const tdName = document.createElement('td');
    tdName.innerHTML = `
      <div class="nameCell">
        <input value="${r.name}" data-orig="${r.name}" />
        ${r.is_admin ? '<span class="small muted">(admin)</span>' : ''}
      </div>`;
    tr.appendChild(tdName);

    // include チェック
    const tdInc = document.createElement('td');
    tdInc.className = 'center';
    tdInc.innerHTML = `<input type="checkbox" ${r.include ? 'checked':''}/>`;
    tr.appendChild(tdInc);

    // 操作
    const tdOps = document.createElement('td');
    tdOps.className = 'center';
    tdOps.innerHTML = `
      <div class="row" style="justify-content:center">
        <button class="ghost up">↑</button>
        <button class="ghost down">↓</button>
        <button class="ghost save">保存</button>
        <button class="warn del">削除</button>
      </div>`;
    tr.appendChild(tdOps);

    // 行にデータ保持
    tr.dataset.name = r.name;
    tr.dataset.sort = r.sort;
    tbody.appendChild(tr);
  });

  // イベント委譲
  tbody.onclick = async (ev)=>{
    const btn = ev.target.closest('button'); if(!btn) return;
    const tr = ev.target.closest('tr');
    if(btn.classList.contains('up')) moveRow(tr, -1);
    if(btn.classList.contains('down')) moveRow(tr, +1);
    if(btn.classList.contains('del')) delStaff(tr);
    if(btn.classList.contains('save')) saveRow(tr);
  };

  // include 変更
  tbody.onchange = async (ev)=>{
    const cb = ev.target.closest('input[type="checkbox"]'); if(!cb) return;
    const tr = ev.target.closest('tr'); if(!tr) return;
    const name = tr.dataset.name;
    const val = cb.checked;
    const { error } = await supa.from('staff').update({ include: val }).eq('name', name);
    if(error){ setMsg('表示切替エラー：'+error.message, true); cb.checked = !val; return; }
    setMsg(`表示フラグを更新：${name} → ${val ? 'ON' : 'OFF'}`);
  };
}

/* ====== 並び替え（上下） ====== */
function moveRow(tr, delta){
  const rows = Array.from(tbody.querySelectorAll('tr'));
  const idx = rows.indexOf(tr);
  const to  = idx + delta;
  if(to < 0 || to >= rows.length) return;
  if(delta < 0) tbody.insertBefore(tr, rows[to]);
  else tbody.insertBefore(rows[to], tr.nextSibling);
  // 表示中の順序番号を振り直し
  Array.from(tbody.querySelectorAll('tr')).forEach((r,i)=> r.children[0].textContent = i+1);
}

/* ====== 行の保存（名前変更） ====== */
async function saveRow(tr){
  const input = tr.querySelector('.nameCell input');
  const oldName = input.dataset.orig.trim();
  const newName = input.value.trim();
  if(!newName){ alert('名前を入力してください'); return; }
  if(oldName === newName){ setMsg('変更はありません'); return; }

  // staff.name を更新（外部キーは ON UPDATE CASCADE）
  const { error } = await supa.from('staff').update({ name: newName }).eq('name', oldName);
  if(error){ setMsg('名前変更エラー：'+error.message, true); return; }

  // staff_order も名前キーが変わるが、FK on update cascade なので追従する想定。
  tr.dataset.name = newName;
  input.dataset.orig = newName;
  setMsg(`名前を変更：${oldName} → ${newName}`);
}

/* ====== 削除 ====== */
async function delStaff(tr){
  const name = tr.dataset.name;
  if(!confirm(`${name} を削除しますか？\n（注意：関連する提出データがあれば制約で削除できない場合があります）`)) return;
  const { error } = await supa.from('staff').delete().eq('name', name);
  if(error){ setMsg('削除エラー：'+error.message, true); return; }
  tr.remove();
  Array.from(tbody.querySelectorAll('tr')).forEach((r,i)=> r.children[0].textContent = i+1);
  setMsg(`削除しました：${name}`);
}

/* ====== 追加 ====== */
async function addStaff(){
  const inp = document.getElementById('newName');
  const name = (inp.value || '').trim();
  if(!name){ alert('名前を入力してください'); return; }
  // staff へ追加
  const { error } = await supa.from('staff').insert({ name, include: true });
  if(error){ setMsg('追加エラー：'+error.message, true); return; }
  inp.value='';
  await init(true); // 再読み込み
  setMsg('追加しました：'+name);
}

/* ====== 並び順の保存 ====== */
async function saveOrder(){
  const rows = Array.from(tbody.querySelectorAll('tr')).map((tr,i)=>({name: tr.dataset.name, sort: i+1}));
  // upsert
  const { error } = await supa.from('staff_order')
    .upsert(rows, { onConflict: 'name' });
  if(error){ setMsg('順序保存エラー：'+error.message, true); return; }
  setMsg('順序を保存しました');
}

/* ====== 初期化 ====== */
async function init(skipScroll){
  setMsg('読み込み中…');
  const rows = await fetchStaff();
  renderTable(rows);
  if(!skipScroll) window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  setMsg('');
}
</script>
</body>
</html>
