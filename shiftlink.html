<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>提出済みシフト一覧</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111827;--bd:#e5e7eb;--muted:#6b7280;--bg:#fafafa;--card:#fff;--btn:#111827;--tab:#f3f4f6;--tabact:#111827;--tabactfg:#fff;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.5rem;margin:0 0 .75rem}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  input,select,button{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:var(--btn);color:#fff;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .note{color:var(--muted)}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:6px 8px;font-size:14px;text-align:center;vertical-align:middle}
  th{background:#f8fafc;position:sticky;top:0}
  th.stf,td.stf{position:sticky;left:0;background:#fff;z-index:1}
  .tabs{display:flex;gap:8px}
  .tab{background:var(--tab);color:#111;border:1px solid var(--bd);padding:6px 12px;border-radius:999px;cursor:pointer;font-weight:700}
  .tab.active{background:var(--tabact);color:var(--tabactfg)}
</style>
</head>
<body>
<h1>提出済みシフト一覧</h1>

<!-- パスワードゲート -->
<div id="gate" class="card">
  <p class="note">閲覧にはパスワードが必要です。</p>
  <form id="pwForm" class="row" onsubmit="return false;">
    <input type="password" id="pw" placeholder="パスワード" autocomplete="current-password" required />
    <button id="pwBtn" type="submit">表示する</button>
  </form>
  <p id="pwMsg" class="note"></p>
</div>

<!-- 本体 -->
<div id="app" class="card" style="display:none">
  <div class="row">
    <div class="row">
      <label>表示年月：
        <select id="yy"></select>
        <select id="mm"></select>
      </label>
      <button id="reload" class="ghost">再読込</button>
    </div>
    <div class="tabs right">
      <button id="tabL" class="tab active">ランチ</button>
      <button id="tabD" class="tab">ディナー</button>
    </div>
  </div>

  <div class="row" style="margin-top:6px">
    <button id="csvBtn">CSVダウンロード</button>
    <button id="toForm" class="ghost right">← 提出画面へ</button>
  </div>

  <div style="overflow:auto;max-width:100%;border:1px solid var(--bd);border-radius:10px;margin-top:10px">
    <table id="tbl"></table>
  </div>

  <p id="stat" class="note" style="margin-top:8px"></p>
</div>

<script>
/* ====== Supabase 接続（差し替え必須） ====== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";   // ←あなたのURL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";                           // ←あなたのAnon Key
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== パスワードゲート ====== */
const gate = document.getElementById('gate');
const app  = document.getElementById('app');
(function gateInit(){
  const ok = sessionStorage.getItem('shift_pw_ok') === '1';
  if(ok){ gate.style.display='none'; app.style.display=''; }
})();
document.getElementById('pwForm').addEventListener('submit', ()=>{
  const ok = document.getElementById('pw').value === 'kdt';
  if(!ok){ document.getElementById('pwMsg').textContent = 'パスワードが違います。'; return; }
  sessionStorage.setItem('shift_pw_ok','1');
  gate.style.display='none'; app.style.display='';
});

/* ====== UI要素 ====== */
const ySel = document.getElementById('yy');
const mSel = document.getElementById('mm');
const tbl  = document.getElementById('tbl');
const stat = document.getElementById('stat');
const tabL = document.getElementById('tabL');
const tabD = document.getElementById('tabD');
let viewKind = 'LUNCH'; // or 'DINNER'

tabL.onclick = ()=>{ viewKind='LUNCH'; tabL.classList.add('active'); tabD.classList.remove('active'); load(); };
tabD.onclick = ()=>{ viewKind='DINNER'; tabD.classList.add('active'); tabL.classList.remove('active'); load(); };

document.getElementById('reload').onclick = load;
document.getElementById('toForm').onclick = ()=> { location.href=new URL('index.html', location.href).href; };
document.getElementById('csvBtn').onclick = downloadCSV;

/* ====== 年月セレクト初期化 ====== */
(function initYM(){
  const t = new Date();
  for(let y=t.getFullYear()-2; y<=t.getFullYear()+1; y++){
    ySel.add(new Option(`${y}年`, y));
  }
  for(let m=1; m<=12; m++){
    mSel.add(new Option(`${m}月`, m));
  }
  ySel.value = t.getFullYear();
  mSel.value = t.getMonth()+1;
})();

/* ====== データロード ====== */
let lastMatrix = null; // CSV出力用に保持

async function load(){
  tbl.innerHTML = '<tr><td style="padding:16px;text-align:center">読み込み中…</td></tr>';
  stat.textContent = '';

  const y = +ySel.value, m = +mSel.value;
  const start = `${y}-${String(m).padStart(2,'0')}-01`;
  const end   = new Date(start); end.setMonth(end.getMonth()+1);
  const endStr = end.toISOString().slice(0,10);
  const daysInMonth = new Date(y, m, 0).getDate();

  // スタッフ一覧（順番）
  const { data: staffRows, error: staffErr } = await supa
    .from('staff')
    .select('name')
    .eq('include', true)
    .order('display_order',{ascending:true})
    .order('name',{ascending:true});
  if(staffErr){ tbl.innerHTML=`<tr><td style="padding:16px;color:#b91c1c">エラー：${staffErr.message}</td></tr>`; return; }
  const staff = (staffRows||[]).map(r=>r.name);

  // シフト（当月）
  const { data: rows, error: shiftErr } = await supa
    .from('shifts')
    .select('date,staff_name,start_time,end_time')
    .gte('date', start).lt('date', endStr)
    .order('staff_name',{ascending:true})
    .order('date',{ascending:true});
  if(shiftErr){ tbl.innerHTML=`<tr><td style="padding:16px;color:#b91c1c">エラー：${shiftErr.message}</td></tr>`; return; }

  // kind 判定
  function kindOf(r){
    if(!r.start_time || !r.end_time) return 'ANY'; // ◯
    return (r.start_time < '16:00') ? 'LUNCH' : 'DINNER';
  }

  // マトリクス name -> [days]
  const matrix = new Map();
  staff.forEach(n => matrix.set(n, Array(daysInMonth).fill('')));

  rows.forEach(r=>{
    const k = kindOf(r);
    if(k !== viewKind && !(k==='ANY')) return; // ◯ は両方に出す
    const idx = Number(r.date.slice(-2)) - 1;
    const val = (!r.start_time || !r.end_time) ? '◯'
              : `${r.start_time.slice(0,5)}〜${r.end_time.slice(0,5)}`;
    const arr = matrix.get(r.staff_name) || Array(daysInMonth).fill('');
    arr[idx] = arr[idx] ? `${arr[idx]} / ${val}` : val;
    matrix.set(r.staff_name, arr);
  });

  // 描画
  let html = '<tr><th class="stf" style="min-width:160px">スタッフ</th>';
  for(let d=1; d<=daysInMonth; d++){ html += `<th>${d}</th>`; }
  html += '</tr>';
  for(const n of staff){
    html += `<tr><th class="stf" style="text-align:left;background:#fff">${n}</th>`;
    const arr = matrix.get(n) || Array(daysInMonth).fill('');
    for(let i=0;i<daysInMonth;i++){ html += `<td>${arr[i]||''}</td>`; }
    html += '</tr>';
  }
  if(!staff.length){ html = '<tr><td style="padding:16px">表示対象のスタッフがいません（staff.include を確認）</td></tr>'; }
  tbl.innerHTML = html;

  // 統計
  const filled = rows.length;
  stat.textContent = `${y}年${m}月 ｜ 表示：${viewKind==='LUNCH'?'ランチ':'ディナー'} ｜ レコード数：${filled}`;
  lastMatrix = { year:y, month:m, kind:viewKind, staff, days:daysInMonth, matrix };
}

/* ====== CSVダウンロード（UTF-8 with BOM） ====== */
function downloadCSV(){
  if(!lastMatrix){ return; }
  const { year, month, kind, staff, days, matrix } = lastMatrix;
  const head = ['スタッフ', ...Array.from({length:days}, (_,i)=>`${i+1}`)];
  const rows = [head];
  for(const n of staff){
    const arr = matrix.get(n) || Array(days).fill('');
    rows.push([n, ...arr.map(v=>v||'')]);
  }
  const csv = '\uFEFF' + rows.map(r => r.map(v => {
    const s = String(v);
    return (s.includes(',') || s.includes('"') || s.includes('\n'))
      ? `"${s.replace(/"/g,'""')}"`
      : s;
  }).join(',')).join('\n');

  const blob = new Blob([csv], {type:'text/csv'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `shifts_${year}${String(month).padStart(2,'0')}_${kind==='LUNCH'?'lunch':'dinner'}.csv`;
  a.click();
  URL.revokeObjectURL(a.href);
}

/* ====== 初期化 ====== */
(async function init(){
  // ゲートを通過済みなら即ロード
  if(sessionStorage.getItem('shift_pw_ok')==='1'){ await load(); }
  ySel.addEventListener('change', load);
  mSel.addEventListener('change', load);
})();
</script>
</body>
</html>
