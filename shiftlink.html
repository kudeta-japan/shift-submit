<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>提出済みシフト一覧</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#fafafa;--btn:#111827;}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;max-width:1000px;margin:26px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .6rem}
  input,select,button{padding:10px;border:1px solid var(--bd);border-radius:10px;font-size:16px;background:#fff}
  button{background:var(--btn);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg);border:1px solid var(--bd)}
  button:hover{opacity:.92}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:10px 0}
  .note{color:var(--muted)}
  .card{background:#fff;border:1px solid var(--bd);border-radius:12px;padding:14px;margin:10px 0}
  table{border-collapse:collapse;width:100%;margin-top:10px}
  th,td{border:1px solid var(--bd);padding:8px;text-align:center}
  th{background:#f7f7f7}
  /* password gate */
  #gate{max-width:560px;margin:40px auto}
  #err{color:#b91c1c;margin-left:6px}
</style>
</head>
<body>
  <h1>提出済みシフト一覧</h1>

  <!-- ▼ パスワードゲート（正しいと中身を解放） -->
  <div id="gate" class="card" style="display:none">
    <div class="row">
      <span class="note">閲覧パスワードを入力してください：</span>
    </div>
    <div class="row">
      <input id="pw" type="password" placeholder="パスワード（kdt）" style="max-width:240px">
      <button id="pwBtn">開く</button>
      <span id="err" class="note"></span>
    </div>
    <div class="row">
      <label class="note" style="display:flex;align-items:center;gap:6px">
        <input id="remember" type="checkbox" checked> 8時間この端末で記憶
      </label>
    </div>
  </div>

  <!-- ▼ 本体（パス通過後に表示） -->
  <div id="app" style="display:none">
    <div class="row">
      <button class="ghost" onclick="location.href='index.html'">← 提出ページへ</button>
    </div>

    <div class="card">
      <div class="row">
        <label>表示月：<input type="month" id="month"></label>
        <label>スタッフ：<input id="name" placeholder="（空なら全員）"></label>
        <button id="loadBtn">表示</button>
        <span id="status" class="note"></span>
      </div>
      <table id="tbl">
        <thead>
          <tr><th>日付</th><th>スタッフ名</th><th>区分</th><th>開始</th><th>終了</th><th>備考</th></tr>
        </thead>
        <tbody><tr><td colspan="6" class="note">データ未表示</td></tr></tbody>
      </table>
    </div>
  </div>

<script>
/* ===== Supabase（URLは指定ドメインに固定 / 鍵はあなたの値に差し替え） ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* ===================================================================== */

const $=id=>document.getElementById(id);

/* ---------- パスワードゲート ---------- */
const PASS = "kdt";                 // ← 指定の閲覧パスワード
const KEY  = "shiftlink_gate_ok";   // localStorage key

function showGate(on){ $('gate').style.display = on ? '' : 'none'; $('app').style.display = on ? 'none' : ''; }

function checkRemember(){
  const raw = localStorage.getItem(KEY);
  if(!raw) return false;
  try{
    const {ok, until} = JSON.parse(raw);
    if(!ok || !until) return false;
    if(Date.now() > until) { localStorage.removeItem(KEY); return false; }
    return true;
  }catch{ return false; }
}

$('pwBtn').onclick = () => {
  $('err').textContent = '';
  const v = $('pw').value.trim();
  if(v !== PASS){ $('err').textContent = 'パスワードが違います'; return; }
  if($('remember').checked){
    const until = Date.now() + 8*60*60*1000; // 8時間
    localStorage.setItem(KEY, JSON.stringify({ok:true, until}));
  }
  showGate(false);
};

(function initGate(){
  if(checkRemember()){ showGate(false); }
  else{ showGate(true); }
})();

/* ---------- 一覧表示 ---------- */
$('loadBtn').onclick = load;

async function load(){
  const ym = $('month').value;
  if(!ym){ alert('年月を選択してください'); return; }

  $('status').textContent = '読み込み中…';

  const start = ym + "-01";
  const endDate = new Date(start); endDate.setMonth(endDate.getMonth()+1);
  const endStr = endDate.toISOString().slice(0,10);

  let q = supa.from('shifts').select('*')
              .gte('date', start).lt('date', endStr)
              .order('date',{ascending:true})
              .order('start_time',{ascending:true});
  const nm = $('name').value.trim(); if(nm) q = q.eq('staff_name', nm);

  const { data, error } = await q;
  if(error){ $('status').textContent='エラー: '+error.message; return; }

  const tb=$('tbl').querySelector('tbody'); tb.innerHTML='';
  if(!data.length){ tb.innerHTML='<tr><td colspan="6" class="note">該当データがありません</td></tr>'; $('status').textContent=''; return; }

  data.forEach(r=>{
    const slot = (r.start_time<'16:00')?'ランチ':'ディナー';
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.date}</td><td>${r.staff_name}</td><td>${slot}</td>
                    <td>${r.start_time}</td><td>${r.end_time}</td><td>${r.note||''}</td>`;
    tb.appendChild(tr);
  });
  $('status').textContent = `件数: ${data.length}`;
}

/* ---------- 初期値（月入力セット） ---------- */
(function init(){
  const t=new Date(); const ym=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}`;
  $('month').value = ym;
  if(!checkRemember()) return;   // 未解錠なら待機
  load();
})();
</script>
</body>
</html>
