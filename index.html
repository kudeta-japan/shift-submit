<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --bd:#e5e7eb; --bg:#fafafa; --card:#fff;
    --btn:#111827; --ok:#059669; --warn:#f59e0b;
    --draft:#fff7cc; --sent:#def7d9; --lunch:#fff1b8; --dinner:#ffd7c2;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .note{color:var(--muted);font-size:.92rem}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:var(--btn);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  button.primary{background:#0f172a}
  button:hover{opacity:.94}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .right{margin-left:auto}
  .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
  .box{border:1px dashed var(--bd);border-radius:12px;padding:12px}
  .box.l{background:var(--lunch)} .box.d{background:var(--dinner)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .dow{font-weight:700;text-align:center;color:#374151}
  .cell{border:1px solid var(--bd);border-radius:12px;min-height:88px;background:#fff;position:relative;padding:6px;cursor:pointer}
  .cell .day{position:absolute;top:6px;left:8px;font-weight:700;color:#4b5563}
  .cell .mark{position:absolute;bottom:6px;left:6px;right:6px;display:flex;flex-direction:column;gap:4px;font-size:.85rem}
  .tag{border:1px solid var(--bd);border-radius:8px;padding:2px 6px;background:#fff}
  .draft{background:var(--draft)}
  .sent{background:var(--sent)}
  .today{outline:2px solid var(--warn)}
  .selected{outline:2px solid var(--btn)}
  .legend{display:flex;gap:10px;align-items:center}
  .msg{margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .err{color:#b91c1c}
  .btn-area{display:flex;gap:10px}
</style>
</head>
<body>
<h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

<!-- ãƒ˜ãƒƒãƒ€ï¼ˆåå‰ãƒ­ãƒƒã‚¯ï¼‹æœŸé–“ãƒŠãƒ“ï¼‰ -->
<div class="card">
  <div class="row">
    <strong>ã‚ãªãŸã®åå‰</strong>
    <select id="nameSel" style="min-width:220px"></select>
    <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
    <span id="lockState" class="note"></span>
    <span class="right note">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯ <b>15æ—¥ï¼æœˆæœ«</b>ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
  </div>
</div>

<!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
      <div class="pill"><span id="ymLabel">YYYYå¹´Mæœˆ</span></div>
      <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
      <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
    </div>
    <div class="row">
      <label class="note">æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠï¼‰</label>
      <input id="dateInp" type="date">
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <div class="box l" style="flex:1 1 360px">
      <div class="row"><strong>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</strong></div>
      <div class="row">
        <label>é–‹å§‹
          <select id="lStart"></select>
        </label>
        <label>çµ‚äº†
          <select id="lEnd"></select>
        </label>
        <label class="note" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="lFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
        </label>
      </div>
    </div>
    <div class="box d" style="flex:1 1 360px">
      <div class="row"><strong>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“24:00ï¼‰</strong></div>
      <div class="row">
        <label>é–‹å§‹
          <select id="dStart"></select>
        </label>
        <label>çµ‚äº†
          <select id="dEnd"></select>
        </label>
        <label class="note" style="display:flex;align-items:center;gap:6px">
          <input type="checkbox" id="dFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
        </label>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <label style="flex:1">å‚™è€ƒï¼ˆä»»æ„ï¼‰
      <textarea id="memo" rows="2" style="width:100%"></textarea>
    </label>
  </div>

  <div class="btn-area" style="margin-top:8px">
    <button id="addUpdateBtn">è¿½åŠ /æ›´æ–°</button>
    <button id="deleteBtn" class="ghost">å‰Šé™¤</button>
    <button id="sendBtn" class="primary">é€ä¿¡</button>
  </div>
  <div id="msg" class="msg note"></div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="card">
  <div class="legend note" style="margin-bottom:8px">
    <span class="tag" style="background:var(--draft)">ä¸‹æ›¸ãã‚ã‚Š</span>
    <span class="tag" style="background:var(--sent)">é€ä¿¡æ¸ˆã¿</span>
    <span class="tag">ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼é¸æŠæ—¥</span>
    <button id="toListBtn" class="right ghost">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
  </div>
  <div id="cal" class="grid"></div>
</div>

<script>
/* ====== Supabase æ¥ç¶šï¼ˆå·®ã—æ›¿ãˆå¿…é ˆï¼‰ ====== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";  // â†ã‚ãªãŸã®URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";                         // â†ã‚ãªãŸã®Anon Key
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== è¦ç´  ====== */
const $ = id=>document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateInp=$('dateInp'), msg=$('msg');
const lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree');
const dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree');
const memo=$('memo');

/* ====== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====== */
const pad2=n=>String(n).padStart(2,'0');
const todayStr=(()=>{const t=new Date();return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`})();

/* ====== åå‰ï¼šãƒ­ãƒ¼ãƒ‰ï¼†ãƒ­ãƒƒã‚¯ ====== */
async function loadStaff(){
  const { data, error } = await supa
    .from('staff')
    .select('name')
    .eq('include', true)
    .order('display_order',{ascending:true})
    .order('name',{ascending:true});
  nameSel.innerHTML='';
  (data||[]).forEach(r=>nameSel.add(new Option(r.name,r.name)));
  const sv=localStorage.getItem('shift_name');
  if(sv){ const found=[...nameSel.options].some(o=>o.value===sv); if(found){nameSel.value=sv; setLock(true);} }
}
function setLock(on){
  nameSel.disabled = on;
  lockBtn.textContent = on ? 'ğŸ”“ å¤‰æ›´' : 'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent = on ? `ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}` : 'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick=()=>{
  if(nameSel.disabled){ localStorage.removeItem('shift_name'); setLock(false); }
  else{
    if(!nameSel.value) return alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
    localStorage.setItem('shift_name', nameSel.value); setLock(true);
  }
};

/* ====== æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆ30åˆ†åˆ»ã¿ï¼‰ ====== */
function fill(sel, startMin, endMin){ sel.innerHTML='';
  for(let m=startMin;m<=endMin;m+=30){
    const hh=pad2(Math.floor(m/60)), mm=pad2(m%60);
    sel.add(new Option(`${hh}:${mm}`,`${hh}:${mm}`));
  }
}
fill(lStart,600,960); fill(lEnd,600,960);          // 10:00â€“16:00
fill(dStart,1020,1440); fill(dEnd,1020,1440);      // 17:00â€“24:00
lStart.value='10:00'; lEnd.value='16:00'; dStart.value='17:00'; dEnd.value='24:00';

/* ====== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ====== */
let calYear, calMonth; // 1-based
function setToToday(){ const t=new Date(); t.setHours(0,0,0,0);
  calYear=t.getFullYear(); calMonth=t.getMonth()+1; dateInp.value=todayStr;
}
function renderCalendar(mark={}){ // mark: {date:{draft:boolean, sent:[ 'â—¯' or 'hh:mmã€œhh:mm', â€¦ ]}}
  $('ymLabel').textContent=`${calYear}å¹´${calMonth}æœˆ`;
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{const d=document.createElement('div');d.textContent=w;d.className='dow';cal.appendChild(d)});
  const first=new Date(calYear,calMonth-1,1);
  const startDow=first.getDay();
  const days=new Date(calYear,calMonth,0).getDate();
  for(let i=0;i<startDow;i++){ const e=document.createElement('div'); e.className='cell'; cal.appendChild(e) }
  for(let d=1; d<=days; d++){
    const ds=`${calYear}-${pad2(calMonth)}-${pad2(d)}`;
    const cell=document.createElement('div'); cell.className='cell';
    if(ds===todayStr) cell.classList.add('today');
    if(ds===dateInp.value) cell.classList.add('selected');
    cell.onclick=()=>{ dateInp.value=ds; renderCalendar(mark); };
    const day=document.createElement('div'); day.className='day'; day.textContent=d; cell.appendChild(day);
    const box=document.createElement('div'); box.className='mark';
    if(mark[ds]?.sent?.length){ cell.classList.add('sent'); mark[ds].sent.forEach(t=>box.innerHTML+=`<span class="tag">${t}</span>`); }
    if(mark[ds]?.draft){ cell.classList.add('draft'); }
    cell.appendChild(box);
    cal.appendChild(cell);
  }
}
function changeMonth(delta){
  calMonth+=delta; if(calMonth===0){calMonth=12;calYear--;} if(calMonth===13){calMonth=1;calYear++;}
  const cur=new Date(dateInp.value||`${calYear}-${pad2(calMonth)}-01`);
  if(cur.getFullYear()!==calYear || cur.getMonth()+1!==calMonth){ dateInp.value=`${calYear}-${pad2(calMonth)}-01`; }
  refreshMarks();
}
$('prevBtn').onclick=()=>changeMonth(-1);
$('nextBtn').onclick=()=>changeMonth(1);
$('thisBtn').onclick=()=>{ setToToday(); refreshMarks(); };

/* ====== ä¸‹æ›¸ãï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜ï¼‰ ====== */
/* å½¢ï¼š drafts[date] = { L:null|{free:boolean,start,end}, D:null|{...}, memo:string } */
let drafts = JSON.parse(localStorage.getItem('shift_drafts')||'{}');
function saveDrafts(){ localStorage.setItem('shift_drafts', JSON.stringify(drafts)); }
function setDraftFromPanel(dt){
  const L = lFree.checked ? {free:true} : (lStart.value && lEnd.value ? {free:false,start:lStart.value,end:lEnd.value} : null);
  const D = dFree.checked ? {free:true} : (dStart.value && dEnd.value ? {free:false,start:dStart.value,end:dEnd.value} : null);
  if(!L && !D && !memo.value.trim()){ delete drafts[dt]; } else {
    drafts[dt] = { L, D, memo: memo.value.trim() };
  }
  saveDrafts();
}
function loadPanelFromDraft(dt){
  const d = drafts[dt];
  // åˆæœŸåŒ–
  lFree.checked=false; dFree.checked=false; memo.value='';
  lStart.value='10:00'; lEnd.value='16:00'; dStart.value='17:00'; dEnd.value='24:00';
  if(!d) return;
  if(d.L){ if(d.L.free){ lFree.checked=true; } else { lStart.value=d.L.start; lEnd.value=d.L.end; } }
  if(d.D){ if(d.D.free){ dFree.checked=true; } else { dStart.value=d.D.start; dEnd.value=d.D.end; } }
  memo.value=d.memo||'';
}

/* ====== ã‚µãƒ¼ãƒã®æå‡ºè¡¨ç¤ºï¼ˆå½“æœˆï¼‰ ====== */
async function refreshMarks(){
  const start=`${calYear}-${pad2(calMonth)}-01`;
  const end=new Date(start); end.setMonth(end.getMonth()+1);
  const endStr=end.toISOString().slice(0,10);
  const nm=nameSel.value||'';
  const marks={};
  // ä¸‹æ›¸ã
  Object.keys(drafts).forEach(ds=>{
    const y=+ds.slice(0,4), m=+ds.slice(5,7);
    if(y===calYear && m===calMonth){ marks[ds] ||= {}; marks[ds].draft = true; }
  });
  if(nm){
    const { data } = await supa
      .from('shifts')
      .select('date,start_time,end_time')
      .eq('staff_name', nm)
      .gte('date', start).lt('date', endStr);
    (data||[]).forEach(r=>{
      const v = (!r.start_time || !r.end_time) ? 'â—¯' : `${r.start_time.slice(0,5)}ã€œ${r.end_time.slice(0,5)}`;
      marks[r.date] ||= {};
      marks[r.date].sent ||= [];
      if(!marks[r.date].sent.includes(v)) marks[r.date].sent.push(v);
    });
  }
  renderCalendar(marks);
  // é¸æŠæ—¥ã®ä¸‹æ›¸ãã‚’ãƒ‘ãƒãƒ«ã¸åæ˜ 
  loadPanelFromDraft(dateInp.value);
}

/* ====== 3ãƒœã‚¿ãƒ³ ====== */
// è¿½åŠ /æ›´æ–°ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¸‹æ›¸ãã«ä¿å­˜ï¼‰
$('addUpdateBtn').onclick=()=>{
  msg.textContent='';
  if(!nameSel.disabled) return alert('å…ˆã«ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„');
  const dt=dateInp.value; if(!dt) return alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
  // ã©ã¡ã‚‰ã‹ã«å…¥åŠ› or â—¯ ãŒå¿…è¦ï¼ˆå®Œå…¨ã«ç©ºã¯NGï¼‰
  const something = lFree.checked || dFree.checked ||
                    (lStart.value && lEnd.value) || (dStart.value && dEnd.value) || memo.value.trim();
  if(!something){ return alert('ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ã®æ™‚é–“ã€ã¾ãŸã¯ã€Œâ—¯ã€ã€ã‚ã‚‹ã„ã¯å‚™è€ƒã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); }
  setDraftFromPanel(dt);
  msg.textContent=`${dt} ã‚’ä¸‹æ›¸ãã«ä¿å­˜ã—ã¾ã—ãŸ`; msg.className='msg ok';
  refreshMarks();
};

// é€ä¿¡ï¼ˆãã®æ—¥ã®ä¸‹æ›¸ãã‚’ UPSERTï¼‰
$('sendBtn').onclick=async ()=>{
  msg.textContent=''; msg.className='msg';
  if(!nameSel.disabled) return alert('å…ˆã«ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„');
  const nm=nameSel.value, dt=dateInp.value; if(!dt) return alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
  const d=drafts[dt];
  if(!d || (!d.L && !d.D && !d.memo)){ return alert('ã¾ãšã€Œè¿½åŠ /æ›´æ–°ã€ã§ä¸‹æ›¸ãã«ä¿å­˜ã—ã¦ãã ã•ã„'); }

  // æ—¢å­˜ã‚’å…¨å‰Šé™¤ â†’ ä¸‹æ›¸ãå†…å®¹ã§å†æŒ¿å…¥ï¼ˆå˜æ—¥åˆ†ï¼‰
  const del = await supa.from('shifts').delete().eq('staff_name', nm).eq('date', dt);
  if(del.error){ msg.textContent='å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š'+del.error.message; msg.className='msg err'; return; }

  const rows=[];
  if(d.L){ rows.push({date:dt, staff_name:nm, start_time: d.L.free? null:d.L.start, end_time: d.L.free? null:d.L.end, note:d.memo||''}); }
  if(d.D){ rows.push({date:dt, staff_name:nm, start_time: d.D.free? null:d.D.start, end_time: d.D.free? null:d.D.end, note:d.memo||''}); }
  if(rows.length===0){ /* å‚™è€ƒã ã‘ãªã‚‰ç©ºæŒ¿å…¥ã—ãªã„ */ }

  if(rows.length){
    const ins = await supa.from('shifts').insert(rows);
    if(ins.error){ msg.textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+ins.error.message; msg.className='msg err'; return; }
  }

  msg.textContent=`${dt} ã‚’é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸`; msg.className='msg ok';
  // é€ä¿¡ã—ãŸæ—¥ã®ä¸‹æ›¸ãã¯æ®‹ã—ã¦ã‚‚ã‚ˆã„ãŒã€æ··ä¹±é˜²æ­¢ã§å‰Šé™¤
  delete drafts[dt]; saveDrafts();
  refreshMarks();
};

// å‰Šé™¤ï¼ˆã‚µãƒ¼ãƒæå‡ºã‚‚ä¸‹æ›¸ãã‚‚å…¨æ¶ˆã—ï¼‰
$('deleteBtn').onclick=async ()=>{
  msg.textContent=''; msg.className='msg';
  if(!nameSel.disabled) return alert('å…ˆã«ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„');
  const nm=nameSel.value, dt=dateInp.value; if(!dt) return alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
  if(!confirm(`${dt} ã®ã‚·ãƒ•ãƒˆï¼ˆæå‡ºæ¸ˆã¿ãƒ»ä¸‹æ›¸ãï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  const { error } = await supa.from('shifts').delete().eq('staff_name', nm).eq('date', dt);
  if(error){ msg.textContent='å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š'+error.message; msg.className='msg err'; return; }
  delete drafts[dt]; saveDrafts();
  // ãƒ‘ãƒãƒ«åˆæœŸåŒ–
  lFree.checked=false; dFree.checked=false; memo.value='';
  lStart.value='10:00'; lEnd.value='16:00'; dStart.value='17:00'; dEnd.value='24:00';
  msg.textContent=`${dt} ã‚’å‰Šé™¤ã—ã¾ã—ãŸ âœ”ï¸`; msg.className='msg ok';
  refreshMarks();
});

/* ====== ç”»é¢é·ç§» ====== */
$('toListBtn').onclick=()=>{ location.href=new URL('shiftlink.html', location.href).href; };

/* ====== åˆæœŸåŒ– ====== */
(async function init(){
  setToToday();
  renderCalendar({});
  await loadStaff();
  await refreshMarks();
})();
</script>
</body>
</html>
