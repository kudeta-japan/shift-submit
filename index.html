<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>KU‑DETA シフト提出</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#fafafa; --pri:#111827;
    --ok:#0a8; --err:#d22; --warn:#92400e;
    --cell-bg:#fff; --cell-submitted:#eefbf5; --cell-hover:#f3f4f6; --today:#22c55e;
    --sun:#e11d48; --sat:#2563eb;
    --chip:#f3f4f6; --chip-lunch:#e8f3ff; --chip-din:#f6e8ff; --chip-draft:#fff7cc;
    --chip-bd:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;max-width:1000px;margin:26px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .5rem}
  h2{font-size:1.05rem;margin:18px 0 10px}
  label{display:block;margin:.5rem 0 .25rem;font-weight:600}
  input,select,button,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
  button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
  button:hover{opacity:.92}
  .note{color:var(--muted);font-size:.9rem}
  .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:4px 10px;margin-right:6px}

  /* レイアウト：フォームが上、カレンダーが下 */
  .stack{display:grid;gap:18px}
  .form-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
  .form-flex{display:flex;gap:14px;flex-wrap:wrap}
  .form-flex > *{flex:1 1 220px}

  /* カレンダー */
  .cal{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
  .cal-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .cal-ttl{font-weight:800}
  .ghost{background:#fff;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 12px}
  .legend{display:flex;gap:12px;align-items:center;color:#6b7280;font-size:.85rem;padding:8px 12px;border-bottom:1px solid var(--border)}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid var(--border)}
  .d-sub{background:var(--cell-submitted)} .d-draft{background:var(--chip-draft)} .d-today{border-color:var(--today)}

  .grid{display:grid;grid-template-columns:repeat(7,1fr)}
  .dow{font-weight:700;font-size:.9rem;color:#374151;padding:8px 0;text-align:center;background:#f7f7f7;border-bottom:1px solid var(--border)}
  .cell{min-height:108px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px;position:relative;background:var(--cell-bg);transition:background .15s}
  .cell:hover{background:var(--cell-hover)}
  .cell .head{display:flex;gap:6px;align-items:center}
  .day{font-weight:800}
  .wday{font-size:.75rem;color:#6b7280}
  .sun .day{color:var(--sun)} .sat .day{color:var(--sat)}
  .today{box-shadow:0 0 0 2px var(--today) inset;border-radius:6px}
  .clickable{cursor:pointer}
  .muted{color:#9ca3af}

  .chip{margin-top:4px;font-size:.8rem;color:#374151;background:var(--chip);border:1px solid var(--chip-bd);border-radius:8px;padding:3px 6px;line-height:1.3;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
  .chip.lunch{background:var(--chip-lunch)}
  .chip.din{background:var(--chip-din)}
  .chip.draft{background:var(--chip-draft);border-color:#facc15}
  .selected{outline:2px solid #111827; outline-offset:-2px; border-radius:6px}
</style>
</head>
<body>
  <h1>KU‑DETA シフト提出</h1>
  <p class="note">半月ごとに提出。締切は <b>15日</b> / <b>月末</b>、<b>猶予3日</b>（猶予中は管理者のみ編集可）。時間指定なしは<b>◯</b>で表します。</p>

  <div class="stack">
    <!-- フォーム：上部 -->
    <section class="form-card">
      <div class="form-flex">
        <div>
          <label>あなたの名前（登録済み）</label>
          <select id="nameSel"></select>
          <div id="nameMsg" class="note"></div>
        </div>
        <div>
          <label>新規登録</label>
          <div class="row">
            <input id="newName" placeholder="例：久納 真希" />
            <button id="addBtn">＋ 登録</button>
          </div>
        </div>
        <div>
          <label>ロック</label>
          <button id="lockBtn">✔︎ ロック</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="badge">期間
          <select id="periodSel" style="margin-left:8px"></select>
        </span>
        <span class="badge"><span id="stateBadge">—</span></span>
        <span class="badge">締切：<span id="deadlineTxt">—</span></span>
        <span class="badge"><span id="remainTxt">—</span></span>
      </div>

      <div id="noticeBox" class="note" style="margin-top:6px;"></div>

      <h2 style="margin-top:14px">この日のシフトを登録</h2>
      <form id="shiftForm">
        <div class="form-flex">
          <div>
            <label>日付（カレンダーから選択可）</label>
            <input type="date" id="date" required />
          </div>
          <div>
            <label>区分</label>
            <div class="row">
              <label><input type="radio" name="slot" value="LUNCH" checked> ランチ（10:00–16:00）</label>
              <label><input type="radio" name="slot" value="DINNER"> ディナー（17:00–24:00）</label>
            </div>
          </div>
          <div>
            <label>開始（30分刻み）</label>
            <select id="startSel"></select>
          </div>
          <div>
            <label>終了（30分刻み）</label>
            <select id="endSel"></select>
          </div>
        </div>

        <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input type="checkbox" id="anytimeChk"> 時間指定なし（<b>◯</b>）
        </label>

        <label>備考（任意）</label>
        <textarea id="note" rows="2" placeholder="遅刻・早退・希望など"></textarea>

        <div class="row" style="margin-top:10px">
          <button id="submitBtn" type="submit">📨 送信</button>
          <div id="msg" class="note"></div>
        </div>
      </form>

      <h2 style="margin-top:12px">最新の提出</h2>
      <ul id="list" class="note" style="margin-left:1em"><li>読み込み中…</li></ul>
    </section>

    <!-- カレンダー：下部 -->
    <section class="cal">
      <div class="cal-hd">
        <div class="cal-ttl" id="calTitle">—</div>
        <div>
          <button id="prevMonth" class="ghost">‹ 前月</button>
          <button id="thisMonth" class="ghost">今月</button>
          <button id="nextMonth" class="ghost">次月 ›</button>
        </div>
      </div>
      <div class="legend">
        <span><span class="dot d-sub"></span> 提出済み</span>
        <span><span class="dot d-draft"></span> 送信予定</span>
        <span><span class="dot d-today"></span> 今日</span>
      </div>
      <div class="grid" id="calGrid">
        <div class="dow">日</div><div class="dow">月</div><div class="dow">火</div>
        <div class="dow">水</div><div class="dow">木</div><div class="dow">金</div><div class="dow">土</div>
      </div>
    </section>
  </div>

<script>
/* ====== Supabase（差し替え） ====== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* ================================== */

const $=id=>document.getElementById(id);

/* ===== 期間ユーティリティ ===== */
function fmtYMD(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function labelHalf(y,m,h){ return `${y}年${m}月 ${h==='前半'?'1-15日':'16-月末'}`; }
function deadlineOf(y,m,h){ return (h==='前半') ? new Date(y, m-2, 15) : new Date(y, m-1, 0); }
function graceUntil(d){ const g=new Date(d); g.setDate(g.getDate()+3); return g; }
function nextTwoPeriods(now=new Date()){
  now.setHours(0,0,0,0);
  let y=now.getFullYear(), m=now.getMonth()+1, h=(now.getDate()<=15?'後半':'前半');
  const adv=()=>{ if(h==='前半'){h='後半';} else {h='前半'; m++; if(m===13){m=1;y++;}}};
  const arr=[]; for(let i=0;i<2;){ adv(); const dl=deadlineOf(y,m,h); if(dl>=now){arr.push({y,m,h,dl,gr:graceUntil(dl)}); i++;} }
  return arr;
}

/* ===== 時刻（30分刻み） ===== */
function timesBetween(a,b){ const out=[]; let[h,m]=a.split(':').map(Number); const[eh,em]=b.split(':').map(Number);
  while(h<eh || (h===eh && m<=em)){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); m+=30; if(m===60){m=0;h++;} }
  return out;
}
const SLOT={ LUNCH:{label:'ランチ',start:'10:00',end:'16:00'}, DINNER:{label:'ディナー',start:'17:00',end:'24:00'} };
function setTimeOptions(slot){
  const s=$('startSel'), e=$('endSel'); s.innerHTML=''; e.innerHTML='';
  const xs=timesBetween(SLOT[slot].start,SLOT[slot].end);
  xs.forEach(t=>s.add(new Option(t,t))); xs.forEach(t=>e.add(new Option(t,t)));
  s.value=SLOT[slot].start; e.value=SLOT[slot].end;
}
function setAnytimeUI(on){ $('startSel').disabled=on; $('endSel').disabled=on; }

/* ===== 名前ロード/登録/ロック ===== */
let currentUser=null;
async function loadStaff(selName=null){
  const {data,error}=await supa.from('staff').select('*').eq('include',true).order('name');
  const sel=$('nameSel'); sel.innerHTML='';
  if(error){$('nameMsg').innerHTML='<span class="err">読み込み失敗: '+error.message+'</span>';return;}
  (data||[]).forEach(r=>sel.add(new Option(r.name,r.name)));
  const sv=localStorage.getItem('shiftName');
  if(selName){sel.value=selName;}
  else if(sv && data?.some(d=>d.name===sv)){sel.value=sv;}
  else if(data?.length){sel.value=data[0].name;}
  await updateCurrentUser();
}
async function updateCurrentUser(){
  const nm=$('nameSel').value; if(!nm){currentUser=null;return;}
  const {data}=await supa.from('staff').select('name,is_admin').eq('name',nm).maybeSingle();
  currentUser=data||{name:nm,is_admin:false};
  localStorage.setItem('shiftName',currentUser.name);
  applyPeriodState(); refreshMyMonth();
}
$('nameSel').onchange=updateCurrentUser;

$('addBtn').onclick=async()=>{
  const nm=$('newName').value.trim(); if(!nm){alert('名前を入力');return;}
  const {error}=await supa.from('staff').insert({name:nm});
  if(error){$('nameMsg').innerHTML='<span class="err">'+error.message+'</span>';return;}
  $('newName').value=''; $('nameMsg').innerHTML='<span class="ok">登録しました</span>';
  await loadStaff(nm);
};
$('lockBtn').onclick=()=>{
  const el=$('nameSel'); const on=!el.disabled;
  if(on){ if(!el.value){alert('名前を選択');return;} el.disabled=true; el.style.opacity=.6; $('lockBtn').textContent='🔓 変更'; localStorage.setItem('shiftName',el.value);}
  else{ el.disabled=false; el.style.opacity=1; $('lockBtn').textContent='✔︎ ロック'; localStorage.removeItem('shiftName');}
};

/* ===== 期間 UI ===== */
let periods=nextTwoPeriods();
function buildPeriodSel(){
  const sel=$('periodSel'); sel.innerHTML=''; periods=nextTwoPeriods();
  periods.forEach(p=>sel.add(new Option(labelHalf(p.y,p.m,p.h),`${p.y}-${p.m}-${p.h}`)));
  sel.value=`${periods[0].y}-${periods[0].m}-${periods[0].h}`; applyPeriodState();
}
function curPeriod(){ const[a,b,c]=$('periodSel').value.split('-'); return periods.find(p=>p.y==a&&p.m==b&&p.h==c)||periods[0]; }
function applyPeriodState(){
  const p=curPeriod(), now=new Date(); now.setHours(0,0,0,0);
  const state= now<=p.dl ? '募集中' : (now<=p.gr ? '猶予中（管理者のみ編集可）' : '締切済');
  $('stateBadge').textContent = state + (currentUser?.is_admin && state!=='募集中' ? '：管理者は編集可' : '');
  $('deadlineTxt').textContent = `${p.dl.getFullYear()}年${p.dl.getMonth()+1}月${p.dl.getDate()}日`;
  const diff = Math.ceil(((now<=p.dl?p.dl:p.gr)-now)/86400000);
  $('remainTxt').textContent = now<=p.gr ? `残り ${diff} 日` : '受付終了';
  const canEdit = (now<=p.dl) || (now>p.dl && now<=p.gr && currentUser?.is_admin);
  $('submitBtn').disabled=!canEdit;
  document.querySelectorAll('#shiftForm input,#shiftForm select,#shiftForm textarea').forEach(el=>{ if(el.id!=='date') el.disabled=!canEdit; });

  loadNotice(p.y,p.m,p.h);
  calYear=p.y; calMonth=p.m; rebuildCalendar();
}
$('periodSel').onchange=applyPeriodState;

async function loadNotice(y,m,h){
  const {data}=await supa.from('period_notice').select('message').eq('year',y).eq('month',m).eq('half',h).maybeSingle();
  $('noticeBox').innerHTML = data?.message ? data.message.replace(/\n/g,'<br>') : '（お知らせはありません）';
}

/* ===== カレンダー ===== */
const WDAY=['日','月','火','水','木','金','土'];
let calYear,calMonth;
function monthEnd(){return new Date(calYear,calMonth,0).getDate();}
function parseYMD(s){const[a,b,c]=s.split('-').map(Number);return{y:a,m:b,d:c};}

let myMonthMap=new Map(); // day => [{start_time,end_time,note}]
async function refreshMyMonth(){
  if(!currentUser?.name){myMonthMap=new Map(); rebuildCalendar(); return;}
  const from=fmtYMD(calYear,calMonth,1), to=fmtYMD(calYear,calMonth,monthEnd());
  const {data}=await supa.from('shifts').select('date,start_time,end_time,note').eq('staff_name',currentUser.name).gte('date',from).lte('date',to);
  myMonthMap=new Map();
  (data||[]).forEach(r=>{ const d=Number(r.date.slice(-2)); const arr=myMonthMap.get(d)||[]; arr.push(r); myMonthMap.set(d,arr); });
  rebuildCalendar();
}

function slotOf(start){ return (start<'16:00')?'LUNCH':'DINNER'; }
function chipLabel(rec){
  const isCircle = rec.note && rec.note.trim().startsWith('◯');
  const slot = slotOf(rec.start_time)==='LUNCH'?'ランチ':'ディナー';
  return isCircle ? `${slot}：◯` : `${slot}：${rec.start_time.slice(0,5)}–${rec.end_time.slice(0,5)}`;
}
function chipClass(rec){
  const s = slotOf(rec.start_time);
  return 'chip ' + (s==='LUNCH'?'lunch':'din');
}

function rebuildCalendar(){
  const grid=$('calGrid'); while(grid.children.length>7) grid.removeChild(grid.lastChild);
  $('calTitle').textContent=`${calYear}年 ${calMonth}月`;
  const first=new Date(calYear,calMonth-1,1), last=new Date(calYear,calMonth,0), days=last.getDate(), startDow=first.getDay();
  const today=new Date(); today.setHours(0,0,0,0);
  for(let i=0;i<startDow;i++){ const pad=document.createElement('div'); pad.className='cell muted'; grid.appendChild(pad); }

  const sel=$('date').value;
  for(let d=1; d<=days; d++){
    const dow=new Date(calYear,calMonth-1,d).getDay(), ymd=fmtYMD(calYear,calMonth,d);
    let cls='cell clickable'; if(dow===0)cls+=' sun'; else if(dow===6)cls+=' sat';
    if(sel===ymd) cls+=' selected';
    if(today.getFullYear()===calYear && today.getMonth()+1===calMonth && today.getDate()===d) cls+=' today';

    const div=document.createElement('div'); div.className=cls;
    div.innerHTML=`<div class="head"><span class="day">${d}</span><span class="wday">(${WDAY[dow]})</span></div>`;

    const mine=(myMonthMap.get(d)||[]);
    if(mine.length){
      // ランチ→ディナーの順に並べ、両方チップ表示
      mine.sort((a,b)=>a.start_time.localeCompare(b.start_time));
      mine.slice(0,2).forEach(rec=>{
        const chip=document.createElement('div');
        chip.className=chipClass(rec);
        chip.textContent=chipLabel(rec);
        chip.title = (rec.note||'').replace(/^◯\s*/,'') || chip.textContent;
        div.appendChild(chip);
      });
      if(mine.length>2){
        const more=document.createElement('div'); more.className='chip'; more.textContent=`+${mine.length-2} 件`; div.appendChild(more);
      }
      div.style.background='var(--cell-submitted)';
    }

    div.addEventListener('click', ()=>{
      const was=($('date').value===ymd); $('date').value=ymd;
      rebuildCalendar(); if(was){ $('startSel').focus(); }
      showDraftOnCell(); // 選択ドラフト
    });

    grid.appendChild(div);
  }
  const rem=grid.children.length%7; if(rem){for(let i=0;i<7-rem;i++){const pad=document.createElement('div');pad.className='cell muted';grid.appendChild(pad);}}
  showDraftOnCell();
}

function showDraftOnCell(){
  const s=$('date').value; if(!s) return;
  const {d}=parseYMD(s); const cells=$('calGrid').querySelectorAll('.cell.clickable'); const cell=cells[d-1]; if(!cell) return;
  // 既存ドラフト消す
  Array.from(cell.querySelectorAll('.chip.draft')).forEach(n=>n.remove());
  const slot=document.querySelector('input[name="slot"]:checked').value;
  const any=$('anytimeChk').checked;
  const text = any ? `${SLOT[slot].label}：◯` : `${SLOT[slot].label}：${$('startSel').value}–${$('endSel').value}`;
  const draft=document.createElement('div'); draft.className='chip draft'; draft.textContent=text;
  cell.appendChild(draft);
}

/* ===== 送信 ===== */
document.querySelectorAll('input[name="slot"]').forEach(r=>{
  r.addEventListener('change', ()=>{ setTimeOptions(r.value); setAnytimeUI($('anytimeChk').checked); showDraftOnCell(); });
});
$('anytimeChk').addEventListener('change',e=>{ setAnytimeUI(e.target.checked); showDraftOnCell(); });
$('startSel').addEventListener('change',showDraftOnCell);
$('endSel').addEventListener('change',showDraftOnCell);
$('date').addEventListener('change',()=>{ const {y,m}=parseYMD($('date').value); if(y&&m){calYear=y;calMonth=m;} rebuildCalendar(); });

$('shiftForm').addEventListener('submit', async (ev)=>{
  ev.preventDefault();
  const p=curPeriod(), now=new Date(); now.setHours(0,0,0,0);
  const canEdit=(now<=p.dl) || (now>p.dl && now<=p.gr && currentUser?.is_admin);
  if(!canEdit){ $('msg').innerHTML='<span class="warn">この期間は現在編集できません</span>'; return; }

  const slot=document.querySelector('input[name="slot"]:checked').value;
  const any=$('anytimeChk').checked;
  const start= any ? SLOT[slot].start : $('startSel').value;
  const end  = any ? SLOT[slot].end   : $('endSel').value;
  if(!any && start>=end){ $('msg').innerHTML='<span class="err">開始は終了より前にしてください</span>'; return; }

  const noteUser=$('note').value.trim();
  const note=(any?'◯ ':'') + (noteUser||'');
  const row={ staff_name: currentUser.name, date:$('date').value, start_time:start, end_time:end, note: note||null };

  $('msg').textContent='送信中…';
  const {error}=await supa.from('shifts').insert(row);
  if(error){ $('msg').innerHTML='<span class="err">Error: '+error.message+'</span>'; return; }
  $('msg').innerHTML='<span class="ok">送信しました ✔︎</span>';

  // 反映
  const dd=Number(row.date.slice(-2)); const arr=myMonthMap.get(dd)||[]; arr.push({start_time:row.start_time,end_time:row.end_time,note:row.note}); myMonthMap.set(dd,arr);
  rebuildCalendar(); loadList();
  ev.target.reset();
  document.querySelector('input[name="slot"][value="LUNCH"]').checked=true;
  setTimeOptions('LUNCH'); setAnytimeUI(false);
  $('date').value=row.date; showDraftOnCell();
});

/* ===== 最新10件 ===== */
async function loadList(){
  const {data,error}=await supa.from('shifts').select('*').order('date',{ascending:false}).order('created_at',{ascending:false}).limit(10);
  if(error){ $('list').innerHTML='<li class="err">読み込みエラー</li>'; return; }
  $('list').innerHTML = data.length ? data.map(s=>{
    const isCircle=s.note && s.note.trim().startsWith('◯');
    const slot = (s.start_time<'16:00')?'ランチ':'ディナー';
    return `<li>${s.date} ｜ ${s.staff_name} ｜ ${slot}：${isCircle?'◯':`${s.start_time.slice(0,5)}–${s.end_time.slice(0,5)}`} ${s.note? '（'+s.note.replace(/^◯\s*/,'')+'）':''}</li>`;
  }).join('') : '<li>まだ提出はありません</li>';
}

/* ===== 初期化 ===== */
(async ()=>{
  buildPeriodSel();
  const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1;
  $('date').value=fmtYMD(t.getFullYear(), t.getMonth()+1, t.getDate());
  setTimeOptions('LUNCH'); setAnytimeUI(false);
  await loadStaff(); await refreshMyMonth(); await loadList();
})();
$('prevMonth').onclick=()=>{calMonth--; if(calMonth===0){calMonth=12;calYear--;} rebuildCalendar();};
$('nextMonth').onclick=()=>{calMonth++; if(calMonth===13){calMonth=1;calYear++;} rebuildCalendar();};
$('thisMonth').onclick=()=>{const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1; rebuildCalendar();};
</script>
</body>
</html>
