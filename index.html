<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{--fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#fafafa;--card:#fff;--ok:#16a34a;--err:#b91c1c}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:#111827;color:#fff;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:#111827}
  .note{color:var(--muted);font-size:.92rem}
  .msg{margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .right{margin-left:auto}
  .sec-title{font-weight:700;margin:.25rem 0}
  /* ç°¡æ˜“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆæ—¢å­˜ã®æœ¬æ ¼ç‰ˆãŒã‚ã‚Œã°ç½®ãæ›ãˆã¦OKï¼‰ */
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-weight:700;text-align:center;color:#374151}
  .cell{border:1px solid var(--bd);border-radius:10px;min-height:70px;background:#fff;padding:6px;position:relative;cursor:pointer}
  .day{position:absolute;top:6px;left:8px;font-weight:700;font-size:.9rem;color:#4b5563}
  .selected{outline:2px solid #111827}
</style>
</head>
<body>
<h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

<!-- ä¸Šéƒ¨ï¼šåå‰ãƒ­ãƒƒã‚¯ & æœŸé–“ -->
<div class="card">
  <div class="row">
    <strong>ã‚ãªãŸã®åå‰</strong>
    <select id="nameSel" style="min-width:220px"></select>
    <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
    <span id="lockState" class="note"></span>
    <button id="toAdmin" class="ghost right">âš™ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã¸</button>
  </div>
  <p class="note" style="margin-top:6px">â€» ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¯ <code>display_order</code> â†’ åå‰ ã®é †ã§ä¸¦ã³ã¾ã™ã€‚<br>
  â€» <code>include=false</code> ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ã€‚</p>
</div>

<!-- å…¥åŠ›ï¼ˆè¶…ç°¡æ˜“ç‰ˆï¼‰ -->
<div class="card">
  <div class="sec-title">ã“ã®æ—¥ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²</div>
  <div class="row">
    <label>æ—¥ä»˜ï¼š<input type="date" id="dateInp"></label>
    <label>é–‹å§‹ï¼š<input type="time" id="startInp"></label>
    <label>çµ‚äº†ï¼š<input type="time" id="endInp"></label>
    <label class="note"><input type="checkbox" id="freeChk"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
    <button id="sendBtn">ğŸ“¨ é€ä¿¡</button>
  </div>
  <div class="row" style="margin-top:8px;width:100%">
    <label style="flex:1">å‚™è€ƒï¼ˆä»»æ„ï¼‰<textarea id="memo" rows="2" style="width:100%"></textarea></label>
  </div>
  <div id="msg" class="msg"></div>
</div>

<!-- ç°¡æ˜“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="card">
  <div class="row note" style="margin-bottom:8px">
    <span id="ymLabel"></span>
    <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
    <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
    <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
    <button id="toList" class="ghost right">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
  </div>
  <div id="cal" class="grid"></div>
</div>

<script>
/* ===== Supabase æ¥ç¶šï¼ˆã‚ãªãŸã®URL/Anon Keyã«å·®ã—æ›¿ãˆä¸è¦ãªã‚‰ã“ã®ã¾ã¾ï¼‰ ===== */
const SUPABASE_URL  = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_KEY  = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

/* ===== è¦ç´  ===== */
const $ = id => document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateInp=$('dateInp'), startInp=$('startInp'), endInp=$('endInp'), freeChk=$('freeChk'), memo=$('memo');
const msg=$('msg');

/* ===== ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’ã€Œdisplay_order ASC â†’ name ASCã€ã§å–å¾—ï¼ˆinclude=trueã®ã¿ï¼‰ ===== */
async function loadStaff(){
  const { data, error } = await supa
    .from('staff')
    .select('name, include, display_order')
    .eq('include', true)
    .order('display_order', { ascending: true })
    .order('name', { ascending: true });

  if(error){ toast('ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š'+error.message, true); return; }

  nameSel.innerHTML='';
  (data||[]).forEach(r => nameSel.add(new Option(r.name, r.name)));

  // ãƒ­ãƒƒã‚¯å¾©å…ƒ
  const sv = localStorage.getItem('shift_name');
  if(sv && Array.from(nameSel.options).some(o=>o.value===sv)){
    nameSel.value = sv; setLock(true);
  }else{
    setLock(false);
  }
}

/* ===== åå‰ãƒ­ãƒƒã‚¯ ===== */
function setLock(on){
  nameSel.disabled=on;
  lockBtn.textContent = on ? 'ğŸ”“ å¤‰æ›´' : 'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent = on ? `ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}` : 'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick = ()=>{
  const on = nameSel.disabled;
  if(on){ localStorage.removeItem('shift_name'); setLock(false); }
  else{
    if(!nameSel.value){ alert('åå‰ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    localStorage.setItem('shift_name', nameSel.value);
    setLock(true);
  }
};

/* ===== é€ä¿¡ï¼ˆæœ€å°æ§‹æˆï¼‰===== */
$('sendBtn').onclick = async ()=>{
  clearMsg();
  const staff = nameSel.value;
  if(!staff || !nameSel.disabled){ alert('åå‰ã‚’é¸ã‚“ã§ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  const dt = dateInp.value;
  if(!dt){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }

  let start = startInp.value || null;
  let end   = endInp.value   || null;
  if(freeChk.checked){ start = null; end = null; }

  const rows = [{ date: dt, staff_name: staff, start_time: start, end_time: end, note: memo.value||'' }];

  const { error } = await supa.from('shifts').insert(rows);
  if(error){ toast('é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+error.message, true); return; }

  toast('é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸');
  memo.value=''; freeChk.checked=false;
  renderCalendar(); // ãƒãƒ¼ã‚«ãƒ¼å†æç”»ï¼ˆç°¡æ˜“ç‰ˆï¼‰
};

/* ===== ç°¡æ˜“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆåŒæœˆåˆ†ã‚’è‰²ä»˜ã‘ï¼‰===== */
let cy, cm;
function pad2(n){return String(n).padStart(2,'0');}
function setToday(){
  const t = new Date(); t.setHours(0,0,0,0);
  cy=t.getFullYear(); cm=t.getMonth()+1;
  if(!dateInp.value) dateInp.value = `${cy}-${pad2(cm)}-${pad2(t.getDate())}`;
}
$('prevBtn').onclick=()=>{ cm--; if(cm===0){cm=12;cy--;} renderCalendar(); };
$('nextBtn').onclick=()=>{ cm++; if(cm===13){cm=1;cy++;} renderCalendar(); };
$('thisBtn').onclick=()=>{ setToday(); renderCalendar(); };
$('toList').onclick=()=> location.href = 'shiftlink.html';
$('toAdmin').onclick=()=> location.href = 'admin.html';

async function renderCalendar(){
  $('ymLabel').textContent = `${cy}å¹´${cm}æœˆ`;
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{
    const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d);
  });

  const first = new Date(cy, cm-1, 1);
  for(let i=0;i<first.getDay();i++){ cal.appendChild(document.createElement('div')).className='cell'; }
  const days = new Date(cy, cm, 0).getDate();

  // å½“æœˆï¼‹é¸æŠãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æå‡ºï¼ˆãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ã®åŒºåˆ¥ã¯çœç•¥ãƒ»â—¯/æ™‚åˆ»ã®è¡¨ç¤ºã®ã¿ï¼‰
  let markers = {};
  const staff = nameSel.value || '';
  if(staff){
    const start = `${cy}-${pad2(cm)}-01`;
    const end   = new Date(start); end.setMonth(end.getMonth()+1);
    const { data } = await supa.from('shifts')
      .select('date,start_time,end_time,staff_name')
      .eq('staff_name', staff).gte('date', start).lt('date', end.toISOString().slice(0,10));
    (data||[]).forEach(r=>{
      const d = +r.date.slice(-2);
      const v = (!r.start_time || !r.end_time) ? 'â—¯' : `${r.start_time}ã€œ${r.end_time}`;
      (markers[d] ||= []).push(v);
    });
  }

  for(let d=1; d<=days; d++){
    const cell=document.createElement('div'); cell.className='cell';
    const ds = `${cy}-${pad2(cm)}-${pad2(d)}`;
    const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
    cell.onclick=()=>{ dateInp.value=ds; document.querySelectorAll('.cell').forEach(c=>c.classList.remove('selected')); cell.classList.add('selected'); };
    if(markers[d]){
      const wrap=document.createElement('div'); wrap.style.cssText='position:absolute;left:6px;right:6px;bottom:6px;display:flex;flex-direction:column;gap:2px;font-size:.85rem';
      markers[d].slice(0,3).forEach(t=>{
        const tag=document.createElement('div'); tag.textContent=t; tag.style.cssText='border:1px solid var(--bd);border-radius:6px;padding:1px 6px;background:#f8fafc;';
        wrap.appendChild(tag);
      });
      cell.appendChild(wrap);
    }
    cal.appendChild(cell);
  }
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function toast(t, isErr=false){ msg.textContent=t; msg.className='msg '+(isErr?'err':'ok'); }
function clearMsg(){ msg.textContent=''; msg.className='msg'; }

/* ===== init ===== */
(async function init(){
  setToday();
  await loadStaff();
  renderCalendar();
})();
</script>
</body>
</html>
