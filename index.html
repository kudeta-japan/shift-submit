<!DOCTYPE html><html lang="ja">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡ºï¼ˆSupabaseç‰ˆï¼‰</title>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<style>
:root{--c-main:#111827;--c-accent:#f59e0b;--c-gray:#6b7280;--c-border:#e5e7eb;--r:10px}
*{box-sizing:border-box;margin:0}
body{font-family:'Segoe UI',Roboto,'Helvetica Neue',sans-serif;background:#fafafa;color:var(--c-main);max-width:820px;padding:24px;margin:auto}
h2{font-size:1.6rem;font-weight:700;margin-bottom:22px}
label{display:block;margin-top:18px;font-weight:600;font-size:.95rem}
select,input,textarea{width:100%;max-width:360px;padding:10px;margin-top:6px;border:1px solid var(--c-border);
border-radius:var(--r);font-size:.95rem}textarea{resize:vertical}
fieldset{border:1px solid var(--c-border);border-radius:var(--r);padding:14px;margin-top:22px;background:#fff;
         box-shadow:0 2px 4px rgba(0,0,0,.05)}
legend{padding:0 8px;font-weight:700;color:var(--c-gray)}
table{width:100%;border-collapse:collapse;margin-top:8px}
td{border:1px solid var(--c-border);padding:4px 6px;font-size:.8rem;text-align:center;min-width:60px;background:#fdfdfd}
td:nth-child(5n){background:#f9fafb}
button{display:inline-flex;align-items:center;gap:6px;padding:10px 20px;margin-top:22px;border:none;border-radius:var(--r);
       background:var(--c-main);color:#fff;font-weight:600;font-size:.9rem;cursor:pointer;transition:.15s}
button:hover{opacity:.9}button:disabled{opacity:.45;cursor:not-allowed}
#lockBtn{margin-left:8px;padding:9px 18px;font-size:.85rem}
.notice{margin-top:14px;padding:10px;background:#fefbe8;border-left:4px solid var(--c-accent);border-radius:var(--r);font-size:.88rem}
.info{margin-top:6px;font-size:.85rem;color:var(--c-gray)}
.dis{background:#f3f4f6!important;color:var(--c-gray)!important}
#msg{margin-top:16px;font-weight:600}
.offAll{display:flex;align-items:center;gap:8px;font-weight:500;margin-top:24px}
.offAll input{transform:scale(1.2)}
.nav a{display:inline-block;text-decoration:none;font-weight:600;border-radius:10px;padding:10px 20px;margin-top:22px}
.nav a.list{background:#111827;color:#fff;border:none}
.nav a.admin{background:#fff;color:#111827;border:1px solid #e5e7eb;margin-left:12px}
.small{font-size:.8rem;color:#6b7280;margin-top:10px}
</style>
</head>
<body>
<h2>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h2>

<label>è¡¨ç¤º/å›ç­”æœŸé–“ï¼ˆæ¬¡ã®åŠæœˆã‹ã‚‰ 3 ä»¶ + ç›´è¿‘åŠæœˆï¼‰<select id="period"></select></label>
<p id="deadline" class="info"></p>
<p id="noticeBox" class="notice"></p>

<label>ã‚ãªãŸã®åå‰
  <input id="nameInp" placeholder="åå‰ã‚’å…¥åŠ›">
  <button id="lockBtn">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
</label>
<p class="info">â€» å‡ºå‹¤æ™‚é–“ã«<strong>å¸Œæœ›ãŒã‚ã‚‹æ—¥ã ã‘</strong>ã€ä¸‹ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã§æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆé€£ç¶š2hä»¥ä¸Šï¼‰</p>

<fieldset><legend>ãƒ©ãƒ³ãƒ 10:00-15:00</legend><table id="tblL"></table></fieldset>
<fieldset><legend>ãƒ‡ã‚£ãƒŠãƒ¼ 17:30-23:00</legend><table id="tblD"></table></fieldset>

<label class="offAll"><input type="checkbox" id="offAll"> ä»Šå›ã¯å‡ºå‹¤å¸Œæœ›æ—¥ãŒã‚ã‚Šã¾ã›ã‚“</label>

<label>å‚™è€ƒ<textarea id="memo" rows="3" placeholder="é€£çµ¡äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›ï¼ˆå…¨ä¼‘ãƒã‚§ãƒƒã‚¯æ™‚ã¯ã“ã“ã«ã€ã€å…¨ä¼‘å¸Œæœ›ã€‘ã€ãŒè‡ªå‹•ä»˜ä¸ï¼‰"></textarea></label>
<button id="sendBtn">ğŸ“¨ é€ä¿¡</button><p id="msg"></p>

<div class="nav">
  <a class="list"  href="./shiftlist.html">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</a>
  <a class="admin" href="./admin.html">ç®¡ç†ãƒšãƒ¼ã‚¸ã¸</a>
</div>
<div class="small">ç¾åœ¨URLï¼š<span id="curUrl"></span></div>

<script>
/** === å¿…è¦æƒ…å ±ï¼šè‡ªåˆ†ã® Supabase æƒ…å ±ã«ç½®æ›ã—ã¦ãã ã•ã„ === */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";

/** === ä»¥é™ãã®ã¾ã¾ã§OK === */
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const $=id=>document.getElementById(id);
$('curUrl').textContent = location.href;

const periodSel=$('period'),notice=$('noticeBox'),
      nameInp=$('nameInp'),lockBtn=$('lockBtn'),
      memo=$('memo'),msg=$('msg'),tblL=$('tblL'),tblD=$('tblD'),offChk=$('offAll');

function deadlineText(y,m,h){
  const d = (h==='å‰åŠ') ? new Date(y,m-2,15) : new Date(y,m-1,0);
  const d3 = new Date(d.getTime()); d3.setDate(d3.getDate()+3);
  const fmt = (dt)=>`${dt.getFullYear()}å¹´${dt.getMonth()+1}æœˆ${dt.getDate()}æ—¥`;
  return `æå‡ºæœŸé™ï¼š${fmt(d)}ï¼ˆè¡¨ç¤ºã¯+3æ—¥ï¼š${fmt(d3)} ã¾ã§ï¼‰`;
}

/* æœŸé–“ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆç›´è¿‘åŠæœŸã‚’+3æ—¥ã¾ã§å«ã‚ã€ä»¥å¾Œ3ä»¶ï¼‰ */
(function buildPeriods(){
  const t = new Date(); t.setHours(0,0,0,0);
  const lbl = {'å‰åŠ':'1-15æ—¥','å¾ŒåŠ':'16-æœˆæœ«'};
  let y=t.getFullYear(), m=t.getMonth()+1, h=t.getDate()<=15?'å‰åŠ':'å¾ŒåŠ';
  const rawDeadline=(Y,M,H)=>(H==='å‰åŠ')?new Date(Y,M-2,15):new Date(Y,M-1,0);
  const showUntil=(Y,M,H)=>{const d=rawDeadline(Y,M,H); d.setDate(d.getDate()+3); return d;};
  // ç›´è¿‘åŠæœŸï¼ˆéãã¦ã„ãªã‘ã‚Œã°å…¥ã‚Œã‚‹ï¼‰
  let py=y, pm=m, ph=(h==='å‰åŠ'?'å¾ŒåŠ':'å‰åŠ'); if(h==='å‰åŠ'){ pm--; if(pm===0){pm=12;py--;}}
  const list=[];
  if(showUntil(py,pm,ph) >= t) list.push([py,pm,ph]);
  // æ¬¡ã®åŠæœŸã‹ã‚‰3ä»¶
  let cy=y, cm=m, ch=(h==='å‰åŠ'?'å¾ŒåŠ':'å‰åŠ'); if(h==='å¾ŒåŠ'){ cm++; if(cm===13){cm=1;cy++;}}
  for(let i=0;i<3;){
    if(showUntil(cy,cm,ch) >= t){ list.push([cy,cm,ch]); i++; }
    if(ch==='å‰åŠ'){ ch='å¾ŒåŠ'; } else { ch='å‰åŠ'; cm++; if(cm===13){cm=1;cy++;} }
  }
  list.forEach(([Y,M,H])=>periodSel.add(new Option(`${Y}å¹´${M}æœˆ ${lbl[H]}`, `${Y}-${M}-${H}`)));
  const [Y,M,H] = periodSel.value.split('-').map((v,i)=> i<2?+v:v);
  $('deadline').textContent = deadlineText(+Y,+M,H);
  loadNotice(+Y,+M,H);
})();
periodSel.onchange = ()=> {
  const [y,m,h] = periodSel.value.split('-'); $('deadline').textContent = deadlineText(+y,+m,h);
  loadNotice(+y,+m,h);
};

async function loadNotice(y,m,h){
  const { data: p } = await client.from('periods').select().eq('year',y).eq('month',m).eq('half',h).maybeSingle();
  if(!p){ notice.textContent='ï¼ˆãŠçŸ¥ã‚‰ã›ç„¡ã—ï¼‰'; return; }
  const { data: n } = await client.from('notices').select('message').eq('period_id',p.id).maybeSingle();
  notice.textContent = (n && n.message) ? n.message : 'ï¼ˆãŠçŸ¥ã‚‰ã›ç„¡ã—ï¼‰';
}

/* æ™‚åˆ»é¸æŠè‚¢ï¼ˆ2hä»¥ä¸Šã ã‘ï¼‰ */
function genOptions(hStart,mStart,hEnd,mEnd,minMin=120){
  const pad=n=>('0'+n).slice(-2),toMin=(h,m)=>h*60+m,list=['','â—¯'];
  const times=[];for(let h=hStart,m=mStart;;){times.push(`${pad(h)}:${pad(m)}`);if(h===hEnd&&m===mEnd)break;m+=30;if(m===60){m=0;h++;}}
  times.forEach(t=>{const [h,m]=t.split(':').map(Number);if(toMin(hEnd,mEnd)-toMin(h,m)>=minMin)list.push(`${t}ã€œ`);});
  times.forEach(t=>{const [h,m]=t.split(':').map(Number);if(toMin(h,m)-toMin(hStart,mStart)>=minMin)list.push(`ã€œ${t}`);});
  times.forEach((s,i)=>{const [sh,sm]=s.split(':').map(Number);times.slice(i+1).forEach(e=>{const [eh,em]=e.split(':').map(Number);if(toMin(eh,em)-toMin(sh,sm)>=minMin)list.push(`${s}ã€œ${e}`);});});
  return list;
}
const TL=genOptions(10,0,15,0), TD=genOptions(17,30,23,0);

/* ãƒ†ãƒ¼ãƒ–ãƒ«UI */
function build(tbl,prefix,start,len,list){
  let html='<tr>';
  for(let i=0;i<len;i++){
    if(i%5===0&&i)html+='</tr><tr>';
    const d=start+i;
    html+=`<td>${d}<br><select id="${prefix}${d}">`;
    list.forEach(t=>html+=`<option value="${t}">${t}</option>`); html+='</select></td>';
  }
  tbl.innerHTML=html+'</tr>';
}
function rebuildTables(){
  const [ , , h ] = periodSel.value.split('-');
  const start = (h==='å‰åŠ')?1:16, len=(h==='å‰åŠ')?15:16;
  build(tblL,'L',start,len,TL);
  build(tblD,'D',start,len,TD);
}
rebuildTables();
periodSel.addEventListener('change', rebuildTables);

/* åå‰ãƒ­ãƒƒã‚¯ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰ */
lockBtn.onclick = ()=>{
  const on = !nameInp.disabled;
  if(on){ if(!nameInp.value.trim()){alert('åå‰ã‚’å…¥åŠ›');return;}
    nameInp.disabled=true; nameInp.classList.add('dis'); lockBtn.textContent='ğŸ”“ å¤‰æ›´';
    localStorage.setItem('shiftName', nameInp.value.trim());
  }else{
    nameInp.disabled=false; nameInp.classList.remove('dis'); lockBtn.textContent='âœ”ï¸ ãƒ­ãƒƒã‚¯';
    localStorage.removeItem('shiftName');
  }
};
(function initName(){
  const sv = localStorage.getItem('shiftName');
  if(sv){ nameInp.value=sv; nameInp.disabled=true; nameInp.classList.add('dis'); lockBtn.textContent='ğŸ”“ å¤‰æ›´'; }
})();

/* é€ä¿¡ */
$('sendBtn').onclick = async ()=>{
  const name = nameInp.value.trim();
  if(!name){ alert('åå‰ã‚’å…¥åŠ›'); return; }
  const [y,m,h] = periodSel.value.split('-'); const Y=+y,M=+m,H=h;

  msg.textContent='é€ä¿¡ä¸­â€¦';

  // æœŸé–“ã‚’ upsert
  const { data: period, error: perr } = await client.from('periods')
    .upsert({ year:Y, month:M, half:H }, { onConflict:'year,month,half' })
    .select().single();
  if(perr){ msg.textContent='Error: '+perr.message; return; }

  // ã‚¹ã‚¿ãƒƒãƒ• upsert
  let { data: st } = await client.from('staff').select().eq('name',name).maybeSingle();
  if(!st){
    const add = await client.from('staff').insert({ name }).select().single();
    if(add.error){ msg.textContent='Error: '+add.error.message; return; }
    st = add.data;
  }
  if(st.include === false){ msg.textContent='ç™»éŒ²ä¸å¯ï¼šã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯ç¾åœ¨é™¤å¤–è¨­å®šã§ã™'; return; }

  // å…¥åŠ›åé›†
  const start = (H==='å‰åŠ')?1:16, len=(H==='å‰åŠ')?15:16;
  const L={}, D={};
  if(!offChk.checked){
    for(let i=0;i<len;i++){
      const d=start+i, vL=$('L'+d).value, vD=$('D'+d).value;
      if(vL) L[d]=vL; if(vD) D[d]=vD;
    }
    if(!Object.keys(L).length && !Object.keys(D).length){
      alert('1 ã¤é¸ã¶ã‹ã€Œå‡ºå‹¤å¸Œæœ›ãªã—ã€ã«ãƒã‚§ãƒƒã‚¯'); msg.textContent=''; return;
    }
  }
  // æ—¢å­˜è‡ªåˆ†ã®è¡Œã‚’ã‚¯ãƒªãƒ¼ãƒ³ï¼ˆã“ã®åŠæœŸåˆ†ï¼‰
  await client.from('shifts').delete()
    .eq('staff_id', st.id).eq('period_id', period.id);

  // ã¾ã¨ã‚ã¦INSERT
  const rows=[];
  const pushRows=(obj,type)=>Object.entries(obj).forEach(([day,val])=>{
    rows.push({ staff_id:st.id, period_id:period.id, type, day:+day, value:val });
  });
  if(offChk.checked){
    rows.push({ staff_id:st.id, period_id:period.id, type:'LUNCH', day:start, value:'ã€å…¨ä¼‘å¸Œæœ›ã€‘ '+(memo.value||'') });
  }else{
    pushRows(L,'LUNCH'); pushRows(D,'DINNER');
    if(memo.value) rows.push({ staff_id:st.id, period_id:period.id, type:'LUNCH', day:start, value:'[å‚™è€ƒ] '+memo.value });
  }
  if(rows.length){
    const { error } = await client.from('shifts').insert(rows);
    if(error){ msg.textContent='Error: '+error.message; return; }
  }
  msg.textContent='ç™»éŒ²ã—ã¾ã—ãŸ âœ”ï¸';
  // ãƒªã‚»ãƒƒãƒˆ
  document.querySelectorAll('select[id^=L],select[id^=D]').forEach(s=>s.value='');
  memo.value=''; offChk.checked=false;
};
</script>
</body></html>
