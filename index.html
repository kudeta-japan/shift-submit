<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KUâ€‘DETA ã‚·ãƒ•ãƒˆæå‡º</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#fafafa; --pri:#111827;
      --ok:#0a8; --err:#d22; --warn:#92400e;
      --cell-bg:#ffffff; --cell-submitted:#e6f7ee; --cell-hover:#f3f4f6; --today-ring:#22c55e;
      --sun:#e11d48; --sat:#2563eb; --draft:#fff7cc; --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;max-width:1000px;margin:32px auto;padding:0 16px;background:var(--bg);color:var(--fg)}
    h1{font-size:1.6rem;margin:0 0 .5rem}
    h2{font-size:1.1rem;margin:20px 0 8px}
    label{display:block;margin:.6rem 0 .2rem;font-weight:600}
    input,select,button,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
    button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
    button:hover{opacity:.92}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .note{color:var(--muted);font-size:.9rem;margin-top:.35rem}
    .ok{color:var(--ok)} .err{color:var(--err)} .warn{color:var(--warn)}
    .badge{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:4px 10px;border:1px solid var(--border);background:#fff}
    .period-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:14px}
    .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){ .two-col{grid-template-columns:1fr} }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal-wrap{margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .cal-title{font-weight:800}
    .cal-actions{display:flex;gap:8px}
    .ghost{background:#fff;color:var(--fg);border:1px solid var(--border)}
    .legend{display:flex;gap:12px;align-items:center;color:#6b7280;font-size:.85rem}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid var(--border)}
    .lg-submitted{background:var(--cell-submitted)}
    .lg-draft{background:var(--draft);border-color:#facc15}
    .lg-today{border-color:var(--today-ring)}
    .lg-selected{background:#eef2ff;border-color:#c7d2fe}

    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .dow{font-weight:700;font-size:.9rem;color:#374151;padding:8px 0;text-align:center;background:#f7f7f7;border-bottom:1px solid var(--border)}
    .cell{min-height:88px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px;position:relative;background:var(--cell-bg);transition:background-color .15s ease}
    .cell:hover{background:var(--cell-hover)} .cell:last-child{border-right:0}
    .cell .top{display:flex;gap:6px;align-items:center}
    .cell .day{font-weight:800;font-size:1rem}
    .cell .wday{font-size:.75rem;color:#6b7280}
    .sun .day{color:#e11d48} .sat .day{color:#2563eb}
    .clickable{cursor:pointer} .muted{color:#9ca3af}
    .selected{outline:2px solid #111827; outline-offset:-2px; border-radius:6px}
    .today-ring{box-shadow:0 0 0 2px var(--today-ring) inset;border-radius:6px}
    .has-shift{background:var(--cell-submitted)}
    .draft{background:var(--draft)}
    .pill{position:absolute;bottom:6px;left:6px;right:6px;font-size:.78rem;color:#374151;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:4px 6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .flash{animation:flash 900ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(34,197,94,.0)}40%{box-shadow:0 0 0 6px rgba(34,197,94,.35)}100%{box-shadow:0 0 0 0 rgba(34,197,94,.0)}}
  </style>
</head>
<body>
  <h1>KUâ€‘DETA ã‚·ãƒ•ãƒˆæå‡º</h1>
  <p class="note">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯æ¯æœˆ <b>15æ—¥</b> / <b>æœˆæœ«</b>ã€<b>çŒ¶äºˆ3æ—¥</b>ï¼ˆçŒ¶äºˆä¸­ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚</p>

  <!-- åå‰é¸æŠ + æ–°è¦ç™»éŒ² + ãƒ­ãƒƒã‚¯ -->
  <div class="row">
    <div style="flex:1;min-width:260px">
      <label>ã‚ãªãŸã®åå‰ï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰</label>
      <select id="nameSel"></select>
      <div id="nameMsg" class="note"></div>
    </div>
    <div class="row" style="gap:6px">
      <div>
        <label>æ–°è¦ç™»éŒ²</label>
        <input id="newName" placeholder="ä¾‹ï¼šä¹…ç´ çœŸå¸Œ" />
      </div>
      <button id="addBtn">ï¼‹ ç™»éŒ²</button>
    </div>
    <div>
      <label>ãƒ­ãƒƒã‚¯</label>
      <button id="lockBtn">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
    </div>
  </div>

  <!-- æœŸé–“ï¼ˆå¸¸ã«ä»Šå¾Œ2æœŸé–“ï¼‰ -->
  <div class="period-bar">
    <label>æœŸé–“</label>
    <select id="periodSel"></select>
    <span class="badge"><span id="stateBadge">â€”</span></span>
    <span class="badge">ç· åˆ‡ï¼š<span id="deadlineTxt">â€”</span></span>
    <span class="badge"><span id="remainTxt">â€”</span></span>
  </div>
  <div id="noticeBox" class="note" style="margin-top:6px;"></div>

  <div class="two-col">
    <!-- å·¦ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <section>
      <div class="cal-wrap">
        <div class="cal-head">
          <div class="cal-title" id="calTitle">â€”</div>
          <div class="cal-actions">
            <button id="prevMonth" class="ghost" title="å‰ã®æœˆ">â€¹ å‰æœˆ</button>
            <button id="thisMonth" class="ghost" title="ä»Šæœˆ">ä»Šæœˆ</button>
            <button id="nextMonth" class="ghost" title="æ¬¡ã®æœˆ">æ¬¡æœˆ â€º</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)">
          <div class="legend">
            <span><span class="dot lg-submitted"></span> æå‡ºæ¸ˆã¿</span>
            <span><span class="dot lg-draft"></span> é€ä¿¡äºˆå®š</span>
            <span><span class="dot lg-today"></span> ä»Šæ—¥</span>
            <span><span class="dot lg-selected"></span> é¸æŠä¸­</span>
          </div>
          <div class="note">å³ã®æ™‚é–“æŒ‡å®šã‚’å…¥ã‚Œã‚‹ã¨ã€Œé€ä¿¡äºˆå®šã€ã«è‰²ã¥ãã¾ã™ã€‚<b>â—¯</b>ã¯æ™‚é–“æŒ‡å®šãªã—ã€‚</div>
        </div>
        <div class="cal-grid" id="calGrid">
          <div class="dow">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div>
          <div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow">åœŸ</div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆ30åˆ†åˆ»ã¿ / ãƒ©ãƒ³ãƒ or ãƒ‡ã‚£ãƒŠãƒ¼ / â—¯å¯¾å¿œï¼‰ -->
    <section>
      <h2>ã“ã®æ—¥ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²</h2>
      <form id="shiftForm">
        <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠå¯ï¼‰</label>
        <input type="date" id="date" required />

        <label>åŒºåˆ†</label>
        <div class="row">
          <label><input type="radio" name="slot" value="LUNCH" checked> ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</label>
          <label><input type="radio" name="slot" value="DINNER"> ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“24:00ï¼‰</label>
        </div>

        <div class="row" id="timeRow">
          <div style="flex:1;min-width:160px">
            <label>é–‹å§‹ï¼ˆ30åˆ†åˆ»ã¿ï¼‰</label>
            <select id="startSel"></select>
          </div>
          <div style="flex:1;min-width:160px">
            <label>çµ‚äº†ï¼ˆ30åˆ†åˆ»ã¿ï¼‰</label>
            <select id="endSel"></select>
          </div>
        </div>

        <label style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input type="checkbox" id="anytimeChk"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆ<b>â—¯</b>ï¼‰
        </label>

        <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
        <textarea id="note" rows="2" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>

        <button id="submitBtn" type="submit" style="margin-top:12px">ğŸ“¨ é€ä¿¡</button>
        <div id="msg" class="note"></div>
      </form>

      <h2>æœ€æ–°ã®æå‡º</h2>
      <ul id="list"><li>èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
    </section>
  </div>

  <script>
    // ====== Supabaseï¼ˆè‡ªåˆ†ã®å€¤ã«ç½®æ›ï¼‰ ======
    const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
    // =========================================
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);

    // ===== åŠæœˆæœŸé–“ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
    function fmtYMD(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
    function labelHalf(y,m,h){ return `${y}å¹´${m}æœˆ ${h==='å‰åŠ'?'1-15æ—¥':'16-æœˆæœ«'}`; }
    function calcDeadline(y,m,h){ return (h==='å‰åŠ') ? new Date(y, m-2, 15) : new Date(y, m-1, 0); }
    function graceUntil(deadline){ const g=new Date(deadline); g.setDate(g.getDate()+3); return g; }

    // ===== æœŸé–“ï¼ˆä»Šå¾Œ2æœŸé–“ï¼‰ =====
    function nextTwoPeriods(now=new Date()){
      now.setHours(0,0,0,0);
      let y=now.getFullYear(), m=now.getMonth()+1, h=(now.getDate()<=15?'å¾ŒåŠ':'å‰åŠ');
      const adv=()=>{ if(h==='å‰åŠ'){ h='å¾ŒåŠ'; } else { h='å‰åŠ'; m++; if(m===13){ m=1; y++; } } };
      const arr=[];
      for(let i=0;i<2;){ adv(); const dl=calcDeadline(y,m,h); if(dl>=now){ arr.push({y,m,h,dl,grace:graceUntil(dl)}); i++; } }
      return arr;
    }

    // ===== æ™‚åˆ»ç”Ÿæˆï¼ˆ30åˆ†åˆ»ã¿ï¼‰ =====
    function timesBetween(start, end){
      const out=[]; let [h,m]=start.split(':').map(Number); const [eh,em]=end.split(':').map(Number);
      while(h<eh || (h===eh && m<=em)){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); m+=30; if(m===60){m=0; h++;} }
      return out;
    }
    const SLOT = {
      LUNCH:  {label:'ãƒ©ãƒ³ãƒ',  start:'10:00', end:'16:00'},
      DINNER: {label:'ãƒ‡ã‚£ãƒŠãƒ¼',start:'17:00', end:'24:00'}
    };
    function buildTimeSelects(slot){
      const s=$('startSel'), e=$('endSel'); s.innerHTML=''; e.innerHTML='';
      const list = timesBetween(SLOT[slot].start, SLOT[slot].end);
      list.forEach(t=> s.add(new Option(t, t)));
      list.forEach(t=> e.add(new Option(t, t)));
      s.value = SLOT[slot].start; e.value = SLOT[slot].end;
    }
    function uiAnytime(on){
      $('startSel').disabled = on; $('endSel').disabled = on;
      document.getElementById('timeRow').style.opacity = on ? .5 : 1;
    }

    // ===== åå‰ãƒ­ãƒ¼ãƒ‰ & ç™»éŒ² =====
    let currentUser = null;
    async function loadStaff(selected=null){
      const { data, error } = await client.from('staff').select('*').eq('include', true).order('name');
      const sel = $('nameSel'); sel.innerHTML='';
      if(error){ $('nameMsg').innerHTML='<span class="err">åå‰ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“: '+error.message+'</span>'; return; }
      (data||[]).forEach(r=> sel.add(new Option(r.name, r.name)));
      const sv = localStorage.getItem('shiftName');
      if(selected){ sel.value=selected; }
      else if(sv && data?.some(d=>d.name===sv)){ sel.value=sv; }
      else if(data?.length){ sel.value=data[0].name; }
      await updateCurrentUser();
    }
    async function updateCurrentUser(){
      const nm = $('nameSel').value;
      if(!nm){ currentUser=null; return; }
      const { data } = await client.from('staff').select('name,is_admin').eq('name', nm).maybeSingle();
      currentUser = data || { name:nm, is_admin:false };
      localStorage.setItem('shiftName', currentUser.name);
      applyPeriodState(); refreshMyMonth();
    }
    $('nameSel').onchange = updateCurrentUser;
    $('addBtn').onclick = async ()=>{
      const nm = $('newName').value.trim(); if(!nm){ alert('åå‰ã‚’å…¥åŠ›'); return; }
      const { error } = await client.from('staff').insert({ name: nm });
      if(error){ $('nameMsg').innerHTML='<span class="err">'+error.message+'</span>'; return; }
      $('nameMsg').innerHTML='<span class="ok">ç™»éŒ²ã—ã¾ã—ãŸ</span>'; $('newName').value='';
      await loadStaff(nm);
    };
    $('lockBtn').onclick=()=>{
      const sel=$('nameSel'); const on=!sel.disabled;
      if(on){ if(!sel.value){alert('åå‰ã‚’é¸æŠ');return;} sel.disabled=true; sel.style.opacity=.6; $('lockBtn').textContent='ğŸ”“ å¤‰æ›´'; localStorage.setItem('shiftName', sel.value); }
      else { sel.disabled=false; sel.style.opacity=1; $('lockBtn').textContent='âœ”ï¸ ãƒ­ãƒƒã‚¯'; localStorage.removeItem('shiftName'); }
    };

    // ===== æœŸé–“ UI =====
    let periods=nextTwoPeriods();
    function buildPeriodSelect(){
      const sel=$('periodSel'); sel.innerHTML='';
      periods=nextTwoPeriods();
      periods.forEach(p=> sel.add(new Option(labelHalf(p.y,p.m,p.h), `${p.y}-${p.m}-${p.h}`)));
      sel.value=`${periods[0].y}-${periods[0].m}-${periods[0].h}`;
      applyPeriodState();
    }
    function getSelPeriod(){
      const [y,m,h]= $('periodSel').value.split('-'); 
      return periods.find(v=>v.y==y && v.m==m && v.h==h) || periods[0];
    }
    function applyPeriodState(){
      const p=getSelPeriod();
      const now=new Date(); now.setHours(0,0,0,0);
      const dl=p.dl, gr=p.grace;
      const state = now<=dl ? 'å‹Ÿé›†ä¸­' : (now<=gr ? 'çŒ¶äºˆä¸­ï¼ˆç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰' : 'ç· åˆ‡æ¸ˆ');
      document.getElementById('stateBadge').textContent = state + (currentUser?.is_admin && state!=='å‹Ÿé›†ä¸­' ? 'ï¼šç®¡ç†è€…ã¯ç·¨é›†å¯' : '');
      document.getElementById('deadlineTxt').textContent = `${dl.getFullYear()}å¹´${dl.getMonth()+1}æœˆ${dl.getDate()}æ—¥`;
      const diffDays = Math.ceil(( (now<=dl?dl:gr) - now )/86400000);
      document.getElementById('remainTxt').textContent = now<=gr ? `æ®‹ã‚Š ${diffDays} æ—¥` : 'å—ä»˜çµ‚äº†';
      const canEdit = (now<=dl) || (now>dl && now<=gr && currentUser?.is_admin);
      $('submitBtn').disabled = !canEdit;
      $('shiftForm').querySelectorAll('input,textarea,select').forEach(el=>{ if(el.id!=='date') el.disabled = !canEdit; });
      loadNotice(p.y,p.m,p.h);
      calYear=p.y; calMonth=p.m; rebuildCalendar();
    }
    $('periodSel').onchange = applyPeriodState;

    // ===== ãŠçŸ¥ã‚‰ã› =====
    async function loadNotice(y,m,h){
      const { data } = await client.from('period_notice').select('message').eq('year',y).eq('month',m).eq('half',h).maybeSingle();
      $('noticeBox').innerHTML = data?.message ? data.message.replace(/\n/g,'<br>') : 'ï¼ˆãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
    }

    // ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ =====
    const WDAY=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    function monthEndDays(){ return new Date(calYear, calMonth, 0).getDate(); }
    function parseYMD(s){const[a,b,c]=s.split('-').map(Number); return {y:a,m:b,d:c};}
    let calYear, calMonth;
    let myMonthMap=new Map();

    async function refreshMyMonth(){
      if(!currentUser?.name){ myMonthMap=new Map(); rebuildCalendar(); return; }
      const days=monthEndDays();
      const from=fmtYMD(calYear, calMonth, 1), to=fmtYMD(calYear, calMonth, days);
      const { data } = await client.from('shifts').select('date,start_time,end_time,note').eq('staff_name', currentUser.name).gte('date', from).lte('date', to);
      myMonthMap=new Map();
      (data||[]).forEach(r=>{ const d=Number(r.date.slice(-2)); const arr=myMonthMap.get(d)||[]; arr.push(r); myMonthMap.set(d,arr); });
      rebuildCalendar();
    }

    function inferredSlot(start){ return (start < '16:00') ? 'LUNCH' : 'DINNER'; }
    function prettyLabel(rec){
      const slotLabel = (inferredSlot(rec.start_time)==='LUNCH') ? 'ãƒ©ãƒ³ãƒ' : 'ãƒ‡ã‚£ãƒŠãƒ¼';
      const isCircle = rec.note && rec.note.trim().startsWith('â—¯');
      return isCircle ? `${slotLabel}ï¼šâ—¯` : `${slotLabel}ï¼š${rec.start_time.slice(0,5)}â€“${rec.end_time.slice(0,5)}`;
    }

    function rebuildCalendar(){
      const grid=$('calGrid');
      while(grid.children.length>7) grid.removeChild(grid.lastChild);
      document.getElementById('calTitle').textContent=`${calYear}å¹´ ${calMonth}æœˆ`;

      const first=new Date(calYear,calMonth-1,1), last=new Date(calYear,calMonth,0), days=last.getDate(), startDow=first.getDay();
      const today=new Date(); today.setHours(0,0,0,0);
      for(let i=0;i<startDow;i++){ const d=document.createElement('div'); d.className='cell muted'; grid.appendChild(d); }
      const selected=$('date').value;

      for(let d=1; d<=days; d++){
        const dow=new Date(calYear,calMonth-1,d).getDay(), ymd=fmtYMD(calYear,calMonth,d);
        let cls='cell clickable'; if(dow===0)cls+=' sun'; else if(dow===6)cls+=' sat';
        if(selected===ymd) cls+=' selected';
        if(today.getFullYear()===calYear && (today.getMonth()+1)===calMonth && today.getDate()===d) cls+=' today-ring';
        const mine=myMonthMap.get(d)||[]; if(mine.length) cls+=' has-shift';

        const div=document.createElement('div'); div.className=cls;
        div.innerHTML=`<div class="top"><div class="day">${d}</div><span class="wday">(${WDAY[dow]})</span></div>`;
        if(mine.length){
          const first=mine[0];
          const label=prettyLabel(first) + (mine.length>1?'  +'+(mine.length-1)+'ä»¶':'');
          const pill=document.createElement('div'); pill.className='pill'; pill.textContent=label; div.appendChild(pill);
        }

        div.addEventListener('click', ()=>{
          const was=($('date').value===ymd); $('date').value=ymd; rebuildCalendar(); if(was){ $('startSel').focus(); }
          updateDraftPreview();
        });

        grid.appendChild(div);
      }

      const rem=grid.children.length%7; if(rem!==0){ for(let i=0;i<7-rem;i++){ const d=document.createElement('div'); d.className='cell muted'; grid.appendChild(d); } }
      updateDraftPreview();
    }

    function updateDraftPreview(){
      const date=$('date').value; if(!date) return;
      const on=$('anytimeChk').checked;
      const {d}=parseYMD(date); const cells=$('calGrid').querySelectorAll('.cell.clickable'); const t=cells[d-1]; if(!t) return;
      t.classList.add('draft'); const old=t.querySelector('.pill.draft'); if(old)old.remove();
      const slot = document.querySelector('input[name="slot"]:checked').value;
      const text = on ? `${SLOT[slot].label}ï¼šâ—¯` : `${SLOT[slot].label}ï¼š${$('startSel').value}â€“${$('endSel').value}`;
      const pill=document.createElement('div'); pill.className='pill draft'; pill.textContent=text; t.appendChild(pill);
    }
    Array.from(document.querySelectorAll('input[name="slot"]')).forEach(r=>{
      r.addEventListener('change', ()=>{
        buildTimeSelects(r.value);
        uiAnytime($('anytimeChk').checked);
        updateDraftPreview();
      });
    });
    $('anytimeChk').addEventListener('change', (e)=>{ uiAnytime(e.target.checked); updateDraftPreview(); });
    $('startSel').addEventListener('change', updateDraftPreview);
    $('endSel').addEventListener('change', updateDraftPreview);
    $('date').addEventListener('change', ()=>{const {y,m}=parseYMD($('date').value); if(y&&m){calYear=y; calMonth=m;} rebuildCalendar();});

    // ===== é€ä¿¡ =====
    $('shiftForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const p=getSelPeriod(), now=new Date(); now.setHours(0,0,0,0);
      const canEdit = (now<=p.dl) || (now>p.dl && now<=p.grace && currentUser?.is_admin);
      if(!canEdit){ $('msg').innerHTML='<span class="warn">ã“ã®æœŸé–“ã¯ç¾åœ¨ç·¨é›†ã§ãã¾ã›ã‚“</span>'; return; }

      const slot = document.querySelector('input[name="slot"]:checked').value; // LUNCH/DINNER
      const any = $('anytimeChk').checked;
      const start = any ? SLOT[slot].start : $('startSel').value;
      const end   = any ? SLOT[slot].end   : $('endSel').value;
      if(!any && start >= end){ $('msg').innerHTML='<span class="err">é–‹å§‹ã¯çµ‚äº†ã‚ˆã‚Šå‰ã«ã—ã¦ãã ã•ã„</span>'; return; }

      const noteUser = $('note').value.trim();
      const note = (any ? 'â—¯ ' : '') + (noteUser || '');
      const row={ staff_name: currentUser.name, date:$('date').value, start_time:start, end_time:end, note: note || null };

      $('msg').textContent='é€ä¿¡ä¸­â€¦';
      const { error } = await client.from('shifts').insert(row);
      if(error){ $('msg').innerHTML='<span class="err">Error: '+error.message+'</span>'; return; }
      $('msg').innerHTML='<span class="ok">é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸</span>';

      const {d}=parseYMD(row.date); const arr=myMonthMap.get(d)||[]; arr.unshift({start_time:row.start_time,end_time:row.end_time,note:row.note}); myMonthMap.set(d,arr);
      rebuildCalendar();
      const cells=$('calGrid').querySelectorAll('.cell.clickable'); const t=cells[d-1]; if(t){ t.classList.add('flash'); setTimeout(()=>t.classList.remove('flash'),1000); }
      e.target.reset();
      document.querySelector('input[name="slot"][value="LUNCH"]').checked = true;
      buildTimeSelects('LUNCH'); uiAnytime(false);
      $('date').value = row.date;
      updateDraftPreview(); loadList();
    });

    // ===== æœ€æ–°10ä»¶ =====
    async function loadList(){
      const { data, error } = await client.from('shifts').select('*').order('date',{ascending:false}).order('created_at',{ascending:false}).limit(10);
      if(error){ $('list').innerHTML='<li class="err">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</li>'; return; }
      $('list').innerHTML = data.length ? data.map(s=>{
        const isCircle = s.note && s.note.trim().startsWith('â—¯');
        const slot = (s.start_time < '16:00') ? 'ãƒ©ãƒ³ãƒ' : 'ãƒ‡ã‚£ãƒŠãƒ¼';
        return `<li>${s.date} ï½œ ${s.staff_name} ï½œ ${slot}ï¼š${isCircle?'â—¯':`${s.start_time.slice(0,5)}â€“${s.end_time.slice(0,5)}`} ${s.note? 'ï¼ˆ'+s.note.replace(/^â—¯\s*/,'')+'ï¼‰':''}</li>`;
      }).join('') : '<li>ã¾ã æå‡ºã¯ã‚ã‚Šã¾ã›ã‚“</li>';
    }

    // ===== åˆæœŸåŒ– =====
    (async ()=>{
      buildPeriodSelect();
      const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1;
      $('date').value = fmtYMD(t.getFullYear(), t.getMonth()+1, t.getDate());
      buildTimeSelects('LUNCH'); uiAnytime(false);
      await loadStaff(); await refreshMyMonth(); await loadList();
    })();

    // æœˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    $('prevMonth').onclick=()=>{calMonth--; if(calMonth===0){calMonth=12; calYear--;} rebuildCalendar();};
    $('nextMonth').onclick=()=>{calMonth++; if(calMonth===13){calMonth=1; calYear++;} rebuildCalendar();};
    $('thisMonth').onclick=()=>{const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1; rebuildCalendar();};
  </script>
</body>
</html>
