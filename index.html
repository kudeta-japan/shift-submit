<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KUâ€‘DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#fafafa; --pri:#111827;
    --ok:#0a8; --warn:#92400e; --sun:#e11d48; --sat:#2563eb; --today:#22c55e;
    --cell:#fff; --cell-sub:#eefbf5; --hover:#f3f4f6;
    --chip:#f3f4f6; --chip-l:#e8f3ff; --chip-d:#f6e8ff; --chip-draft:#fff7cc; --chip-bd:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;max-width:1000px;margin:26px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .25rem}
  .note{color:var(--muted);font-size:.9rem}
  input,select,button,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
  button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg);border:1px solid var(--border)}
  button:hover{opacity:.92}

  .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
  .bar > *{flex:1 1 210px}
  .badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);background:#fff;border-radius:999px;padding:6px 10px}
  .tight{display:flex;gap:8px;align-items:center}
  #lockBtn{flex:0 0 auto}

  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:12px}
  .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .slot{border:1px solid var(--border);border-radius:10px;padding:10px}
  .slot h3{margin:0 0 6px;font-size:1rem}
  .slot small{color:var(--muted)}
  .slot .row > *{flex:1 1 120px}
  .slot label{display:flex;align-items:center;gap:6px;font-size:.95rem}

  .cal{background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:14px}
  .cal-hd{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
  .legend{display:flex;gap:12px;align-items:center;color:#6b7280;font-size:.85rem;padding:8px 12px;border-bottom:1px solid var(--border)}
  .dot{width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid var(--border)}
  .d-sub{background:var(--cell-sub)} .d-draft{background:var(--chip-draft)} .d-today{border-color:var(--today)}

  .grid{display:grid;grid-template-columns:repeat(7,1fr)}
  .dow{font-weight:700;font-size:.9rem;color:#374151;padding:8px 0;text-align:center;background:#f7f7f7;border-bottom:1px solid var(--border)}
  .cell{min-height:108px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px;position:relative;background:var(--cell);transition:background .15s;cursor:pointer}
  .cell:hover{background:var(--hover)}
  .head{display:flex;gap:6px;align-items:center}
  .day{font-weight:800}
  .wday{font-size:.75rem;color:#6b7280}
  .sun .day{color:var(--sun)} .sat .day{color:var(--sat)}
  .today{box-shadow:0 0 0 2px var(--today) inset;border-radius:6px}
  .selected{outline:2px solid #111827; outline-offset:-2px; border-radius:6px}
  .muted{color:#9ca3af}

  .chip{margin-top:4px;font-size:.8rem;color:#374151;background:var(--chip);border:1px solid var(--chip-bd);border-radius:8px;padding:3px 6px;line-height:1.3;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical}
  .chip.l{background:var(--chip-l)} .chip.d{background:var(--chip-d)} .chip.draft{background:var(--chip-draft);border-color:#facc15}

  @media (max-width:820px){
    .grid2{grid-template-columns:1fr}
  }
</style>
</head>
<body>
  <h1>KUâ€‘DETA ã‚·ãƒ•ãƒˆæå‡º</h1>
  <p class="note">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯ <b>15æ—¥</b>/<b>æœˆæœ«</b>ã€çŒ¶äºˆ<b>3æ—¥</b>ï¼ˆçŒ¶äºˆä¸­ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯<b>â—¯</b>ã§è¡¨ã—ã¾ã™ã€‚</p>

  <!-- ä¸Šæ®µï¼šåå‰ / æœŸé–“ / ãƒ­ãƒƒã‚¯ -->
  <div class="bar">
    <div class="tight">
      <span class="note" style="min-width:6em">ã‚ãªãŸã®åå‰</span>
      <select id="nameSel" style="flex:1"></select>
    </div>
    <div class="tight">
      <input id="newName" placeholder="æ–°è¦ç™»éŒ²ï¼ˆä¾‹ï¼šä¹…ç´ çœŸå¸Œï¼‰" />
      <button id="addBtn" class="ghost">ï¼‹ ç™»éŒ²</button>
    </div>
    <div class="tight">
      <span class="note" style="min-width:3.5em">æœŸé–“</span>
      <select id="periodSel"></select>
    </div>
    <button id="lockBtn">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
  </div>
  <div class="bar" style="margin-top:8px">
    <span class="badge">çŠ¶æ…‹ï¼š<span id="stateBadge">â€”</span></span>
    <span class="badge">ç· åˆ‡ï¼š<span id="deadlineTxt">â€”</span></span>
    <span class="badge"><span id="remainTxt">â€”</span></span>
    <span class="note" id="noticeBox" style="margin-left:auto">ï¼ˆãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰</span>
  </div>

  <!-- å…¥åŠ›ã‚«ãƒ¼ãƒ‰ -->
  <section class="card">
    <div class="grid2">
      <div>
        <label class="note">æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠå¯ï¼‰</label>
        <input type="date" id="date" />
      </div>
      <div class="row" style="justify-content:flex-end">
        <button id="submitBtn">ğŸ“¨ é€ä¿¡</button>
        <span id="msg" class="note"></span>
      </div>
    </div>

    <div class="grid2" style="margin-top:8px">
      <!-- ãƒ©ãƒ³ãƒ -->
      <div class="slot" id="lunchBlock">
        <h3>ãƒ©ãƒ³ãƒ <small>ï¼ˆ10:00â€“16:00ï¼‰</small></h3>
        <label style="margin-bottom:6px"><input type="checkbox" id="Lenable"> ãƒ©ãƒ³ãƒã‚’æå‡ºã™ã‚‹</label>
        <div class="row">
          <select id="Lstart"></select>
          <span class="note">ã€œ</span>
          <select id="Lend"></select>
        </div>
        <label style="margin-top:6px"><input type="checkbox" id="Lany"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
      </div>

      <!-- ãƒ‡ã‚£ãƒŠãƒ¼ -->
      <div class="slot" id="dinnerBlock">
        <h3>ãƒ‡ã‚£ãƒŠãƒ¼ <small>ï¼ˆ17:00â€“24:00ï¼‰</small></h3>
        <label style="margin-bottom:6px"><input type="checkbox" id="Denable"> ãƒ‡ã‚£ãƒŠãƒ¼ã‚’æå‡ºã™ã‚‹</label>
        <div class="row">
          <select id="Dstart"></select>
          <span class="note">ã€œ</span>
          <select id="Dend"></select>
        </div>
        <label style="margin-top:6px"><input type="checkbox" id="Dany"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
      </div>
    </div>

    <label style="display:block;margin-top:10px">å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
    <textarea id="note" rows="2" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>
  </section>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <section class="cal">
    <div class="cal-hd">
      <div id="calTitle" style="font-weight:800">â€”</div>
      <div class="row">
        <button id="prevMonth" class="ghost">â€¹ å‰æœˆ</button>
        <button id="thisMonth" class="ghost">ä»Šæœˆ</button>
        <button id="nextMonth" class="ghost">æ¬¡æœˆ â€º</button>
      </div>
    </div>
    <div class="legend">
      <span><span class="dot d-sub"></span> æå‡ºæ¸ˆã¿</span>
      <span><span class="dot d-draft"></span> å…¥åŠ›ä¸­</span>
      <span><span class="dot d-today"></span> ä»Šæ—¥</span>
    </div>
    <div class="grid" id="calGrid">
      <div class="dow">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div>
      <div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow">åœŸ</div>
    </div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 6px">æœ€æ–°ã®æå‡º</h3>
    <ul id="list" class="note" style="margin:6px 0 0 1em"><li>èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
  </section>

  <!-- â–¼ ä¸‹éƒ¨ï¼šæå‡ºä¸€è¦§ã¸ -->
  <div class="row" style="justify-content:flex-end;margin-top:10px">
    <button class="ghost" id="toListBtn">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
  </div>

<script>
/* ===== Supabaseï¼ˆURLã¯æŒ‡å®šé€šã‚Šã«å¤‰æ›´æ¸ˆã¿ã€‚éµã¯å·®ã—æ›¿ãˆã¦ãã ã•ã„ï¼‰ ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
/* =============================================================== */

const $=id=>document.getElementById(id);

/* ========= æœŸé–“/æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ========= */
function fmtYMD(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function labelHalf(y,m,h){ return `${y}å¹´${m}æœˆ ${h==='å‰åŠ'?'1-15æ—¥':'16-æœˆæœ«'}`; }
function deadlineOf(y,m,h){ return (h==='å‰åŠ') ? new Date(y, m-2, 15) : new Date(y, m-1, 0); }
function graceUntil(d){ const g=new Date(d); g.setDate(g.getDate()+3); return g; }
function nextTwoPeriods(now=new Date()){
  now.setHours(0,0,0,0);
  let y=now.getFullYear(), m=now.getMonth()+1, h=(now.getDate()<=15?'å¾ŒåŠ':'å‰åŠ');
  const adv=()=>{ if(h==='å‰åŠ'){h='å¾ŒåŠ';} else {h='å‰åŠ'; m++; if(m===13){m=1;y++;}}};
  const arr=[]; for(let i=0;i<2;){ adv(); const dl=deadlineOf(y,m,h); if(dl>=now){arr.push({y,m,h,dl,gr:graceUntil(dl)}); i++;} }
  return arr;
}
function monthEnd(y,m){ return new Date(y,m,0).getDate(); }

/* ========= 30åˆ†åˆ»ã¿ ========= */
function timesBetween(a,b){ const out=[]; let[h,m]=a.split(':').map(Number); const[eh,em]=b.split(':').map(Number);
  while(h<eh || (h===eh && m<=em)){ out.push(`${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`); m+=30; if(m===60){m=0;h++;} }
  return out;
}
const SLOT={ LUNCH:{label:'ãƒ©ãƒ³ãƒ',start:'10:00',end:'16:00'}, DINNER:{label:'ãƒ‡ã‚£ãƒŠãƒ¼',start:'17:00',end:'24:00'} };
function populateTimeOptions(sel, startHour, endHour) {
  sel.innerHTML = "";
  for (let h = startHour; h <= endHour; h++) for (let m of [0, 30]) {
    const t = `${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`;
    const opt = document.createElement("option"); opt.value=t; opt.textContent=t; sel.appendChild(opt);
  }
}
function setDisabled(elStart,elEnd,on){ elStart.disabled=on; elEnd.disabled=on; }

/* ========= åå‰ãƒ­ãƒ¼ãƒ‰/ç™»éŒ²/ãƒ­ãƒƒã‚¯ ========= */
let currentUser={name:'ï¼ˆæœªè¨­å®šï¼‰', is_admin:false}, periods=nextTwoPeriods(), calYear,calMonth, myMonthMap=new Map();

async function loadStaff(selName=null){
  const {data,error}=await supa.from('staff').select('*').eq('include',true).order('name');
  const sel=$('nameSel'); sel.innerHTML='';
  if(error){console.error(error); return;}
  (data||[]).forEach(r=>sel.add(new Option(r.name,r.name)));
  const sv=localStorage.getItem('shiftName');
  if(selName){sel.value=selName;}
  else if(sv && data?.some(d=>d.name===sv)){sel.value=sv;}
  else if(data?.length){sel.value=data[0].name;}
  await updateCurrentUser();
}
async function updateCurrentUser(){
  const nm=$('nameSel').value; if(!nm){currentUser={name:'ï¼ˆæœªè¨­å®šï¼‰',is_admin:false};return;}
  const {data}=await supa.from('staff').select('name,is_admin').eq('name',nm).maybeSingle();
  currentUser=data||{name:nm,is_admin:false};
  localStorage.setItem('shiftName',currentUser.name);
  applyPeriodState(); refreshMyMonth();
}
$('nameSel').onchange=updateCurrentUser;

$('addBtn').onclick=async()=>{
  const nm=$('newName').value.trim(); if(!nm){alert('åå‰ã‚’å…¥åŠ›');return;}
  const { error } = await supa.from('staff').insert({name:nm});
  if(error){alert(error.message);return;}
  $('newName').value=''; await loadStaff(nm);
};
$('lockBtn').onclick=()=>{
  const el=$('nameSel'); const on=!el.disabled;
  if(on){ if(!el.value){alert('åå‰ã‚’é¸æŠ');return;} el.disabled=true; el.style.opacity=.6; $('lockBtn').textContent='ğŸ”“ å¤‰æ›´'; localStorage.setItem('shiftName',el.value);}
  else{ el.disabled=false; el.style.opacity=1; $('lockBtn').textContent='âœ”ï¸ ãƒ­ãƒƒã‚¯'; localStorage.removeItem('shiftName');}
};

/* ========= æœŸé–“ UI ========= */
function buildPeriodSel(){
  const sel=$('periodSel'); sel.innerHTML=''; periods=nextTwoPeriods();
  periods.forEach(p=>sel.add(new Option(labelHalf(p.y,p.m,p.h),`${p.y}-${p.m}-${p.h}`)));
  sel.value=`${periods[0].y}-${periods[0].m}-${periods[0].h}`; applyPeriodState();
}
function curPeriod(){ const[a,b,c]=$('periodSel').value.split('-'); return periods.find(p=>p.y==a&&p.m==b&&p.h==c)||periods[0]; }
async function loadNotice(y,m,h){
  const {data}=await supa.from('period_notice').select('message').eq('year',y).eq('month',m).eq('half',h).maybeSingle();
  $('noticeBox').textContent = data?.message || 'ï¼ˆãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ï¼‰';
}
function applyPeriodState(){
  const p=curPeriod(), now=new Date(); now.setHours(0,0,0,0);
  const state= now<=p.dl ? 'å‹Ÿé›†ä¸­' : (now<=p.gr ? 'çŒ¶äºˆä¸­ï¼ˆç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰' : 'ç· åˆ‡æ¸ˆ');
  $('stateBadge').textContent = state + (currentUser?.is_admin && state!=='å‹Ÿé›†ä¸­' ? 'ï¼šç®¡ç†è€…ã¯ç·¨é›†å¯' : '');
  $('deadlineTxt').textContent = `${p.dl.getFullYear()}å¹´${p.dl.getMonth()+1}æœˆ${p.dl.getDate()}æ—¥`;
  const diff = Math.ceil(((now<=p.dl?p.dl:p.gr)-now)/86400000);
  $('remainTxt').textContent = now<=p.gr ? `æ®‹ã‚Š ${diff} æ—¥` : 'å—ä»˜çµ‚äº†';

  const canEdit = (now<=p.dl) || (now>p.dl && now<=p.gr && currentUser?.is_admin);
  $('submitBtn').disabled=!canEdit;
  document.querySelectorAll('#Lenable,#Lstart,#Lend,#Lany,#Denable,#Dstart,#Dend,#Dany,#note').forEach(el=>el.disabled=!canEdit);

  loadNotice(p.y,p.m,p.h);
  calYear=p.y; calMonth=p.m; rebuildCalendar(); refreshMyMonth();
}
$('periodSel').onchange=applyPeriodState;

/* ========= ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ========= */
const WDAY=['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
function rebuildCalendar(){
  const grid=$('calGrid'); while(grid.children.length>7) grid.removeChild(grid.lastChild);
  $('calTitle').textContent=`${calYear}å¹´ ${calMonth}æœˆ`;
  const first=new Date(calYear,calMonth-1,1), last=new Date(calYear,calMonth,0), days=last.getDate(), startDow=first.getDay();
  const today=new Date(); today.setHours(0,0,0,0);

  for(let i=0;i<startDow;i++){ const pad=document.createElement('div'); pad.className='cell muted'; grid.appendChild(pad); }

  const selected=$('date').value;
  for(let d=1; d<=days; d++){
    const dow=new Date(calYear,calMonth-1,d).getDay(), ymd=fmtYMD(calYear,calMonth,d);
    let cls='cell'; if(dow===0)cls+=' sun'; else if(dow===6)cls+=' sat';
    if(selected===ymd) cls+=' selected';
    if(today.getFullYear()===calYear && today.getMonth()+1===calMonth && today.getDate()===d) cls+=' today';

    const div=document.createElement('div'); div.className=cls;
    div.innerHTML=`<div class="head"><span class="day">${d}</span><span class="wday">(${WDAY[dow]})</span></div>`;

    const mine=(myMonthMap.get(d)||[]);
    if(mine.length){
      mine.sort((a,b)=>a.start_time.localeCompare(b.start_time));
      mine.slice(0,2).forEach(rec=>{
        const chip=document.createElement('div');
        const isL = rec.start_time < '16:00';
        chip.className='chip ' + (isL?'l':'d');
        const isCircle = rec.note && rec.note.trim().startsWith('â—¯');
        const lab = isCircle ? 'â—¯' : `${rec.start_time.slice(0,5)}â€“${rec.end_time.slice(0,5)}`;
        chip.textContent = (isL?'ãƒ©ãƒ³ãƒ':'ãƒ‡ã‚£ãƒŠãƒ¼') + 'ï¼š' + lab;
        chip.title = (rec.note||'').replace(/^â—¯\s*/,'');
        div.appendChild(chip);
      });
      if(mine.length>2){ const more=document.createElement('div'); more.className='chip'; more.textContent=`+${mine.length-2} ä»¶`; div.appendChild(more); }
      div.style.background='var(--cell-sub)';
    }

    div.addEventListener('click', ()=>{
      $('date').value=ymd;
      rebuildCalendar();
      drawDraftChip();
    });

    grid.appendChild(div);
  }
  const rem=grid.children.length%7; if(rem){for(let i=0;i<7-rem;i++){const pad=document.createElement('div');pad.className='cell muted';grid.appendChild(pad);}}
  drawDraftChip();
}
function drawDraftChip(){
  const s=$('date').value; if(!s) return;
  const d=Number(s.slice(-2)); const idxOffset=new Date(calYear,calMonth-1,1).getDay();
  const cell=$('calGrid').children[7 + (idxOffset + d -1)];
  if(!cell) return;
  Array.from(cell.querySelectorAll('.chip.draft')).forEach(n=>n.remove());

  if($('Lenable').checked){
    const lAny=$('Lany').checked;
    const L = lAny || $('Lstart').value && $('Lend').value ? {any:lAny,start:$('Lstart').value,end:$('Lend').value} : null;
    if(L){ const c=document.createElement('div'); c.className='chip draft'; c.textContent=`ãƒ©ãƒ³ãƒï¼š${L.any?'â—¯':`${L.start}â€“${L.end}`}`; cell.appendChild(c); }
  }
  if($('Denable').checked){
    const dAny=$('Dany').checked;
    const D = dAny || $('Dstart').value && $('Dend').value ? {any:dAny,start:$('Dstart').value,end:$('Dend').value} : null;
    if(D){ const c=document.createElement('div'); c.className='chip draft'; c.textContent=`ãƒ‡ã‚£ãƒŠãƒ¼ï¼š${D.any?'â—¯':`${D.start}â€“${D.end}`}`; cell.appendChild(c); }
  }
}

async function refreshMyMonth(){
  if(!currentUser?.name){myMonthMap=new Map(); rebuildCalendar(); return;}
  const from=fmtYMD(calYear,calMonth,1), to=fmtYMD(calYear,calMonth,monthEnd(calYear,calMonth));
  const {data}=await supa.from('shifts').select('date,start_time,end_time,note').eq('staff_name',currentUser.name).gte('date',from).lte('date',to);
  myMonthMap=new Map();
  (data||[]).forEach(r=>{ const d=Number(r.date.slice(-2)); const arr=myMonthMap.get(d)||[]; arr.push(r); myMonthMap.set(d,arr); });
  rebuildCalendar();
}

/* ========= å…¥åŠ›ãƒ–ãƒ­ãƒƒã‚¯åˆ¶å¾¡ ========= */
function setBlockEnabled(block, enableChkId, anyId, startId, endId){
  const on = $(enableChkId).checked;
  $(anyId).disabled = !on;
  setDisabled($(startId), $(endId), !on || $(anyId).checked);
  $(block).style.opacity = on ? 1 : 0.5;
}
$('Lenable').onchange = ()=>{ setBlockEnabled('lunchBlock','Lenable','Lany','Lstart','Lend'); drawDraftChip(); };
$('Denable').onchange = ()=>{ setBlockEnabled('dinnerBlock','Denable','Dany','Dstart','Dend'); drawDraftChip(); };
$('Lany').onchange = ()=>{ setDisabled($('Lstart'), $('Lend'), $('Lany').checked || !$('Lenable').checked); drawDraftChip(); };
$('Dany').onchange = ()=>{ setDisabled($('Dstart'), $('Dend'), $('Dany').checked || !$('Denable').checked); drawDraftChip(); };

/* ========= é€ä¿¡ï¼ˆèªè¨¼ä¸è¦ï¼‰ ========= */
$('submitBtn').onclick=async()=>{
  const p=curPeriod(), now=new Date(); now.setHours(0,0,0,0);
  const canEdit=(now<=p.dl) || (now>p.dl && now<=p.gr && currentUser?.is_admin);
  if(!canEdit){ $('msg').innerHTML='<span class="warn">ã“ã®æœŸé–“ã¯ç¾åœ¨ç·¨é›†ã§ãã¾ã›ã‚“</span>'; return; }

  const date=$('date').value;
  if(!date){ $('msg').textContent='æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }
  if(!currentUser?.name || currentUser.name==='ï¼ˆæœªè¨­å®šï¼‰'){ $('msg').textContent='åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„'; return; }

  // ãã®æ—¥ã®è‡ªåˆ†ã®æå‡ºã‚’ä¸€æ—¦å‰Šé™¤ï¼ˆç©ºæ¬„åæ˜ ï¼‰
  const del = await supa.from('shifts').delete().eq('staff_name', currentUser.name).eq('date', date);
  if(del.error){ $('msg').textContent='Error: '+del.error.message; return; }

  const rows=[];
  if ($('Lenable').checked) {
    const lAny=$('Lany').checked;
    rows.push({ staff_name: currentUser.name, date,
      start_time: lAny?SLOT.LUNCH.start:$('Lstart').value,
      end_time:   lAny?SLOT.LUNCH.end  :$('Lend').value,
      note: (lAny?'â—¯ ':'') + ($('note').value.trim()||'')
    });
  }
  if ($('Denable').checked) {
    const dAny=$('Dany').checked;
    rows.push({ staff_name: currentUser.name, date,
      start_time: dAny?SLOT.DINNER.start:$('Dstart').value,
      end_time:   dAny?SLOT.DINNER.end  :$('Dend').value,
      note: (dAny?'â—¯ ':'') + ($('note').value.trim()||'')
    });
  }

  if(rows.length===0){
    $('msg').innerHTML='<span class="ok">ãã®æ—¥ã®æå‡ºã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</span>';
    await refreshMyMonth(); loadList(); return;
  }

  $('msg').textContent='é€ä¿¡ä¸­â€¦';
  const ins = await supa.from('shifts').insert(rows);
  if(ins.error){ $('msg').textContent='Error: '+ins.error.message; return; }
  $('msg').innerHTML='<span class="ok">é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸</span>';
  await refreshMyMonth(); loadList();
};

/* ========= æœ€æ–°10ä»¶ ========= */
async function loadList(){
  const {data,error}=await supa.from('shifts').select('*').order('date',{ascending:false}).order('created_at',{ascending:false}).limit(10);
  if(error){ $('list').innerHTML='<li>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</li>'; return; }
  $('list').innerHTML = data.length ? data.map(s=>{
    const isCircle=s.note && s.note.trim().startsWith('â—¯');
    const slot = (s.start_time<'16:00')?'ãƒ©ãƒ³ãƒ':'ãƒ‡ã‚£ãƒŠãƒ¼';
    return `<li>${s.date} ï½œ ${s.staff_name} ï½œ ${slot}ï¼š${isCircle?'â—¯':`${s.start_time.slice(0,5)}â€“${s.end_time.slice(0,5)}`} ${s.note? 'ï¼ˆ'+s.note.replace(/^â—¯\s*/,'')+'ï¼‰':''}</li>`;
  }).join('') : '<li>ã¾ã æå‡ºã¯ã‚ã‚Šã¾ã›ã‚“</li>';
}

/* ========= init ========= */
(function init(){
  const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1;
  $('date').value=fmtYMD(t.getFullYear(), t.getMonth()+1, t.getDate());
  populateTimeOptions($('Lstart'),10,16); populateTimeOptions($('Lend'),10,16);
  populateTimeOptions($('Dstart'),17,24); populateTimeOptions($('Dend'),17,24);
  $('Lenable').checked=false; $('Denable').checked=false;
  setBlockEnabled('lunchBlock','Lenable','Lany','Lstart','Lend');
  setBlockEnabled('dinnerBlock','Denable','Dany','Dstart','Dend');

  buildPeriodSel();
  loadStaff();
  refreshMyMonth();
  loadList();

  $('prevMonth').onclick=()=>{calMonth--; if(calMonth===0){calMonth=12;calYear--;} rebuildCalendar();};
  $('nextMonth').onclick=()=>{calMonth++; if(calMonth===13){calMonth=1;calYear++;} rebuildCalendar();};
  $('thisMonth').onclick=()=>{const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1; rebuildCalendar();};

  // ä¸€è¦§ã¸
  $('toListBtn').onclick = ()=> { window.location.href = 'shiftlink.html'; };
})();
</script>
</body>
</html>
