<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --bd:#e5e7eb; --bg:#fafafa; --card:#fff;
    --lunch:#fff9db; --dinner:#ffe7d6;
    --btn-dark:#111827; --btn-blue:#2563eb; --btn-red:#ef4444; --btn-green:#10b981;
    --warn:#f59e0b;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1100px;margin:22px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .note{color:var(--muted);font-size:.92rem}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  textarea{width:100%;resize:vertical}
  .ghost{background:#fff;color:var(--fg)}
  button{font-weight:700;border:none;cursor:pointer}
  button:disabled{opacity:.55;cursor:not-allowed}
  .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
  .msg{margin-top:8px;font-weight:700}
  .ok{color:#16a34a} .err{color:#b91c1c}
  /* ãƒœã‚¿ãƒ³è‰² */
  .b-blue{background:var(--btn-blue);color:#fff}
  .b-red{background:var(--btn-red);color:#fff}
  .b-green{background:var(--btn-green);color:#fff}
  /* å…¥åŠ›ãƒœãƒƒã‚¯ã‚¹ */
  .ibox{border:1px solid var(--bd);border-radius:12px;padding:12px}
  .ibox.l{background:var(--lunch)} .ibox.d{background:var(--dinner)}
  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .legend{display:flex;gap:10px;align-items:center;color:#374151;margin:6px 0 10px}
  .tag{display:inline-block;border:1px solid var(--bd);border-radius:6px;padding:2px 6px;font-size:.8rem}
  .tag.l{background:var(--lunch)} .tag.d{background:var(--dinner)}
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .dow{font-weight:700;text-align:center}
  .cell{border:1px solid var(--bd);border-radius:12px;min-height:92px;background:#fff;position:relative;padding:6px}
  .day{position:absolute;top:6px;left:8px;font-weight:700;color:#4b5563}
  .mark{position:absolute;bottom:6px;left:6px;right:6px;display:flex;flex-direction:column;gap:4px}
  .selected{outline:2px solid var(--btn-blue)}
  .today{outline:2px solid var(--warn)}
  .chip{font-size:.78rem;border-radius:8px;border:1px solid var(--bd);padding:2px 6px;display:inline-block}
  .chip.draft{background:#fef3c7;border-color:#fde68a}
  .chip.sent{background:#e5f9ef;border-color:#bbf7d0}
  .right{margin-left:auto}
</style>
</head>
<body>
  <h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

  <!-- ä¸Šæ®µï¼šåå‰ãƒ»ãƒ­ãƒƒã‚¯ -->
  <div class="card">
    <div class="row">
      <label><strong>ã‚ãªãŸã®åå‰</strong>
        <select id="nameSel" style="min-width:240px"></select>
      </label>
      <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
      <span id="lockState" class="note"></span>
      <span class="note right">åŠæœˆã”ã¨ã«æå‡ºã€ç· åˆ‡ã¯ <b>15æ—¥ / æœˆæœ«</b>ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
    </div>
  </div>

  <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
        <div class="pill"><span id="ymLabel">YYYYå¹´Mæœˆ</span></div>
        <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
        <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
      </div>
      <div class="row">
        <label class="note">æ—¥ä»˜<select id="dateInp" style="min-width:130px"></select></label>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="ibox l" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</strong><span class="note"> â€»ãƒã‚§ãƒƒã‚¯ä¸è¦ã€æ™‚åˆ»å…¥åŠ›ã‹ã€Œâ—¯ã€ã§åˆ¤å®š</span></div>
        <div class="row">
          <label>é–‹å§‹<select id="lStart"></select></label>
          <label>çµ‚äº†<select id="lEnd"></select></label>
          <label class="note" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="lFree">æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
        </div>
      </div>
      <div class="ibox d" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“23:30ï¼‰</strong><span class="note"> â€»ãƒã‚§ãƒƒã‚¯ä¸è¦ã€æ™‚åˆ»å…¥åŠ›ã‹ã€Œâ—¯ã€ã§åˆ¤å®š</span></div>
        <div class="row">
          <label>é–‹å§‹<select id="dStart"></select></label>
          <label>çµ‚äº†<select id="dEnd"></select></label>
          <label class="note" style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="dFree">æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
        </div>
      </div>
    </div>

    <label style="display:block;margin-top:10px">å‚™è€ƒï¼ˆä»»æ„ï¼‰
      <textarea id="memo" rows="2" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>
    </label>

    <div class="row" style="margin-top:10px">
      <button id="addBtn"  class="b-blue">è¿½åŠ /æ›´æ–°</button>
      <button id="delBtn"  class="b-red">å‰Šé™¤</button>
      <button id="sendBtn" class="b-green">é€ä¿¡</button>
      <span id="msg" class="msg"></span>
      <button id="toListBtn" class="ghost right">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <div class="legend">
      <span class="tag l">ãƒ©ãƒ³ãƒ</span>
      <span class="tag d">ãƒ‡ã‚£ãƒŠãƒ¼</span>
      <span class="chip draft">ä¸‹æ›¸ãã‚ã‚Š</span>
      <span class="chip sent">é€ä¿¡æ¸ˆã¿</span>
      <span class="right note">ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼é¸æŠï¼å†ã‚¯ãƒªãƒƒã‚¯ï¼è§£é™¤</span>
    </div>
    <div id="cal" class="grid"></div>
  </div>

<script>
/* ===== Supabase æ¥ç¶š ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== è¦ç´  ===== */
const $ = id => document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateSel=$('dateInp'), msg=$('msg');
const lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree');
const dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree');
const memo=$('memo');

/* ===== æœˆãƒ»æ—¥ä»˜ ===== */
let calYear, calMonth; // 1-based
function pad2(n){return String(n).padStart(2,'0')}
function setToday(){
  const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1;
}
function fillDateSelect(){
  dateSel.innerHTML='';
  const daysInMonth=new Date(calYear,calMonth,0).getDate();
  for(let d=1; d<=daysInMonth; d++){
    const ds=`${calYear}-${pad2(calMonth)}-${pad2(d)}`;
    dateSel.add(new Option(ds, ds));
  }
}
$('prevBtn').onclick=()=>{ calMonth--; if(calMonth===0){calMonth=12; calYear--;} refreshMonth(); };
$('nextBtn').onclick=()=>{ calMonth++; if(calMonth===13){calMonth=1; calYear++;} refreshMonth(); };
$('thisBtn').onclick=()=>{ setToday(); refreshMonth(); };
function refreshMonth(){
  $('ymLabel').textContent=`${calYear}å¹´${calMonth}æœˆ`;
  fillDateSelect();
  renderCalendar();
  loadSentMarks();
  loadDraftMarks();
}

/* ===== åå‰ã®ãƒ­ãƒƒã‚¯ ===== */
function setLock(on){
  nameSel.disabled=on;
  lockBtn.textContent=on?'ğŸ”“ å¤‰æ›´':'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent=on?`ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}`:'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick=()=>{
  if(nameSel.disabled){ localStorage.removeItem('shift_name'); setLock(false);}
  else{
    if(!nameSel.value){alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„');return;}
    localStorage.setItem('shift_name',nameSel.value); setLock(true);
    loadSentMarks(); loadDraftMarks();
  }
};

/* ===== åå‰ã®å–å¾—ï¼ˆstaff è¡¨ï¼‰ ===== */
async function loadStaff(){
  nameSel.innerHTML='';
  const {data,error}=await supa.from('staff').select('name').eq('include',true).order('display_order',{ascending:true}).order('name',{ascending:true});
  (data||[]).forEach(r=>nameSel.add(new Option(r.name,r.name)));
  const saved=localStorage.getItem('shift_name');
  if(saved && Array.from(nameSel.options).some(o=>o.value===saved)){ nameSel.value=saved; setLock(true);}
}

/* ===== æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆ ===== */
function fillTimes(sel, startMin, endMin){
  sel.innerHTML='<option value=""></option>'; // ç©ºè¨±å¯
  for(let m=startMin; m<=endMin; m+=30){
    const hh=String(Math.floor(m/60)).padStart(2,'0');
    const mm=String(m%60).padStart(2,'0');
    sel.add(new Option(`${hh}:${mm}`,`${hh}:${mm}`));
  }
}
// lunch: 10:00(600)ã€œ16:00(960), dinner: 17:00(1020)ã€œ23:30(1410)
fillTimes(lStart,600,960); fillTimes(lEnd,600,960);
fillTimes(dStart,1020,1410); fillTimes(dEnd,1020,1410);

/* ===== ä¸‹æ›¸ããƒ¡ãƒ¢ãƒªï¼ˆã“ã®ç«¯æœ«ã ã‘ã«ä¿å­˜ï¼‰ ===== */
let drafts = {}; // dateISO -> {L:{start,end,free}, D:{start,end,free}, note}
function readPanelToRow(){
  const L = (lFree.checked || (!lStart.value && !lEnd.value)) ? {free:true} : (lStart.value && lEnd.value ? {start:lStart.value,end:lEnd.value} : null);
  const D = (dFree.checked || (!dStart.value && !dEnd.value)) ? {free:true} : (dStart.value && dEnd.value ? {start:dStart.value,end:dEnd.value} : null);
  return {L,D,note:memo.value.trim()};
}
function writePanelFromRow(r){
  // ãƒªã‚»ãƒƒãƒˆ
  lStart.value=''; lEnd.value=''; lFree.checked=false;
  dStart.value=''; dEnd.value=''; dFree.checked=false; memo.value='';
  if(!r) return;
  if(r.L){ if(r.L.free){lFree.checked=true;} else{lStart.value=r.L.start||''; lEnd.value=r.L.end||'';} }
  if(r.D){ if(r.D.free){dFree.checked=true;} else{dStart.value=r.D.start||''; dEnd.value=r.D.end||'';} }
  memo.value=r.note||'';
}

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» ===== */
let sentMarks={};  // date -> {l:'â—¯/æ™‚åˆ»', d:'â—¯/æ™‚åˆ»'}
function renderCalendar(){
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{const d=document.createElement('div');d.textContent=w;d.className='dow';cal.appendChild(d);});
  const first=new Date(calYear,calMonth-1,1), startDow=first.getDay();
  const days=new Date(calYear,calMonth,0).getDate();
  const todayStr=(d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`)(new Date());
  // blanks
  for(let i=0;i<startDow;i++){ const e=document.createElement('div');e.className='cell';cal.appendChild(e); }
  for(let d=1; d<=days; d++){
    const ds=`${calYear}-${pad2(calMonth)}-${pad2(d)}`;
    const cell=document.createElement('div'); cell.className='cell'; if(ds===todayStr) cell.classList.add('today');
    if(dateSel.value===ds) cell.classList.add('selected');
    cell.onclick=()=>{ dateSel.value=ds; writePanelFromRow(drafts[ds]); renderCalendar(); };
    const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
    const mark=document.createElement('div'); mark.className='mark';
    // é€ä¿¡æ¸ˆã¿
    const s=sentMarks[ds]||{};
    if(s.l){ const sp=document.createElement('span'); sp.className='tag l'; sp.textContent=s.l; mark.appendChild(sp);}
    if(s.d){ const sp=document.createElement('span'); sp.className='tag d'; sp.textContent=s.d; mark.appendChild(sp);}
    // ä¸‹æ›¸ã
    if(drafts[ds]){
      const dk=document.createElement('span'); dk.className='chip draft'; dk.textContent='ä¸‹æ›¸ã'; mark.appendChild(dk);
    }
    cell.appendChild(mark);
    cal.appendChild(cell);
  }
}

/* ===== é€ä¿¡æ¸ˆã¿ã®èª­ã¿è¾¼ã¿ï¼ˆé¸æŠæ°å & å½“æœˆï¼‰ ===== */
async function loadSentMarks(){
  sentMarks={};
  if(!nameSel.value) { renderCalendar(); return; }
  const start=`${calYear}-${pad2(calMonth)}-01`;
  const end=new Date(start); end.setMonth(end.getMonth()+1); const endStr=end.toISOString().slice(0,10);
  const {data}=await supa.from('shifts').select('date,start_time,end_time').eq('staff_name',nameSel.value).gte('date',start).lt('date',endStr);
  (data||[]).forEach(r=>{
    const v=(!r.start_time||!r.end_time)?'â—¯':`${r.start_time.slice(0,5)}ã€œ${r.end_time.slice(0,5)}`;
    const key=(r.start_time && r.start_time<'16:00')?'l':'d';
    sentMarks[r.date] ||= {};
    sentMarks[r.date][key]=v;
  });
  renderCalendar();
}

/* ===== ä¸‹æ›¸ããƒãƒ¼ã‚«ãƒ¼ã®ãƒ­ãƒ¼ãƒ‰/ä¿å­˜ï¼ˆlocalStorageï¼‰ ===== */
function loadDraftMarks(){
  const all = JSON.parse(localStorage.getItem('shift_drafts')||'{}');
  drafts = all[nameSel.value||'_']?.[`${calYear}-${pad2(calMonth)}`] || {};
  writePanelFromRow(drafts[dateSel.value]);
  renderCalendar();
}
function saveDraftMarks(){
  const key=nameSel.value||'_'; const ym=`${calYear}-${pad2(calMonth)}`;
  const all = JSON.parse(localStorage.getItem('shift_drafts')||'{}');
  all[key] ||= {}; all[key][ym]=drafts;
  localStorage.setItem('shift_drafts', JSON.stringify(all));
}

/* ===== ãƒœã‚¿ãƒ³ï¼šè¿½åŠ /æ›´æ–°ãƒ»å‰Šé™¤ãƒ»é€ä¿¡ ===== */
$('addBtn').onclick=()=>{
  msg.textContent='';
  if(!nameSel.disabled){ alert('ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„'); return; }
  const ds=dateSel.value; if(!ds){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const row=readPanelToRow();
  if(!row.L && !row.D){ alert('ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ã„ãšã‚Œã‹ã‚’ã€Œæ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰ã€ã¾ãŸã¯é–‹å§‹ãƒ»çµ‚äº†ã§å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
  // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼šé–‹å§‹<çµ‚äº†ï¼ˆç©ºã¯OKï¼‰
  if(row.L && !row.L.free && row.L.start && row.L.end && row.L.start >= row.L.end){ alert('ãƒ©ãƒ³ãƒã®é–‹å§‹ã¨çµ‚äº†ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„'); return; }
  if(row.D && !row.D.free && row.D.start && row.D.end && row.D.start >= row.D.end){ alert('ãƒ‡ã‚£ãƒŠãƒ¼ã®é–‹å§‹ã¨çµ‚äº†ã‚’è¦‹ç›´ã—ã¦ãã ã•ã„'); return; }
  drafts[ds]=row; saveDraftMarks(); renderCalendar();
  msg.textContent=`ä¸‹æ›¸ãã‚’æ›´æ–°ï¼š${ds}`; msg.className='msg ok';
};
$('delBtn').onclick=()=>{
  const ds=dateSel.value; if(!ds) return;
  delete drafts[ds]; saveDraftMarks(); renderCalendar(); writePanelFromRow(null);
  msg.textContent=`ä¸‹æ›¸ãã‚’å‰Šé™¤ï¼š${ds}`; msg.className='msg';
};
$('sendBtn').onclick=async ()=>{
  msg.textContent='é€ä¿¡ä¸­â€¦'; msg.className='msg';
  if(!nameSel.disabled){ alert('åå‰ã‚’ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  // ä»Šæœˆã®ä¸‹æ›¸ãã ã‘æŠ½å‡º
  const entries = Object.entries(drafts);
  if(entries.length===0){ msg.textContent='é€ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“'; return; }
  // ç½®ãæ›ãˆæ–¹å¼ï¼šãã®æ—¥ã®è‡ªåˆ†ã®è¡Œã‚’ä¸€æ—¦å‰Šé™¤ â†’ ä¸‹æ›¸ãã‚’æŒ¿å…¥
  try{
    for(const [ds,row] of entries){
      await supa.from('shifts').delete().eq('staff_name',nameSel.value).eq('date',ds);
      const rows=[];
      if(row.L){ rows.push({date:ds, staff_name:nameSel.value,
        start_time: row.L.free? null : row.L.start, end_time: row.L.free? null : row.L.end, note: row.note||''}); }
      if(row.D){ rows.push({date:ds, staff_name:nameSel.value,
        start_time: row.D.free? null : row.D.start, end_time: row.D.free? null : row.D.end, note: row.note||''}); }
      if(rows.length) { const {error}=await supa.from('shifts').insert(rows); if(error) throw error; }
    }
    msg.textContent='é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸'; msg.className='msg ok';
    // é€ä¿¡å¾Œã€ä¸‹æ›¸ãã‚’ã‚¯ãƒªã‚¢
    drafts={}; saveDraftMarks(); renderCalendar(); loadSentMarks();
  }catch(e){
    msg.textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+e.message; msg.className='msg err';
  }
};

/* ===== æå‡ºä¸€è¦§ã¸ ===== */
$('toListBtn').onclick=()=>{ location.href = new URL('shiftlink.html', location.href).href; };

/* ===== åˆæœŸåŒ– ===== */
(async function init(){
  setToday();
  $('ymLabel').textContent=`${calYear}å¹´${calMonth}æœˆ`;
  fillDateSelect();
  await loadStaff();
  setLock(!!localStorage.getItem('shift_name'));
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
  lStart.value='10:00'; lEnd.value='16:00'; dStart.value='17:00'; dEnd.value='23:30';
  // åˆæœŸæç”»
  renderCalendar(); loadSentMarks(); loadDraftMarks();
})();
</script>
</body>
</html>
