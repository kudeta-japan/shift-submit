<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KU-DETA シフト提出</title>

  <!-- Supabase (UMD版) ※必ずこのURL -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --bd:#e5e7eb; --bg:#fafafa; --card:#ffffff;
      --btn:#111827; --ok:#16a34a; --warn:#f59e0b; --lunch:#fff9db; --dinner:#ffe7d6;
    }
    *{box-sizing:border-box}
    body{
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)
    }
    h1{font-size:1.6rem;margin:0 0 .75rem}
    .note{color:var(--muted);font-size:.92rem}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,select,button,textarea{
      border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff
    }
    button{background:var(--btn);color:#fff;font-weight:700;border:none;cursor:pointer}
    button.ghost{background:#fff;color:var(--fg)}
    button:hover{opacity:.94}
    .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .dow{font-weight:700;text-align:center;color:#374151}
    .cell{border:1px solid var(--bd);border-radius:10px;min-height:90px;background:#fff;padding:6px;position:relative}
    .day{position:absolute;top:6px;left:8px;font-weight:700;font-size:.92rem;color:#4b5563}
    .mark{position:absolute;bottom:6px;left:6px;right:6px;font-size:.8rem;display:flex;flex-direction:column;gap:3px}
    .tag{display:inline-block;border-radius:6px;padding:2px 6px;font-size:.8rem;border:1px solid var(--bd)}
    .tag.l{background:var(--lunch)} .tag.d{background:var(--dinner)}
    .today{outline:2px solid var(--warn)}
    .selected{outline:2px solid var(--btn)}
    .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
    .right{margin-left:auto}
    .small{font-size:.88rem}
    .msg{margin-top:4px;font-weight:700}
    .ok{color:var(--ok)} .err{color:#b91c1c}
    ul{padding-left:18px;margin:8px 0}
    .box{border:1px dashed var(--bd);border-radius:12px;padding:12px}
    .box.l{background:var(--lunch)} .box.d{background:var(--dinner)}
  </style>
</head>
<body>
  <h1>KU-DETA シフト提出</h1>

  <div class="card">
    <div class="row">
      <strong>あなたの名前</strong>
      <select id="nameSel" style="min-width:220px"></select>
      <input id="nameNew" placeholder="(新規) 例: 久納 真希" style="min-width:220px" />
      <button id="addNameBtn">＋ 登録</button>
      <button id="lockBtn" class="ghost">✔︎ ロック</button>
      <span id="lockState" class="note"></span>
      <span class="right note small">半月ごとに提出。締切は 15日 / 月末（猶予3日は管理者のみ編集可）。時間指定なしは「◯」。</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevBtn" class="ghost">« 前月</button>
        <div class="pill"><span id="ymLabel">YYYY年M月</span></div>
        <button id="thisBtn" class="ghost">今月</button>
        <button id="nextBtn" class="ghost">次月 »</button>
      </div>
      <div class="row">
        <label class="note">日付（カレンダーから選択）</label>
        <input id="dateInp" type="date" />
        <button id="submitBtn">📨 送信</button>
      </div>
    </div>

    <div class="row">
      <div class="box l" style="flex:1 1 360px">
        <div class="row"><label><input type="checkbox" id="lUse" /> ランチ (10:00–16:00) を提出する</label></div>
        <div class="row">
          <label>開始<select id="lStart"></select></label>
          <label>終了<select id="lEnd"></select></label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="lFree" /> 時間指定なし (◯)
          </label>
        </div>
      </div>

      <div class="box d" style="flex:1 1 360px">
        <div class="row"><label><input type="checkbox" id="dUse" /> ディナー (17:00–24:00) を提出する</label></div>
        <div class="row">
          <label>開始<select id="dStart"></select></label>
          <label>終了<select id="dEnd"></select></label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="dFree" /> 時間指定なし (◯)
          </label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <label style="flex:1">備考（任意）<textarea id="memo" rows="2" style="width:100%"></textarea></label>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <div class="card">
    <div class="row small note" style="margin-bottom:8px">
      <span class="pill">legend: <span class="tag l">ランチ</span> <span class="tag d">ディナー</span> ／ ハイライト＝選択日</span>
      <button id="toListBtn" class="right ghost">提出一覧を見る</button>
    </div>
    <div id="cal" class="grid"></div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>最新の提出</strong>
    </div>
    <ul id="recentList"><li class="note">読み込み中…</li></ul>
  </div>

  <!-- ここから JS。全角の記号・スマートクォートを使わないこと！ -->
  <script>
    // Supabase 接続
    const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
    // ↓ anon key は必ず 1 行・半角クォートで貼る（改行・全角クォートNG）
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 要素
    const $ = id => document.getElementById(id);
    const nameSel = $('nameSel'), nameNew=$('nameNew'), addNameBtn=$('addNameBtn'),
          lockBtn=$('lockBtn'), lockState=$('lockState'),
          lUse=$('lUse'), lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree'),
          dUse=$('dUse'), dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree'),
          memo=$('memo'), dateInp=$('dateInp'), msg=$('msg');

    // 名前ロック
    function loadLock(){
      const nm = localStorage.getItem('shift_name') || '';
      if(nm){ ensureNameInSelect(nm,true); nameSel.value=nm; setLock(true); }
      else { setLock(false); }
    }
    function setLock(on){
      nameSel.disabled = on; nameNew.disabled = on; addNameBtn.disabled = on;
      lockBtn.textContent = on ? '🔓 変更' : '✔︎ ロック';
      lockState.textContent = on ? 'ロック中: ' + nameSel.value : '未ロック';
    }
    lockBtn.onclick = () => {
      const on = nameSel.disabled;
      if(on){ localStorage.removeItem('shift_name'); setLock(false); }
      else{
        const v = (nameSel.value || '').trim();
        if(!v){ alert('名前を選ぶか登録してください'); return; }
        localStorage.setItem('shift_name', v); setLock(true);
      }
    };

    // 名前登録・読み込み
    addNameBtn.onclick = () => {
      const nm = (nameNew.value || '').trim();
      if(!nm){ alert('名前を入力'); return; }
      ensureNameInSelect(nm,true); nameSel.value=nm; nameNew.value='';
      localStorage.setItem('shift_name', nm); setLock(true);
    };
    function ensureNameInSelect(nm, appendOnly){
      const exists = Array.from(nameSel.options).some(o=>o.value===nm);
      if(!exists && appendOnly){ nameSel.add(new Option(nm,nm)); }
    }
    async function bootstrapNames(){
      const { data, error } = await supa.from('shifts').select('staff_name').limit(1000);
      if(error){ console.warn(error); }
      const set = new Set((data||[]).map(r=>r.staff_name).filter(Boolean));
      nameSel.innerHTML='';
      Array.from(set).sort((a,b)=>a.localeCompare(b,'ja')).forEach(n=>nameSel.add(new Option(n,n)));
      loadLock();
    }

    // 時刻セレクト（30分刻み）
    function fillTimes(sel, startMin, endMin){
      sel.innerHTML='';
      for(let m=startMin; m<=endMin; m+=30){
        const hh = String(Math.floor(m/60)).padStart(2,'0');
        const mm = String(m%60).padStart(2,'0');
        sel.add(new Option(hh+':'+mm, hh+':'+mm));
      }
    }
    fillTimes(lStart, 600, 960); fillTimes(lEnd, 600, 960);       // ランチ 10:00–16:00
    fillTimes(dStart, 1020, 1440); fillTimes(dEnd, 1020, 1440);   // ディナー 17:00–24:00
    lStart.value="10:00"; lEnd.value="16:00"; dStart.value="17:00"; dEnd.value="24:00";

    // カレンダー
    let calYear, calMonth;
    function pad2(n){ return String(n).padStart(2,'0'); }
    function setToToday(){
      const t=new Date(); t.setHours(0,0,0,0);
      calYear=t.getFullYear(); calMonth=t.getMonth()+1;
      dateInp.value = t.getFullYear()+'-'+pad2(t.getMonth()+1)+'-'+pad2(t.getDate());
    }
    $('prevBtn').onclick=()=>{ changeMonth(-1); };
    $('nextBtn').onclick=()=>{ changeMonth(1); };
    $('thisBtn').onclick=()=>{ setToToday(); renderCalendar(); loadMonthMarkers(); };
    function changeMonth(delta){
      calMonth+=delta; if(calMonth===0){calMonth=12;calYear--;} if(calMonth===13){calMonth=1;calYear++;}
      const cur = new Date(dateInp.value|| (calYear+'-'+pad2(calMonth)+'-01'));
      if(cur.getFullYear()!==calYear || (cur.getMonth()+1)!==calMonth){
        dateInp.value = calYear+'-'+pad2(calMonth)+'-01';
      }
      renderCalendar(); loadMonthMarkers();
    }
    function renderCalendar(markers){
      markers = markers || {};
      $('ymLabel').textContent = calYear+'年'+calMonth+'月';
      const cal=$('cal'); cal.innerHTML='';
      ['日','月','火','水','木','金','土'].forEach(w=>{
        const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d);
      });
      const first = new Date(calYear, calMonth-1, 1);
      const startDow = first.getDay();
      const daysInMonth = new Date(calYear, calMonth, 0).getDate();
      const today = new Date(); const todayStr = today.getFullYear()+'-'+pad2(today.getMonth()+1)+'-'+pad2(today.getDate());
      const selStr = dateInp.value;

      for(let i=0;i<startDow;i++){ const e=document.createElement('div'); e.className='cell'; cal.appendChild(e); }
      for(let d=1; d<=daysInMonth; d++){
        const ds = calYear+'-'+pad2(calMonth)+'-'+pad2(d);
        const cell=document.createElement('div'); cell.className='cell';
        if(ds===todayStr) cell.classList.add('today');
        if(ds===selStr) cell.classList.add('selected');
        cell.onclick=()=>{ dateInp.value=ds; renderCalendar(markers); };
        const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
        const m=markers[ds]||{}; const box=document.createElement('div'); box.className='mark';
        if(m.l) box.innerHTML += '<span class="tag l">'+m.l+'</span>';
        if(m.d) box.innerHTML += '<span class="tag d">'+m.d+'</span>';
        cell.appendChild(box);
        cal.appendChild(cell);
      }
    }
    async function loadMonthMarkers(){
      const start = calYear+'-'+pad2(calMonth)+'-01';
      const end = new Date(start); end.setMonth(end.getMonth()+1);
      const endStr = end.toISOString().slice(0,10);
      const nm = nameSel.value || '';
      if(!nm){ renderCalendar(); return; }
      const { data, error } = await supa
        .from('shifts').select('date,start_time,end_time,staff_name')
        .eq('staff_name', nm).gte('date', start).lt('date', endStr);
      if(error){ console.warn(error); }
      const mk={};
      (data||[]).forEach(r=>{
        const v = (!r.start_time || !r.end_time) ? '◯' : r.start_time+'〜'+r.end_time;
        const isLunch = r.start_time && r.start_time < "16:00";
        const key = isLunch ? 'l' : 'd';
        if(!mk[r.date]) mk[r.date] = {};
        mk[r.date][key] = v;
      });
      renderCalendar(mk);
    }

    // 送信
    $('submitBtn').onclick = async () => {
      msg.textContent=''; msg.className='msg';
      const nm = nameSel.value || '';
      if(!nm){ alert('名前を選択（または登録）してロックしてください'); return; }
      if(!nameSel.disabled){ alert('「✔︎ ロック」で名前を確定してください'); return; }
      const dt = dateInp.value; if(!dt){ alert('日付を選んでください'); return; }

      const rows = [];
      if(lUse.checked){
        rows.push({ date: dt, staff_name: nm,
          start_time: lFree.checked ? null : lStart.value,
          end_time:   lFree.checked ? null : lEnd.value,
          note: memo.value || '' });
      }
      if(dUse.checked){
        rows.push({ date: dt, staff_name: nm,
          start_time: dFree.checked ? null : dStart.value,
          end_time:   dFree.checked ? null : dEnd.value,
          note: memo.value || '' });
      }
      if(rows.length===0){ alert('ランチかディナーを選んでください'); return; }

      const { error } = await supa.from('shifts').insert(rows);
      if(error){ msg.textContent='エラー: '+error.message; msg.classList.add('err'); return; }
      msg.textContent='送信しました ✔︎'; msg.classList.add('ok');
      memo.value=''; lFree.checked=false; dFree.checked=false;
      loadMonthMarkers(); loadRecent();
    };

    // 最新の提出（重複名なし）
    async function loadRecent(){
      const ul=$('recentList'); ul.innerHTML='<li class="note">読み込み中…</li>';
      const { data, error } = await supa
        .from('shifts').select('date,staff_name,created_at')
        .order('created_at',{ascending:false}).limit(200);
      if(error){ ul.innerHTML='<li class="note">エラー: '+error.message+'</li>'; return; }
      if(!data || data.length===0){ ul.innerHTML='<li class="note">まだ提出はありません</li>'; return; }
      const byDate = new Map();
      data.forEach(r=>{
        if(!r.date || !r.staff_name) return;
        if(!byDate.has(r.date)) byDate.set(r.date,new Set());
        byDate.get(r.date).add(r.staff_name);
      });
      const days = Array.from(byDate.keys()).sort((a,b)=> (a<b?1:-1)).slice(0,7);
      ul.innerHTML='';
      if(days.length===0){ ul.innerHTML='<li class="note">まだ提出はありません</li>'; return; }
      days.forEach(d=>{
        const names = Array.from(byDate.get(d));
        const li=document.createElement('li'); li.textContent = d+' ｜ '+names.join('、'); ul.appendChild(li);
      });
    }

    // 提出一覧へ
    $('toListBtn').onclick = () => {
      location.href = new URL('shiftlink.html', location.href).href;
    };

    // 初期化
    (async function init(){
      setToToday();
      renderCalendar();
      await bootstrapNames();
      loadRecent();
      loadMonthMarkers();
    })();
  </script>
</body>
</html>
