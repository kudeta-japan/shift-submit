<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KU-DETA シフト提出（Supabase / カレンダー版）</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--fg:#111827;--muted:#6b7280;--border:#e5e7eb;--bg:#fafafa;--pri:#111827;--ok:#0a8;--err:#d22}
    *{box-sizing:border-box}
    body{font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
         max-width:980px;margin:32px auto;padding:0 16px;background:var(--bg);color:var(--fg)}
    h1{font-size:1.6rem;margin:0 0 .5rem}
    h2{font-size:1.2rem;margin:24px 0 8px}
    label{display:block;margin:.6rem 0 .2rem;font-weight:600}
    input,select,button,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
    button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
    button:hover{opacity:.92}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .note{color:var(--muted);font-size:.9rem;margin-top:.35rem}
    .ok{color:var(--ok)} .err{color:var(--err)}
    fieldset{border:1px solid var(--border);border-radius:12px;margin-top:18px;padding:14px;background:#fff}
    legend{padding:0 6px;color:var(--muted)}
    .nav{margin-top:18px}
    .nav a{display:inline-block;margin-right:12px;text-decoration:none;color:var(--pri);font-weight:700}

    /* カレンダー */
    .cal-wrap{margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:12px}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .cal-title{font-weight:800}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .dow{font-weight:700;font-size:.9rem;color:#374151;padding:8px 0;text-align:center;background:#f7f7f7;border-bottom:1px solid var(--border)}
    .cell{min-height:84px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);padding:6px;position:relative}
    .cell:last-child{border-right:0}
    .cell .day{font-weight:700;font-size:.95rem}
    .cell .wday{font-size:.75rem;color:var(--muted);margin-left:4px}
    .muted{color:#9ca3af}
    .sun .day{color:#e11d48} /* 日曜：赤 */
    .sat .day{color:#2563eb} /* 土曜：青 */
    .clickable{cursor:pointer}
    .cell.selected{outline:2px solid #111827; outline-offset:-2px; border-radius:6px}
    .pill{position:absolute;bottom:6px;left:6px;right:6px;font-size:.75rem;color:#374151;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:4px 6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

    /* レイアウト微調整 */
    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:860px){ .two-col{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <h1>KU‑DETA シフト提出</h1>
  <p class="note">まずは名前を選ぶか、新規登録してください。日曜は左端の7列カレンダーで日付を選べます。</p>

  <!-- 名前選択 + 新規登録 + ロック -->
  <div class="row">
    <div style="flex:1;min-width:240px">
      <label>あなたの名前（登録済み）</label>
      <select id="nameSel"></select>
    </div>
    <div class="row" style="gap:6px">
      <div>
        <label>新規登録</label>
        <input id="newName" placeholder="例：久納 真希" />
      </div>
      <button id="addBtn">＋ 登録</button>
    </div>
    <div>
      <label>ロック</label>
      <button id="lockBtn">✔︎ ロック</button>
    </div>
  </div>
  <div id="nameMsg" class="note"></div>

  <div class="two-col">
    <!-- 左：カレンダー -->
    <section>
      <h2>カレンダー（日曜始まり 7列）</h2>
      <div class="cal-wrap">
        <div class="cal-head">
          <button id="prevMonth" title="前の月">‹</button>
          <div class="cal-title" id="calTitle">—</div>
          <button id="nextMonth" title="次の月">›</button>
        </div>
        <div class="cal-grid" id="calGrid">
          <!-- 曜日ヘッダ -->
          <div class="dow">日</div><div class="dow">月</div><div class="dow">火</div>
          <div class="dow">水</div><div class="dow">木</div><div class="dow">金</div><div class="dow">土</div>
          <!-- 日付セルはJSで生成 -->
        </div>
      </div>
    </section>

    <!-- 右：入力フォーム -->
    <section>
      <h2>この日のシフトを登録</h2>
      <form id="shiftForm">
        <label>日付（カレンダーでクリックでも可）</label>
        <input type="date" id="date" required />

        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>開始</label>
            <input type="time" id="start" required />
          </div>
          <div style="flex:1;min-width:160px">
            <label>終了</label>
            <input type="time" id="end" required />
          </div>
        </div>

        <label>備考（任意）</label>
        <textarea id="note" rows="2" placeholder="遅刻・早退・希望など"></textarea>

        <button type="submit" style="margin-top:12px">送信</button>
        <div id="msg" class="note"></div>
      </form>

      <div class="nav">
        <a href="./shiftlist.html">提出一覧を見る</a>
      </div>

      <h2>最新の提出</h2>
      <ul id="list"><li>読み込み中…</li></ul>
    </section>
  </div>

  <script>
    // ====== 自分の Supabase 情報に置換 ======
    const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
    // ========================================
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);

    // ==== 名前マスタ（staff） ====
    async function loadStaff(selected=null){
      const { data, error } = await client.from('staff').select('*').eq('include', true).order('name');
      if(error){ $('nameMsg').innerHTML = '<span class="err">読み込みエラー: '+error.message+'</span>'; return; }
      const sel = $('nameSel'); sel.innerHTML='';
      (data||[]).forEach(r=>{
        const opt = new Option(r.name, r.name);
        if(selected && selected===r.name) opt.selected=true;
        sel.add(opt);
      });
      if(!sel.value && data?.length) sel.value = data[0].name;

      // ロック復元
      const sv = localStorage.getItem('shiftName');
      if(sv && [...sel.options].some(o=>o.value===sv)){ sel.value=sv; toggleLock(true); }
    }
    $('addBtn').onclick = async ()=>{
      const nm = $('newName').value.trim();
      if(!nm){ alert('名前を入力'); return; }
      $('nameMsg').textContent='登録中…';
      const { error } = await client.from('staff').insert({ name: nm });
      if(error){
        $('nameMsg').innerHTML = '<span class="err">エラー: '+error.message+'</span>';
      }else{
        $('nameMsg').innerHTML = '<span class="ok">登録しました ✔︎</span>';
        $('newName').value='';
        await loadStaff(nm);
      }
    };
    function toggleLock(forceOn){
      const sel = $('nameSel');
      const on = forceOn ?? !sel.disabled;
      if(on){
        if(!sel.value){ alert('名前を選択'); return; }
        sel.disabled = true; sel.style.opacity=.6; $('lockBtn').textContent='🔓 変更';
        localStorage.setItem('shiftName', sel.value);
      }else{
        sel.disabled = false; sel.style.opacity=1; $('lockBtn').textContent='✔︎ ロック';
        localStorage.removeItem('shiftName');
      }
    }
    $('lockBtn').onclick = ()=>toggleLock();

    // ==== カレンダー ====
    const WDAY = ['日','月','火','水','木','金','土'];
    let calYear, calMonth; // 1-12
    function fmtYMD(y,m,d){
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    function rebuildCalendar(){
      const grid = $('calGrid');
      // 既存の日付セルを一掃（曜日ヘッダ7個は残す）
      while(grid.children.length > 7) grid.removeChild(grid.lastChild);

      const first = new Date(calYear, calMonth-1, 1);
      const last  = new Date(calYear, calMonth, 0);
      const days  = last.getDate();
      const startDow = first.getDay(); // 0=日

      $('calTitle').textContent = `${calYear}年 ${calMonth}月`;

      // 前に空白（日曜始まり調整）
      for(let i=0;i<startDow;i++){
        const div = document.createElement('div');
        div.className = 'cell muted';
        grid.appendChild(div);
      }

      // 当月セル
      const selected = $('date').value; // yyyy-mm-dd
      for(let d=1; d<=days; d++){
        const dow = new Date(calYear, calMonth-1, d).getDay();
        const div = document.createElement('div');
        div.className = 'cell clickable ' + (dow===0?'sun':dow===6?'sat':'');
        const ymd = fmtYMD(calYear,calMonth,d);
        div.innerHTML = `<div class="day">${d}</div><span class="wday">(${WDAY[dow]})</span>`;
        if(selected === ymd) div.classList.add('selected');

        div.addEventListener('click', ()=>{
          $('date').value = ymd;
          rebuildCalendar();
        });

        grid.appendChild(div);
      }

      // 後ろの空白で行を埋める
      const cells = grid.children.length;
      const rem = cells % 7;
      if(rem !== 0){
        for(let i=0;i<7-rem;i++){
          const div = document.createElement('div');
          div.className = 'cell muted';
          grid.appendChild(div);
        }
      }
    }
    function initCalendarFromToday(){
      const t = new Date();
      calYear = t.getFullYear();
      calMonth = t.getMonth()+1;
      $('date').value = fmtYMD(calYear, calMonth, t.getDate());
      rebuildCalendar();
    }
    $('prevMonth').onclick = ()=>{
      calMonth--; if(calMonth===0){ calMonth=12; calYear--; }
      rebuildCalendar();
    };
    $('nextMonth').onclick = ()=>{
      calMonth++; if(calMonth===13){ calMonth=1; calYear++; }
      rebuildCalendar();
    };
    $('date').addEventListener('change', ()=>{
      const [y,m] = $('date').value.split('-').map(Number);
      if(y && m){ calYear=y; calMonth=m; rebuildCalendar(); }
    });

    // ==== 送信 ====
    $('shiftForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const staff_name = $('nameSel').value;
      if(!staff_name){ alert('先に名前を選ぶか登録してください'); return; }
      $('msg').textContent='送信中…';

      const row = {
        staff_name,
        date: $('date').value,
        start_time: $('start').value,
        end_time: $('end').value,
        note: $('note').value.trim() || null
      };
      const { error } = await client.from('shifts').insert(row);
      if(error){ $('msg').innerHTML = '<span class="err">Error: '+error.message+'</span>'; return; }
      $('msg').innerHTML = '<span class="ok">送信しました ✔︎</span>';
      e.target.reset();

      // 送信後も選択日を維持：dateを今日に戻してから再セット
      const today = new Date(); $('date').value = fmtYMD(today.getFullYear(), today.getMonth()+1, today.getDate());
      rebuildCalendar();
      loadList();
    });

    // ==== 最新10件 ====
    async function loadList(){
      const { data, error } = await client
        .from('shifts')
        .select('*')
        .order('date', { ascending:false })
        .order('created_at', { ascending:false })
        .limit(10);
      if(error){ $('list').innerHTML = '<li class="err">読み込みエラー</li>'; return; }
      if(!data.length){ $('list').innerHTML = '<li>まだ提出はありません</li>'; return; }
      $('list').innerHTML = data.map(s =>
        `<li>${s.date} ｜ ${s.staff_name} ｜ ${s.start_time}〜${s.end_time} ${s.note? '（'+s.note+'）':''}</li>`
      ).join('');
    }

    // ==== 初期ロード ====
    loadStaff().then(()=>{
      initCalendarFromToday();
      loadList();
    });
  </script>
</body>
</html>
