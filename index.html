<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --bd:#e5e7eb; --bg:#fafafa; --card:#fff;
    --chip:#f3f4f6; --l:#fff4cc; --d:#ffe5d6; --ok:#16a34a; --warn:#f59e0b; --err:#b91c1c;
    --btn:#111827; --blue:#2563eb; --red:#ef4444; --green:#16a34a;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       background:var(--bg); color:var(--fg); max-width:1100px; margin:24px auto; padding:0 14px}
  h1{margin:0 0 .5rem; font-size:1.6rem}
  .note{color:var(--muted); font-size:.92rem}
  select,input,textarea,button{border:1px solid var(--bd); border-radius:10px; padding:9px 10px; font-size:15px; background:#fff}
  textarea{width:100%; resize:vertical}
  button{background:var(--btn); color:#fff; font-weight:700; border:none; cursor:pointer}
  button:hover{opacity:.95}
  .btn-blue{background:var(--blue)} .btn-red{background:var(--red)} .btn-green{background:var(--green)}
  .ghost{background:#fff; color:var(--fg)}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .card{background:var(--card); border:1px solid var(--bd); border-radius:14px; padding:14px; margin:12px 0}
  .pill{background:var(--chip); border:1px solid var(--bd); padding:6px 10px; border-radius:999px}
  .box{border:1px dashed var(--bd); border-radius:12px; padding:12px}
  .box.l{background:var(--l)} .box.d{background:var(--d)}
  .msg{margin-top:8px; font-weight:700} .ok{color:var(--ok)} .err{color:var(--err)}
  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
  .dow{font-weight:700; text-align:center; color:#374151}
  .cell{min-height:96px; background:#fff; border:1px solid var(--bd); border-radius:12px; position:relative; padding:6px; cursor:pointer}
  .cell.sel{outline:2px solid #111827}
  .day{position:absolute; top:6px; left:8px; font-weight:700; font-size:.9rem; color:#4b5563}
  .mark{position:absolute; left:6px; right:6px; bottom:6px; display:flex; flex-direction:column; gap:4px; font-size:.8rem}
  .tag{border:1px solid var(--bd); border-radius:8px; padding:2px 6px; display:inline-block; background:#fff}
  .tag.l{background:var(--l)} .tag.d{background:var(--d)}
  .tag.draft{background:#fef9c3; border-color:#fde047}
</style>
</head>
<body>
  <h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

  <!-- åå‰ãƒ­ãƒƒã‚¯è¡Œ -->
  <div class="card">
    <div class="row">
      <strong>ã‚ãªãŸã®åå‰</strong>
      <select id="nameSel" style="min-width:240px"></select>
      <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
      <span id="lockState" class="note"></span>
      <span class="note" style="margin-left:auto">åŠæœˆã”ã¨ã«æå‡ºï¼ç· åˆ‡ã¯ <b>15æ—¥ãƒ»æœˆæœ«</b>ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
    </div>
  </div>

  <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
        <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
        <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
      </div>
      <div class="row">
        <label class="note">æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠï¼‰</label>
        <input id="dateSel" type="date">
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div class="box l" style="flex:1 1 360px">
        <div class="row"><b>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</b> <span class="note">â€»ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼æ™‚é–“æœªå…¥åŠ›ã‹ã€Œâ—¯ã€ã§åˆ¤å®š</span></div>
        <div class="row">
          <label>é–‹å§‹ <select id="lStart"></select></label>
          <label>çµ‚äº† <select id="lEnd"></select></label>
          <label class="row note" style="margin-left:8px"><input type="checkbox" id="lFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
        </div>
      </div>
      <div class="box d" style="flex:1 1 360px">
        <div class="row"><b>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“23:30ï¼‰</b> <span class="note">â€»ãƒã‚§ãƒƒã‚¯ä¸è¦ï¼æ™‚é–“æœªå…¥åŠ›ã‹ã€Œâ—¯ã€ã§åˆ¤å®š</span></div>
        <div class="row">
          <label>é–‹å§‹ <select id="dStart"></select></label>
          <label>çµ‚äº† <select id="dEnd"></select></label>
          <label class="row note" style="margin-left:8px"><input type="checkbox" id="dFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
        </div>
      </div>
    </div>

    <label style="display:block; margin-top:10px">å‚™è€ƒï¼ˆä»»æ„ï¼‰
      <textarea id="memo" rows="2" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>
    </label>

    <div class="row" style="margin-top:10px">
      <button id="addBtn" class="btn-blue">è¿½åŠ /æ›´æ–°</button>
      <button id="delBtn" class="btn-red">å‰Šé™¤</button>
      <button id="sendBtn" class="btn-green">é€ä¿¡</button>
      <button id="toListBtn" class="ghost" style="margin-left:auto">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
    </div>

    <div id="msg" class="msg"></div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <div class="row note" style="margin-bottom:6px; gap:12px">
      <span class="pill">legendï¼š<span class="tag l">ãƒ©ãƒ³ãƒ</span> <span class="tag d">ãƒ‡ã‚£ãƒŠãƒ¼</span> ï¼ <span class="tag draft">ä¸‹æ›¸ãã‚ã‚Š</span> ï¼ ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼é¸æŠæ—¥</span>
    </div>
    <div id="cal" class="grid"></div>
  </div>

<script>
/* === Supabase æ¥ç¶šï¼ˆå·®ã—æ›¿ãˆï¼‰ === */
const SUPABASE_URL  = "https://wnttziqspjkrinymnodz.supabase.co";   // â†ã‚ãªãŸã®URL
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";                               // â†ã‚ãªãŸã®anon key
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

/* === è¦ç´  === */
const $=id=>document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateSel=$('dateSel'), lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree');
const dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree'), memo=$('memo'), msg=$('msg');

/* === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ === */
const pad2 = n => String(n).padStart(2,'0');
const toStr = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;

/* === æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆ 30åˆ†åˆ»ã¿ === */
function fillTimes(sel, startMin, endMin){
  sel.innerHTML = `<option value=""></option>`;
  for(let m=startMin; m<=endMin; m+=30){
    const hh = pad2(Math.floor(m/60)), mm = pad2(m%60);
    sel.add(new Option(`${hh}:${mm}`, `${hh}:${mm}`));
  }
}
// lunch 10:00â€“16:00 / dinner 17:00â€“23:30
fillTimes(lStart, 10*60, 16*60); fillTimes(lEnd, 10*60, 16*60);
fillTimes(dStart, 17*60, 23*60+30); fillTimes(dEnd, 17*60, 23*60+30);

/* === æœˆãƒ»æ—¥ä»˜çŠ¶æ…‹ === */
let y, m;           // è¡¨ç¤ºä¸­ã®å¹´ãƒ»æœˆ
let sentMarks = {}; // { 'YYYY-MM-DD': {l:'â—¯/æ™‚åˆ»', d:'â—¯/æ™‚åˆ»'} }
let drafts    = {}; // { 'YYYY-MM-DD': { l:{start,end,free}, d:{...}, memo } }

function setToday(){
  const t=new Date(); y=t.getFullYear(); m=t.getMonth()+1;
  dateSel.value = toStr(t);
}
$('prevBtn').onclick=()=>changeMonth(-1);
$('nextBtn').onclick=()=>changeMonth(1);
$('thisBtn').onclick=()=>{ setToday(); render(); loadMarks(); };

function changeMonth(delta){
  m+=delta; if(m===0){m=12;y--;} if(m===13){m=1;y++;}
  const cur = new Date(dateSel.value||`${y}-${pad2(m)}-01`);
  if(cur.getFullYear()!==y || cur.getMonth()+1!==m) dateSel.value=`${y}-${pad2(m)}-01`;
  render(); loadMarks();
}

/* === åå‰ãƒ­ãƒƒã‚¯ === */
function setLock(on){
  nameSel.disabled = on; lockBtn.textContent = on?'ğŸ”“ å¤‰æ›´':'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent = on?`ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}`:'æœªãƒ­ãƒƒã‚¯';
  if(on) localStorage.setItem('shift_name', nameSel.value);
  else   localStorage.removeItem('shift_name');
}
lockBtn.onclick = ()=>{
  if(nameSel.disabled){ setLock(false); }
  else {
    if(!nameSel.value){ alert('åå‰ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    setLock(true);
  }
};
async function loadNames(){
  // staffãƒã‚¹ã‚¿ï¼ˆinclude=true, ä¸¦ã³é †ï¼‰
  const { data, error } = await supa
    .from('staff')
    .select('name, display_order, include')
    .eq('include', true)
    .order('display_order', {ascending:true})
    .order('name', {ascending:true});
  nameSel.innerHTML='';
  (data||[]).forEach(r=>nameSel.add(new Option(r.name, r.name)));
  const saved = localStorage.getItem('shift_name');
  if(saved && Array.from(nameSel.options).some(o=>o.value===saved)){
    nameSel.value=saved; setLock(true);
  } else setLock(false);
}

/* === ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”» === */
function render(){
  const cal=$('cal'); cal.innerHTML='';
  // æ›œæ—¥
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{
    const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d);
  });
  const first = new Date(y, m-1, 1), days = new Date(y, m, 0).getDate();
  const startDow = first.getDay();
  const sel = dateSel.value;
  for(let i=0;i<startDow;i++){ const e=document.createElement('div'); e.className='cell'; cal.appendChild(e); }
  for(let d=1; d<=days; d++){
    const ds = `${y}-${pad2(m)}-${pad2(d)}`;
    const cell = document.createElement('div'); cell.className='cell';
    if(ds===sel) cell.classList.add('sel');
    cell.onclick=()=>{ dateSel.value=ds; writePanel(ds); render(); };
    const num = document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
    const mark = document.createElement('div'); mark.className='mark';
    const s = sentMarks[ds]||{};
    if(s.l) mark.innerHTML += `<span class="tag l">${s.l}</span>`;
    if(s.d) mark.innerHTML += `<span class="tag d">${s.d}</span>`;
    if(drafts[ds]){
      mark.innerHTML += `<span class="tag draft">ä¸‹æ›¸ã</span>`;
    }
    cell.appendChild(mark);
    cal.appendChild(cell);
  }
}

/* === å½“æœˆã®æå‡ºæ¸ˆã¿ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚¯ === */
async function loadMarks(){
  sentMarks = {};
  if(!nameSel.value){ render(); return; }
  const start = `${y}-${pad2(m)}-01`, end = new Date(start); end.setMonth(end.getMonth()+1);
  const endStr = toStr(end);
  const { data } = await supa
    .from('shifts')
    .select('date,start_time,end_time,staff_name')
    .eq('staff_name', nameSel.value)
    .gte('date', start).lt('date', endStr);
  (data||[]).forEach(r=>{
    const v = (!r.start_time || !r.end_time) ? 'â—¯' : `${r.start_time.slice(0,5)}ã€œ${r.end_time.slice(0,5)}`;
    const key = (r.start_time && r.end_time && r.start_time<"16:00") ? 'l' : ((r.start_time==null && r.end_time==null) ? 'l' : 'd');
    sentMarks[r.date] ||= {};
    // æ—¢ã« l/d ãŒå…¥ã£ã¦ã„ãŸã‚‰ä½µè¨˜
    sentMarks[r.date][key] = sentMarks[r.date][key] ? `${sentMarks[r.date][key]} / ${v}` : v;
  });
  render();
}

/* === ãƒ‘ãƒãƒ«ã¸åæ˜  / ä¸‹æ›¸ãä¿å­˜ === */
function writePanel(ds){
  const key = ds || dateSel.value;
  const d = drafts[key];
  // åˆæœŸåŒ–
  lStart.value=''; lEnd.value=''; lFree.checked=false;
  dStart.value=''; dEnd.value=''; dFree.checked=false;
  memo.value='';
  if(!d) return;
  if(d.l){ lStart.value=d.l.start||''; lEnd.value=d.l.end||''; lFree.checked=!!d.l.free; }
  if(d.d){ dStart.value=d.d.start||''; dEnd.value=d.d.end||''; dFree.checked=!!d.d.free; }
  memo.value=d.memo||'';
}

function readPanel(){
  const r = {};
  if(lFree.checked || lStart.value || lEnd.value) r.l = {start:lFree.checked?'':lStart.value, end:lFree.checked?'':lEnd.value, free:!!lFree.checked};
  if(dFree.checked || dStart.value || dEnd.value) r.d = {start:dFree.checked?'':dStart.value, end:dFree.checked?'':dEnd.value, free:!!dFree.checked};
  r.memo = memo.value||'';
  return r;
}

/* === è¿½åŠ /æ›´æ–°ï¼ˆä¸‹æ›¸ãï¼‰ === */
$('addBtn').onclick = ()=>{
  msg.textContent=''; msg.className='msg';
  const ds = dateSel.value;
  if(!ds){ alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  const v = readPanel();
  // ã©ã¡ã‚‰ã‚‚æŒ‡å®šç„¡ã—ãªã‚‰ä¸‹æ›¸ãæ¶ˆå»æ‰±ã„
  if(!v.l && !v.d && !v.memo){ delete drafts[ds]; saveDraftMarks(); render(); writePanel(null); msg.textContent=`ä¸‹æ›¸ãå‰Šé™¤ï¼š${ds}`; return; }
  // æ™‚é–“æ•´åˆãƒã‚§ãƒƒã‚¯
  const ok = (o)=> !o || o.free || (!o.start || !o.end || o.start <= o.end);
  if(!ok(v.l) || !ok(v.d)){ msg.textContent='æ™‚é–“ã®å‰å¾Œé–¢ä¿‚ã‚’ç¢ºèªã—ã¦ãã ã•ã„'; msg.className='msg err'; return; }
  drafts[ds] = v;
  saveDraftMarks(); render();
  msg.textContent = `ä¸‹æ›¸ãã‚’æ›´æ–°ï¼š${ds}`; msg.className='msg ok';
};

/* === å‰Šé™¤ï¼ˆä¿®æ­£æ¸ˆã¿ï¼šãƒ­ãƒƒã‚¯ä¸­ã§ã‚‚æå‡ºæ¸ˆã¿ã‚’å‰Šé™¤ï¼‰ === */
$('delBtn').onclick = async ()=>{
  const ds = dateSel.value;
  if(!ds) return;

  // ä¸‹æ›¸ããŒã‚ã‚Œã°å…ˆã«ä¸‹æ›¸ãå‰Šé™¤
  if(drafts[ds]){
    delete drafts[ds];
    saveDraftMarks(); render(); writePanel(null);
    msg.textContent=`ä¸‹æ›¸ãã‚’å‰Šé™¤ï¼š${ds}`; msg.className='msg';
    return;
  }
  // æå‡ºæ¸ˆã¿å‰Šé™¤
  if(!nameSel.value){ alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if(!nameSel.disabled){ alert('åå‰ã‚’ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  if(!confirm(`${ds} ã®æå‡ºæ¸ˆã¿ï¼ˆãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ï¼‰ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

  const { error } = await supa
    .from('shifts')
    .delete()
    .eq('staff_name', nameSel.value)
    .eq('date', ds);

  if(error){ msg.textContent='å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š'+error.message; msg.className='msg err'; return; }
  delete sentMarks[ds];
  render();
  msg.textContent=`æå‡ºæ¸ˆã¿ã‚’å‰Šé™¤ï¼š${ds}`; msg.className='msg ok';
};

/* === é€ä¿¡ï¼ˆä¸‹æ›¸ãã‚’ä¸€æ‹¬ï¼‰ === */
$('sendBtn').onclick = async ()=>{
  msg.textContent=''; msg.className='msg';
  if(!nameSel.value){ alert('åå‰ã‚’é¸ã‚“ã§ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  if(!nameSel.disabled){ alert('ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„'); return; }
  const rows=[];
  for(const [ds, v] of Object.entries(drafts)){
    if(v.l){
      if(!v.l.free && v.l.start && v.l.end && v.l.start>v.l.end){ msg.textContent=`${ds} ãƒ©ãƒ³ãƒæ™‚åˆ»ãŒä¸æ­£`; msg.className='msg err'; return; }
      rows.push({date:ds, staff_name:nameSel.value, start_time:v.l.free?null:(v.l.start||null), end_time:v.l.free?null:(v.l.end||null), note:v.memo||''});
    }
    if(v.d){
      if(!v.d.free && v.d.start && v.d.end && v.d.start>v.d.end){ msg.textContent=`${ds} ãƒ‡ã‚£ãƒŠãƒ¼æ™‚åˆ»ãŒä¸æ­£`; msg.className='msg err'; return; }
      rows.push({date:ds, staff_name:nameSel.value, start_time:v.d.free?null:(v.d.start||null), end_time:v.d.free?null:(v.d.end||null), note:v.memo||''});
    }
  }
  if(rows.length===0){ msg.textContent='é€ä¿¡ã™ã‚‹ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“'; return; }

  const { error } = await supa.from('shifts').insert(rows);
  if(error){ msg.textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+error.message; msg.className='msg err'; return; }

  // æˆåŠŸï¼šä¸‹æ›¸ãã‚¯ãƒªã‚¢ & å†èª­ã¿è¾¼ã¿
  drafts={}; saveDraftMarks(); await loadMarks();
  msg.textContent=`é€ä¿¡ã—ã¾ã—ãŸï¼ˆ${rows.length}ä»¶ï¼‰`; msg.className='msg ok';
};

/* === ä¸‹æ›¸ãã®å¯è¦–ãƒãƒ¼ã‚¯ä¿å­˜ï¼ˆå†…éƒ¨ã®ã¿ï¼‰ === */
function saveDraftMarks(){
  // sentMarks ã¯æå‡ºæ¸ˆã¿ã€drafts ã¯ã€Œä¸‹æ›¸ãã‚ã‚Šã€ã‚¿ã‚°è¡¨ç¤ºã«ä½¿ç”¨
}

/* === æå‡ºä¸€è¦§ã¸ === */
$('toListBtn').onclick = ()=>{ location.href = new URL('shiftlink.html', location.href).href; };

/* === åˆæœŸåŒ– === */
(async function init(){
  setToday(); render();
  await loadNames();
  await loadMarks();
  writePanel(null);
})();
</script>
</body>
</html>
