<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827; --muted:#6b7280; --bd:#e5e7eb; --bg:#fafafa; --card:#ffffff;
    --btn:#111827; --ok:#16a34a; --warn:#f59e0b; --lunch:#fff9db; --dinner:#ffe7d6;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .note{color:var(--muted);font-size:.92rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  textarea{width:100%}
  button{background:var(--btn);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  button:hover{opacity:.94}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  .right{margin-left:auto}
  .small{font-size:.88rem}
  .msg{margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .err{color:#b91c1c}
  .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
  /* å…¥åŠ›ãƒ‘ãƒãƒ« */
  .box{border:1px dashed var(--bd);border-radius:12px;padding:12px}
  .box.l{background:var(--lunch)} .box.d{background:var(--dinner)}
  /* calendar */
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-weight:700;text-align:center;color:#374151}
  .cell{border:1px solid var(--bd);border-radius:10px;min-height:90px;background:#fff;padding:6px;position:relative}
  .day{position:absolute;top:6px;left:8px;font-weight:700;font-size:.92rem;color:#4b5563}
  .mark{position:absolute;bottom:6px;left:6px;right:6px;font-size:.8rem;display:flex;flex-direction:column;gap:3px}
  .tag{display:inline-block;border-radius:6px;padding:2px 6px;font-size:.8rem;border:1px solid var(--bd)}
  .tag.l{background:#fff9db} .tag.d{background:#ffe7d6}
  .today{outline:2px solid var(--warn)}
  .selected{outline:2px solid var(--btn)}
</style>
</head>
<body>
  <h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

  <!-- ä¸Šéƒ¨ï¼šåå‰ãƒ»ãƒ­ãƒƒã‚¯ -->
  <div class="card">
    <div class="row">
      <strong>ã‚ãªãŸã®åå‰</strong>
      <select id="nameSel" style="min-width:240px"></select>
      <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
      <span id="lockState" class="note"></span>
      <span class="right note small">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯ <strong>15æ—¥ãƒ»æœˆæœ«</strong>ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
    </div>
  </div>

  <!-- å…¥åŠ›ãƒ‘ãƒãƒ« -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
        <span id="ymLabel" class="pill">YYYYå¹´Mæœˆ</span>
        <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
        <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
      </div>
      <div class="row">
        <label class="note">æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠï¼‰</label>
        <input id="dateInp" type="date">
      </div>
    </div>

    <div class="row">
      <div class="box l" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</strong></div>
        <div class="row">
          <label>é–‹å§‹<select id="lStart"></select></label>
          <label>çµ‚äº†<select id="lEnd"></select></label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="lFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
          </label>
        </div>
      </div>
      <div class="box d" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“24:00ï¼‰</strong></div>
        <div class="row">
          <label>é–‹å§‹<select id="dStart"></select></label>
          <label>çµ‚äº†<select id="dEnd"></select></label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="dFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
          </label>
        </div>
      </div>
    </div>

    <label class="row" style="margin-top:8px;gap:12px">
      <span style="min-width:60px">å‚™è€ƒ</span>
      <textarea id="memo" rows="2" placeholder="é€£çµ¡äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›"></textarea>
    </label>

    <div class="row" style="margin-top:8px">
      <button id="addDraftBtn">è¿½åŠ /æ›´æ–°</button>
      <button id="deleteBtn" class="ghost" style="margin-left:4px">å‰Šé™¤</button>
      <button id="sendBtn" style="margin-left:4px">é€ä¿¡</button>
      <button id="toListBtn" class="ghost right">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
    </div>
    <div id="msg" class="msg"></div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <div class="row small" style="justify-content:space-between;align-items:center;margin-bottom:8px">
      <span class="pill">legendï¼š<span class="tag l">ãƒ©ãƒ³ãƒ</span> <span class="tag d">ãƒ‡ã‚£ãƒŠãƒ¼</span> ï¼ ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼é¸æŠæ—¥</span>
    </div>
    <div id="cal" class="grid"></div>
  </div>

<script>
/* ===== Supabase æ¥ç¶š ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== è¦ç´  ===== */
const $ = id => document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateInp=$('dateInp'), lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree'), dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree'), memo=$('memo');
const msg=$('msg');

/* ===== æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆï¼š30åˆ†åˆ»ã¿ ===== */
function fillTimes(sel, startMin, endMin){
  sel.innerHTML='';
  for(let m=startMin; m<=endMin; m+=30){
    const hh = String(Math.floor(m/60)).padStart(2,'0');
    const mm = String(m%60).padStart(2,'0');
    sel.add(new Option(`${hh}:${mm}`, `${hh}:${mm}`));
  }
}
// ãƒ©ãƒ³ãƒ 10:00â€“16:00 / ãƒ‡ã‚£ãƒŠãƒ¼ 17:00â€“24:00
fillTimes(lStart, 600, 960); fillTimes(lEnd, 600, 960);
fillTimes(dStart, 1020, 1440); fillTimes(dEnd, 1020, 1440);
lStart.value="10:00"; lEnd.value="16:00"; dStart.value="17:00"; dEnd.value="24:00";

/* ===== åå‰ãƒ»ãƒ­ãƒƒã‚¯ ===== */
async function loadNames(){
  const { data, error } = await supa.from('staff').select('name').eq('include', true).order('display_order',{ascending:true}).order('name',{ascending:true});
  nameSel.innerHTML='';
  (data||[]).forEach(r=>nameSel.add(new Option(r.name, r.name)));
  // ãƒ­ãƒƒã‚¯å¾©å…ƒ
  const nm = localStorage.getItem('shift_name') || '';
  if(nm && Array.from(nameSel.options).some(o=>o.value===nm)){
    nameSel.value = nm; setLock(true);
  }else{
    setLock(false);
  }
}
function setLock(on){
  nameSel.disabled = on;
  lockBtn.textContent = on ? 'ğŸ”“ å¤‰æ›´' : 'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent = on ? `ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}` : 'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick = ()=>{
  const on = nameSel.disabled;
  if(on){
    localStorage.removeItem('shift_name');
    setLock(false);
  }else{
    const v=(nameSel.value||'').trim();
    if(!v){ alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    localStorage.setItem('shift_name', v);
    setLock(true);
    // åå‰ãŒç¢ºå®šã—ãŸã‚‰å†æç”»
    loadMonthMarkers();
  }
};

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
let calYear, calMonth;
const pad2 = n => String(n).padStart(2,'0');
function setToToday(){
  const t=new Date(); t.setHours(0,0,0,0);
  calYear=t.getFullYear(); calMonth=t.getMonth()+1;
  if(!dateInp.value){ dateInp.value = `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`; }
}
$('prevBtn').onclick=()=>{changeMonth(-1);};
$('nextBtn').onclick=()=>{changeMonth(1);};
$('thisBtn').onclick=()=>{setToToday(); renderCalendar(); loadMonthMarkers();};
function changeMonth(delta){
  calMonth+=delta; if(calMonth===0){calMonth=12;calYear--;} if(calMonth===13){calMonth=1;calYear++;}
  renderCalendar(); loadMonthMarkers();
}

function renderCalendar(markers={}){
  $('ymLabel').textContent = `${calYear}å¹´${calMonth}æœˆ`;
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{ const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d); });
  const first = new Date(calYear, calMonth-1, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(calYear, calMonth, 0).getDate();
  const todayStr = (d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`)(new Date());

  for(let i=0;i<startDow;i++){ const e=document.createElement('div'); e.className='cell'; cal.appendChild(e); }
  for(let d=1; d<=daysInMonth; d++){
    const ds = `${calYear}-${pad2(calMonth)}-${pad2(d)}`;
    const cell=document.createElement('div'); cell.className='cell';
    if(ds===todayStr) cell.classList.add('today');
    if(ds===dateInp.value) cell.classList.add('selected');
    const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
    const m=markers[ds]||{};
    const box=document.createElement('div'); box.className='mark';
    if(m.l) box.innerHTML += `<span class="tag l">${m.l}</span>`;
    if(m.d) box.innerHTML += `<span class="tag d">${m.d}</span>`;
    cell.appendChild(box);
    cell.onclick=()=>{ dateInp.value=ds; document.querySelectorAll('#cal .cell').forEach(c=>c.classList.remove('selected')); cell.classList.add('selected'); };
    cal.appendChild(cell);
  }
}

/* ===== ä¸‹æ›¸ãï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ï¼‰ ===== */
// DRAFTS: { 'YYYY-MM-DD': { l:'â—¯ or 10:00ã€œ16:00', d:'â—¯ or 17:00ã€œ24:00', note:'...' } }
const DRAFTS = {};

function timesToText(isFree, s, e){
  if(isFree) return 'â—¯';
  if(!s || !e) return '';
  return `${s}ã€œ${e}`;
}
function textToTimes(txt){
  if(!txt) return {free:false,start:null,end:null};
  if(txt==='â—¯') return {free:true,start:null,end:null};
  const [s,e]=txt.split('ã€œ'); return {free:false,start:s,end:e};
}

/* ===== è¿½åŠ /æ›´æ–°ï¼ˆä¸‹æ›¸ãã«å…¥ã‚Œã‚‹ã ã‘ï¼‰ ===== */
$('addDraftBtn').onclick = ()=>{
  msg.textContent=''; msg.className='msg';
  const nm = (nameSel.value||'').trim();
  if(!nm || !nameSel.disabled){ alert('åå‰ã‚’é¸æŠã—ã¦ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã—ã¦ãã ã•ã„'); return; }
  const dt = dateInp.value; if(!dt){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }

  const lTxt = timesToText(lFree.checked, lStart.value, lEnd.value);
  const dTxt = timesToText(dFree.checked, dStart.value, dEnd.value);
  if(!lTxt && !dTxt){ alert('ãƒ©ãƒ³ãƒã¾ãŸã¯ãƒ‡ã‚£ãƒŠãƒ¼ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆæ™‚é–“æŒ‡å®šãªã— â—¯ ã§ã‚‚å¯ï¼‰'); return; }

  DRAFTS[dt] = { l: lTxt || '', d: dTxt || '', note: memo.value||'' };
  msg.textContent = `${dt} ã‚’ä¸‹æ›¸ãã«è¿½åŠ /æ›´æ–°ã—ã¾ã—ãŸ`; msg.classList.add('ok');
  loadMonthMarkers();
};

/* ===== å‰Šé™¤ï¼šä¸‹æ›¸ãå‰Šé™¤ï¼‹é€ä¿¡æ¸ˆã¿ã‚‚å‰Šé™¤ï¼ˆç¢ºèªã‚ã‚Šï¼‰ ===== */
$('deleteBtn').onclick = async ()=>{
  msg.textContent=''; msg.className='msg';
  const nm = (nameSel.value||'').trim();
  const dt = dateInp.value;
  if(!nm || !dt){ alert('åå‰ã¨æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
  if(!confirm(`${dt} ã®ä¸‹æ›¸ãã¨é€ä¿¡æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) return;

  delete DRAFTS[dt];
  const { error } = await supa.from('shifts').delete().eq('staff_name', nm).eq('date', dt);
  if(error){ msg.textContent='å‰Šé™¤ã‚¨ãƒ©ãƒ¼ï¼š'+error.message; msg.classList.add('err'); return; }
  msg.textContent='å‰Šé™¤ã—ã¾ã—ãŸ'; msg.classList.add('ok');
  loadMonthMarkers();
};

/* ===== é€ä¿¡ï¼šå…¨ä¸‹æ›¸ãã‚’ã¾ã¨ã‚ã¦ç¢ºå®š ===== */
$('sendBtn').onclick = async ()=>{
  msg.textContent=''; msg.className='msg';
  const nm = (nameSel.value||'').trim();
  if(!nm || !nameSel.disabled){ alert('åå‰ã‚’é¸æŠã—ã¦ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã—ã¦ãã ã•ã„'); return; }
  const dates = Object.keys(DRAFTS);
  if(dates.length===0){ alert('ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“'); return; }

  // 1) é€ä¿¡å¯¾è±¡æ—¥ã®æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ â†’ 2) ä¸‹æ›¸ãã‹ã‚‰æŒ¿å…¥
  try{
    for(const dt of dates){
      const note = DRAFTS[dt].note || '';
      // æ—¢å­˜å‰Šé™¤
      const del = await supa.from('shifts').delete().eq('staff_name', nm).eq('date', dt);
      if(del.error) throw del.error;

      const rows = [];
      const {l,d} = DRAFTS[dt];

      if(l){
        const tt = textToTimes(l);
        rows.push({ date: dt, staff_name: nm, start_time: tt.start, end_time: tt.end, note });
      }
      if(d){
        const tt = textToTimes(d);
        rows.push({ date: dt, staff_name: nm, start_time: tt.start, end_time: tt.end, note });
      }
      if(rows.length){
        const ins = await supa.from('shifts').insert(rows);
        if(ins.error) throw ins.error;
      }
    }
    // é€ä¿¡å®Œäº†
    for(const k of Object.keys(DRAFTS)) delete DRAFTS[k];
    msg.textContent='é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸'; msg.classList.add('ok');
    loadMonthMarkers();
  }catch(e){
    msg.textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+(e?.message||e); msg.classList.add('err');
  }
};

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ãƒãƒ¼ã‚«ãƒ¼èª­è¾¼ï¼ˆé€ä¿¡æ¸ˆã¿ + ä¸‹æ›¸ãï¼‰ ===== */
async function loadMonthMarkers(){
  const start = `${calYear}-${pad2(calMonth)}-01`;
  const end = new Date(start); end.setMonth(end.getMonth()+1);
  const endStr = end.toISOString().slice(0,10);
  const nm = nameSel.value||'';
  const mk = {};

  if(nm){
    const { data } = await supa
      .from('shifts')
      .select('date,start_time,end_time')
      .eq('staff_name', nm)
      .gte('date', start).lt('date', endStr);

    (data||[]).forEach(r=>{
      const v = (!r.start_time || !r.end_time) ? 'â—¯' : `${r.start_time.slice(0,5)}ã€œ${r.end_time.slice(0,5)}`;
      const isLunch = !r.start_time || r.start_time < '16:00';
      mk[r.date] ||= {};
      mk[r.date][isLunch?'l':'d'] = v;
    });
  }
  // ä¸‹æ›¸ãä¸Šæ›¸ã
  Object.entries(DRAFTS).forEach(([ds,info])=>{
    mk[ds] ||= {};
    if(info.l) mk[ds].l = info.l;
    if(info.d) mk[ds].d = info.d;
  });

  renderCalendar(mk);
}

/* ===== ä¸€è¦§ã¸ ===== */
$('toListBtn').onclick = ()=>{ location.href = new URL('shiftlink.html', location.href).href; };

/* ===== åˆæœŸåŒ– ===== */
(async function init(){
  setToToday();
  renderCalendar();         // ç©ºã§æç”»ã—ã¦ãŠã
  await loadNames();
  await loadMonthMarkers();
})();
</script>
</body>
</html>
