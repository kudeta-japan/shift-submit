<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#fafafa;--card:#fff;
    --btn:#111827;--ok:#16a34a;--warn:#f59e0b;--lunch:#fff9db;--dinner:#ffe7d6;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1100px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .note{color:var(--muted);font-size:.92rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:var(--btn);color:#fff;font-weight:700;border:none;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  button:hover{opacity:.94}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:14px;padding:14px;margin:12px 0}
  .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
  .small{font-size:.88rem}
  .ok{color:var(--ok);font-weight:700}
  .err{color:#b91c1c;font-weight:700}
  .right{margin-left:auto}

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-weight:700;text-align:center;color:#374151}
  .cell{border:1px solid var(--bd);border-radius:12px;min-height:86px;background:#fff;padding:6px;position:relative;cursor:pointer}
  .day{position:absolute;top:6px;left:8px;font-weight:700;font-size:.92rem;color:#4b5563}
  .mark{position:absolute;bottom:6px;left:6px;right:6px;font-size:.78rem;display:flex;flex-direction:column;gap:2px}
  .tag{display:inline-block;border-radius:6px;padding:2px 6px;font-size:.78rem;border:1px solid var(--bd)}
  .tag.l{background:var(--lunch)} .tag.d{background:var(--dinner)} .tag.draft{outline:2px dashed #9ca3af}
  .today{outline:2px solid var(--warn)}
  .selected{outline:2px solid var(--btn)}

  /* ç·¨é›†é ˜åŸŸ */
  .box{border:1px dashed var(--bd);border-radius:12px;padding:12px}
  .box.l{background:var(--lunch)} .box.d{background:var(--dinner)}

  /* ä¸‹æ›¸ãä¸€è¦§ */
  .draft{border:1px solid var(--bd);border-radius:12px;padding:10px;background:#fff}
  .draft h4{margin:0 0 6px 0;font-size:1rem}
  .chip{display:inline-block;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;font-size:.8rem;margin-right:6px}
  .chip.l{background:var(--lunch)} .chip.d{background:var(--dinner)}
</style>
</head>
<body>
  <h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

  <!-- ä¸Šéƒ¨ï¼šåå‰ãƒ­ãƒƒã‚¯ & èª¬æ˜ -->
  <div class="card">
    <div class="row">
      <strong>ã‚ãªãŸã®åå‰</strong>
      <select id="nameSel" style="min-width:240px"></select>
      <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
      <span id="lockState" class="note"></span>
      <span class="right note small">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯ <b>15æ—¥ãƒ»æœˆæœ«</b>ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
    </div>
  </div>

  <!-- å…¥åŠ›ãƒ‘ãƒãƒ«ï¼ˆ1æ—¥ã¶ã‚“ â†’ ä¸‹æ›¸ãã«è¿½åŠ /æ›´æ–°ï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
        <div class="pill"><span id="ymLabel">YYYYå¹´Mæœˆ</span></div>
        <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
        <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
      </div>
      <div class="row">
        <label class="note">æ—¥ä»˜ï¼š</label>
        <input id="dateInp" type="date">
        <button id="addDraftBtn">ã“ã®æ—¥ã‚’ä¸‹æ›¸ãã«è¿½åŠ /æ›´æ–°</button>
        <button id="delDraftBtn" class="ghost">ã“ã®æ—¥ã‚’ä¸‹æ›¸ãã‹ã‚‰å‰Šé™¤</button>
        <button id="submitAllBtn">ğŸ“¨ ä¸‹æ›¸ãã‚’ã¾ã¨ã‚ã¦é€ä¿¡</button>
      </div>
    </div>

    <div class="row">
      <!-- ãƒ©ãƒ³ãƒ -->
      <div class="box l" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</strong></div>
        <div class="row">
          <label>é–‹å§‹
            <select id="lStart"></select>
          </label>
          <label>çµ‚äº†
            <select id="lEnd"></select>
          </label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="lFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
          </label>
        </div>
      </div>
      <!-- ãƒ‡ã‚£ãƒŠãƒ¼ -->
      <div class="box d" style="flex:1 1 360px">
        <div class="row"><strong>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“24:00ï¼‰</strong></div>
        <div class="row">
          <label>é–‹å§‹
            <select id="dStart"></select>
          </label>
          <label>çµ‚äº†
            <select id="dEnd"></select>
          </label>
          <label class="small" style="display:flex;align-items:center;gap:6px">
            <input type="checkbox" id="dFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰
          </label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <label style="flex:1">å‚™è€ƒï¼ˆä»»æ„ï¼‰
        <textarea id="memo" rows="2" style="width:100%" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>
      </label>
    </div>

    <div id="msg" class="note">æº–å‚™ä¸­â€¦</div>
  </div>

  <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
  <div class="card">
    <div class="row small note" style="margin-bottom:8px">
      <span class="pill"> legendï¼š<span class="tag l">ãƒ©ãƒ³ãƒ</span> <span class="tag d">ãƒ‡ã‚£ãƒŠãƒ¼</span> ï¼ <span class="tag draft">ä¸‹æ›¸ãã‚ã‚Š</span> ï¼ ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼é¸æŠæ—¥</span>
      <button id="toListBtn" class="right ghost">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
      <button id="toAdminBtn" class="ghost" style="margin-left:8px">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
    </div>
    <div id="cal" class="grid"></div>
  </div>

  <!-- ä¸‹æ›¸ãä¸€è¦§ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>ä¸‹æ›¸ãä¸€è¦§</strong>
      <div class="row">
        <button id="clearAllBtn" class="ghost">ã™ã¹ã¦è§£é™¤</button>
        <button id="submitAllBtn2">ğŸ“¨ ã¾ã¨ã‚ã¦é€ä¿¡</button>
      </div>
    </div>
    <div id="draftList" class="note">ã¾ã ä¸‹æ›¸ãã¯ã‚ã‚Šã¾ã›ã‚“</div>
  </div>

  <!-- æœ€æ–°ã®æå‡ºï¼ˆé‡è¤‡åãªã—ãƒ»æ—¥ä»˜ï¼‹åå‰ã®ã¿ï¼‰ -->
  <div class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong>æœ€æ–°ã®æå‡º</strong>
    </div>
    <ul id="recentList"><li class="note">èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
  </div>

<script>
/* ===== Supabase æ¥ç¶š ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";      // â†ã‚ãªãŸã®URL
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";                              // â†ã‚ãªãŸã® anon key
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== è¦ç´  ===== */
const $ = id => document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const lStart=$('lStart'), lEnd=$('lEnd'), lFree=$('lFree');
const dStart=$('dStart'), dEnd=$('dEnd'), dFree=$('dFree');
const memo=$('memo'), dateInp=$('dateInp'), msg=$('msg');

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const pad2 = n => String(n).padStart(2,'0');
const fmtDate = d => `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
const todayStr = fmtDate(new Date());

/* ===== æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆï¼š30åˆ†åˆ»ã¿ ===== */
function fillTimes(sel, startMin, endMin){
  sel.innerHTML = '';
  for(let m=startMin; m<=endMin; m+=30){
    const hh = pad2(Math.floor(m/60)), mm = pad2(m%60);
    sel.add(new Option(`${hh}:${mm}`, `${hh}:${mm}`));
  }
}
fillTimes(lStart, 600, 960); fillTimes(lEnd, 600, 960);       // 10:00â€“16:00
fillTimes(dStart, 1020, 1440); fillTimes(dEnd, 1020, 1440);   // 17:00â€“24:00
lStart.value="10:00"; lEnd.value="16:00"; dStart.value="17:00"; dEnd.value="24:00";

/* ===== åå‰ãƒ­ãƒƒã‚¯ ===== */
function setLock(on){
  nameSel.disabled = on;
  lockBtn.textContent = on ? 'ğŸ”“ å¤‰æ›´' : 'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent = on ? `ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}` : 'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick = () => {
  const on = nameSel.disabled;
  if(on){ localStorage.removeItem('shift_name'); setLock(false); }
  else{
    const v = nameSel.value || '';
    if(!v){ alert('åå‰ã‚’é¸æŠã—ã¦ãã ã•ã„'); return; }
    localStorage.setItem('shift_name', v); setLock(true); loadMonthMarkers(); loadRecent();
  }
};

/* ===== ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ãƒ­ãƒ¼ãƒ‰ï¼ˆis_active ã®ã¿ï¼‰ ===== */
async function loadStaff(){
  msg.textContent = 'ã‚¹ã‚¿ãƒƒãƒ•åã‚’èª­ã¿è¾¼ã¿ä¸­â€¦';
  const { data, error } = await supa
    .from('staff')
    .select('name,display_order,is_active')
    .eq('is_active', true)
    .order('display_order', {ascending:true})
    .order('name', {ascending:true});
  if(error){ msg.textContent='ã‚¨ãƒ©ãƒ¼: '+error.message; msg.className='err'; return; }

  nameSel.innerHTML='';
  (data||[]).forEach(r => nameSel.add(new Option(r.name, r.name)));

  const saved = localStorage.getItem('shift_name');
  if(saved && Array.from(nameSel.options).some(o=>o.value===saved)){
    nameSel.value=saved; setLock(true);
  }else{ setLock(false); }
  msg.textContent = `å€™è£œ ${data?.length||0} åã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`; msg.className='ok';
}

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
let calYear, calMonth;
function setToToday(){
  const t=new Date(); t.setHours(0,0,0,0);
  calYear=t.getFullYear(); calMonth=t.getMonth()+1;
  dateInp.value = fmtDate(t);
}
$('prevBtn').onclick = ()=>changeMonth(-1);
$('nextBtn').onclick = ()=>changeMonth(+1);
$('thisBtn').onclick = ()=>{ setToToday(); renderCalendar(); loadMonthMarkers(); };
function changeMonth(delta){
  calMonth+=delta; if(calMonth===0){calMonth=12;calYear--;} if(calMonth===13){calMonth=1;calYear++;}
  const cur = new Date(dateInp.value||`${calYear}-${pad2(calMonth)}-01`);
  if(cur.getFullYear()!==calYear || (cur.getMonth()+1)!==calMonth){
    dateInp.value = `${calYear}-${pad2(calMonth)}-01`;
  }
  renderCalendar(); loadMonthMarkers();
}
function renderCalendar(markers={}){
  $('ymLabel').textContent = `${calYear}å¹´${calMonth}æœˆ`;
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{
    const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d);
  });

  const first = new Date(calYear, calMonth-1, 1);
  const startDow = first.getDay();
  const daysInMonth = new Date(calYear, calMonth, 0).getDate();
  const selStr = dateInp.value;

  for(let i=0;i<startDow;i++){ cal.appendChild(Object.assign(document.createElement('div'),{className:'cell'})); }
  for(let d=1; d<=daysInMonth; d++){
    const ds = `${calYear}-${pad2(calMonth)}-${pad2(d)}`;
    const cell=document.createElement('div'); cell.className='cell';
    if(ds===todayStr) cell.classList.add('today');
    if(ds===selStr) cell.classList.add('selected');
    cell.onclick=()=>{ dateInp.value=ds; loadDraftIntoEditor(ds); renderCalendar(markers); };

    const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);
    const box=document.createElement('div'); box.className='mark';

    const m=markers[ds]||{};
    if(m.l) box.innerHTML += `<span class="tag l">${m.l}</span>`;
    if(m.d) box.innerHTML += `<span class="tag d">${m.d}</span>`;
    if(drafts.has(ds)) box.innerHTML += `<span class="tag draft">ä¸‹æ›¸ã</span>`;

    cell.appendChild(box);
    cal.appendChild(cell);
  }
}

/* ===== æ—¢å­˜é€ä¿¡ãƒãƒ¼ã‚«ãƒ¼ ===== */
async function loadMonthMarkers(){
  const nm = nameSel.value || '';
  if(!nm){ renderCalendar(); return; }
  const start = `${calYear}-${pad2(calMonth)}-01`;
  const endD = new Date(start); endD.setMonth(endD.getMonth()+1);
  const endStr = endD.toISOString().slice(0,10);

  const { data } = await supa
    .from('shifts')
    .select('date,start_time,end_time')
    .eq('staff_name', nm).gte('date', start).lt('date', endStr);

  const mk={};
  (data||[]).forEach(r=>{
    const v = (!r.start_time || !r.end_time) ? 'â—¯' : `${r.start_time}ã€œ${r.end_time}`;
    const key = r.start_time && r.start_time < "16:00" ? 'l' : 'd';
    mk[r.date] ||= {};
    mk[r.date][key] = mk[r.date][key] ? (mk[r.date][key]+' / '+v) : v;
  });
  renderCalendar(mk);
}

/* ===== ä¸‹æ›¸ãï¼ˆMap<date,{l:{free,start,end}, d:{...}, note}>ï¼‰ ===== */
const drafts = new Map();

function loadDraftIntoEditor(ds){
  const d = drafts.get(ds);
  if(!d){ // ã‚¨ãƒ‡ã‚£ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
    lFree.checked=false; dFree.checked=false;
    lStart.value="10:00"; lEnd.value="16:00";
    dStart.value="17:00"; dEnd.value="24:00";
    memo.value='';
    return;
  }
  lFree.checked = !!d.l?.free;
  dFree.checked = !!d.d?.free;
  if(d.l?.start) lStart.value=d.l.start;
  if(d.l?.end)   lEnd.value=d.l.end;
  if(d.d?.start) dStart.value=d.d.start;
  if(d.d?.end)   dEnd.value=d.d.end;
  memo.value = d.note || '';
}

function renderDraftList(){
  const wrap = $('draftList');
  if(drafts.size===0){ wrap.className='note'; wrap.textContent='ã¾ã ä¸‹æ›¸ãã¯ã‚ã‚Šã¾ã›ã‚“'; return; }
  wrap.className='';
  const arr = Array.from(drafts.entries()).sort((a,b)=>a[0]<b[0]? -1:1);
  let html='';
  arr.forEach(([ds, v])=>{
    const chips=[];
    if(v.l) chips.push(`<span class="chip l">${v.l.free?'â—¯':`${v.l.start}ã€œ${v.l.end}`}</span>`);
    if(v.d) chips.push(`<span class="chip d">${v.d.free?'â—¯':`${v.d.start}ã€œ${v.d.end}`}</span>`);
    html += `
      <div class="draft">
        <div class="row" style="justify-content:space-between">
          <h4>${ds}ï¼ˆ${"æ—¥æœˆç«æ°´æœ¨é‡‘åœŸ"[new Date(ds).getDay()]}ï¼‰</h4>
          <div>
            <button class="ghost" data-d="${ds}" data-act="edit">ç·¨é›†</button>
            <button class="ghost" data-d="${ds}" data-act="del">å‰Šé™¤</button>
          </div>
        </div>
        <div>${chips.join(' ')} ${v.note?`<span class="chip">${v.note.replace(/</g,'&lt;')}</span>`:''}</div>
      </div>`;
  });
  wrap.innerHTML = html;
  wrap.querySelectorAll('button').forEach(b=>{
    b.onclick = (e)=>{
      const ds = b.dataset.d, act=b.dataset.act;
      if(act==='del'){ drafts.delete(ds); renderDraftList(); loadMonthMarkers(); }
      if(act==='edit'){ dateInp.value=ds; loadDraftIntoEditor(ds); renderCalendar(); }
    };
  });
}

/* ===== ä¸‹æ›¸ãã«è¿½åŠ /æ›´æ–°ãƒ»å‰Šé™¤ ===== */
$('addDraftBtn').onclick = ()=>{
  const ds = dateInp.value;
  if(!ds){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const hasLunch = lFree.checked || (lStart.value && lEnd.value);
  const hasDinner = dFree.checked || (dStart.value && dEnd.value);
  if(!hasLunch && !hasDinner){ alert('ãƒ©ãƒ³ãƒã¾ãŸã¯ãƒ‡ã‚£ãƒŠãƒ¼ã®ã©ã¡ã‚‰ã‹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ï¼ˆâ—‹ã§ã‚‚OKï¼‰'); return; }

  const entry={};
  if(hasLunch){ entry.l = lFree.checked ? {free:true} : {start:lStart.value, end:lEnd.value}; }
  if(hasDinner){ entry.d = dFree.checked ? {free:true} : {start:dStart.value, end:dEnd.value}; }
  entry.note = memo.value || '';

  drafts.set(ds, entry);
  renderDraftList(); loadMonthMarkers();
  msg.textContent = `${ds} ã‚’ä¸‹æ›¸ãä¿å­˜ã—ã¾ã—ãŸã€‚`; msg.className='ok';
};
$('delDraftBtn').onclick = ()=>{ const ds=dateInp.value; if(!ds) return; drafts.delete(ds); renderDraftList(); loadMonthMarkers(); };

/* ===== ã™ã¹ã¦è§£é™¤ ===== */
$('clearAllBtn').onclick = ()=>{ if(confirm('ã™ã¹ã¦ã®ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ drafts.clear(); renderDraftList(); loadMonthMarkers(); } };

/* ===== ã¾ã¨ã‚ã¦é€ä¿¡ ===== */
async function submitAll(){
  msg.textContent='é€ä¿¡ä¸­â€¦'; msg.className='note';
  const nm = nameSel.value || '';
  if(!nm){ alert('åå‰ã‚’é¸æŠã—ã¦ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  if(!nameSel.disabled){ alert('ã€Œâœ”ï¸ ãƒ­ãƒƒã‚¯ã€ã§åå‰ã‚’ç¢ºå®šã—ã¦ãã ã•ã„'); return; }
  if(drafts.size===0){ alert('ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“'); return; }

  // rows æ§‹ç¯‰
  const rows=[];
  for(const [ds,v] of drafts){
    if(v.l){ rows.push({date:ds, staff_name:nm, start_time: v.l.free? null : v.l.start, end_time: v.l.free? null : v.l.end, note: v.note}); }
    if(v.d){ rows.push({date:ds, staff_name:nm, start_time: v.d.free? null : v.d.start, end_time: v.d.free? null : v.d.end, note: v.note}); }
  }
  // åŒä¸€(date,staff_name,start_time,end_time) ã¯ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãªã®ã§ upsert
  const { error } = await supa.from('shifts').upsert(rows, { onConflict: 'date,staff_name,start_time,end_time' });
  if(error){ msg.textContent='é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+error.message; msg.className='err'; return; }

  msg.textContent='é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸'; msg.className='ok';
  drafts.clear(); renderDraftList(); loadMonthMarkers(); loadRecent();
}
$('submitAllBtn').onclick = submitAll;
$('submitAllBtn2').onclick = submitAll;

/* ===== æœ€æ–°ã®æå‡ºï¼ˆé‡è¤‡åãªã—ãƒ»æ—¥ä»˜ï¼‹åå‰ã®ã¿ï¼‰ ===== */
async function loadRecent(){
  const ul=$('recentList'); ul.innerHTML='<li class="note">èª­ã¿è¾¼ã¿ä¸­â€¦</li>';
  const { data, error } = await supa
    .from('shifts')
    .select('date,staff_name,created_at')
    .order('created_at',{ascending:false})
    .limit(200);
  if(error){ ul.innerHTML=`<li class="note">ã‚¨ãƒ©ãƒ¼ï¼š${error.message}</li>`; return; }
  if(!data || data.length===0){ ul.innerHTML='<li class="note">ã¾ã æå‡ºã¯ã‚ã‚Šã¾ã›ã‚“</li>'; return; }

  const byDate = new Map();
  data.forEach(r=>{
    if(!r.date || !r.staff_name) return;
    if(!byDate.has(r.date)) byDate.set(r.date, new Set());
    byDate.get(r.date).add(r.staff_name);
  });
  const days = Array.from(byDate.keys()).sort((a,b)=> (a<b?1:-1)).slice(0,7);
  ul.innerHTML='';
  days.forEach(d=>{
    const names = Array.from(byDate.get(d));
    const li=document.createElement('li');
    li.textContent = `${d} ï½œ ${names.join('ã€')}`;
    ul.appendChild(li);
  });
}

/* ===== ãƒŠãƒ“ ===== */
$('toListBtn').onclick  = ()=> location.href = new URL('shiftlink.html', location.href).href;
$('toAdminBtn').onclick = ()=> location.href = new URL('admin.html', location.href).href;

/* ===== åˆæœŸåŒ– ===== */
(async function init(){
  setToToday();
  renderCalendar();
  await loadStaff();
  renderDraftList();
  loadRecent();
  loadMonthMarkers();
})();
</script>
</body>
</html>
