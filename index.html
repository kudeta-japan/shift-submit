<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{
    --fg:#111827;--muted:#6b7280;--bd:#e5e7eb;--bg:#fafafa;--card:#fff;
    --btn:#111827;--ok:#16a34a;--err:#b91c1c;
    --lunch:#fff4c2;--dinner:#ffe1cf;--draft:#e0f2fe
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
       max-width:1150px;margin:24px auto;padding:0 14px;background:var(--bg);color:var(--fg)}
  h1{font-size:1.6rem;margin:0 0 .75rem}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select,button,textarea{border:1px solid var(--bd);border-radius:10px;padding:9px 10px;font-size:15px;background:#fff}
  button{background:var(--btn);color:#fff;border:none;font-weight:700;cursor:pointer}
  button.ghost{background:#fff;color:var(--fg)}
  button:disabled{opacity:.5;cursor:not-allowed}
  .note{color:var(--muted);font-size:.92rem}
  .msg{margin-top:6px;font-weight:700}
  .ok{color:var(--ok)} .err{color:var(--err)}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:12px;padding:14px;margin:12px 0}
  .right{margin-left:auto}

  /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
  .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .dow{font-weight:700;text-align:center;color:#475569}
  .cell{border:1px solid var(--bd);border-radius:10px;min-height:86px;background:#fff;position:relative;padding:6px;cursor:pointer}
  .day{position:absolute;top:6px;left:8px;font-weight:700;font-size:.9rem;color:#4b5563}
  .tag{display:inline-block;border:1px solid var(--bd);border-radius:6px;padding:2px 6px;font-size:.8rem;background:#f8fafc}
  .tag.l{background:var(--lunch)} .tag.d{background:var(--dinner)}
  .tag.s{background:var(--draft)} /* ä¸‹æ›¸ãã‚ã‚Š */
  .selected{outline:2px solid #111827}
  .today{outline:2px solid #f59e0b}

  .box{border:1px dashed var(--bd);border-radius:12px;padding:12px}
  .box.l{background:var(--lunch)} .box.d{background:var(--dinner)}

  .pill{background:#f3f4f6;border:1px solid var(--bd);border-radius:999px;padding:6px 10px}
</style>
</head>
<body>
<h1>KU-DETA ã‚·ãƒ•ãƒˆæå‡º</h1>

<!-- ä¸Šéƒ¨ãƒãƒ¼ï¼šåå‰ãƒ­ãƒƒã‚¯ -->
<div class="card">
  <div class="row">
    <strong>ã‚ãªãŸã®åå‰</strong>
    <select id="nameSel" style="min-width:240px"></select>
    <button id="lockBtn" class="ghost">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
    <span id="lockState" class="note"></span>
    <span class="note right">åŠæœˆã”ã¨ã«æå‡ºã€‚ç· åˆ‡ã¯ 15æ—¥ï¼æœˆæœ«ï¼ˆçŒ¶äºˆ3æ—¥ã¯ç®¡ç†è€…ã®ã¿ç·¨é›†å¯ï¼‰ã€‚æ™‚é–“æŒ‡å®šãªã—ã¯ã€Œâ—¯ã€ã€‚</span>
  </div>
  <div class="row" style="margin-top:8px">
    <button id="toAdmin" class="ghost">âš™ï¸ ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã¸</button>
    <button id="toList"  class="ghost">ğŸ“‹ æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</button>
  </div>
</div>

<!-- å…¥åŠ›ãƒ‘ãƒãƒ«ï¼‹ä¸‹æ›¸ãæ“ä½œ -->
<div class="card">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <button id="prevBtn" class="ghost">Â« å‰æœˆ</button>
      <div class="pill"><span id="ymLabel">YYYYå¹´Mæœˆ</span></div>
      <button id="thisBtn" class="ghost">ä»Šæœˆ</button>
      <button id="nextBtn" class="ghost">æ¬¡æœˆ Â»</button>
    </div>
    <div class="row">
      <label class="note">é¸æŠä¸­ï¼š<span id="selCount">0</span>æ—¥</label>
      <button id="clearSel" class="ghost">ã™ã¹ã¦è§£é™¤</button>
      <button id="sendAll">ğŸ“¨ ã¾ã¨ã‚ã¦é€ä¿¡</button>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠï¼‰<input id="dateInp" type="date"></label>
  </div>

  <div class="row" style="margin-top:8px">
    <div class="box l" style="flex:1 1 360px">
      <div><strong>ãƒ©ãƒ³ãƒï¼ˆ10:00â€“16:00ï¼‰</strong> <span class="note">â€»ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ã€‚æ™‚é–“å…¥åŠ›ã‹ã€Œâ—¯ã€æŒ‡å®šã§é€ä¿¡å¯¾è±¡</span></div>
      <div class="row">
        <label>é–‹å§‹<select id="lStart"></select></label>
        <label>çµ‚äº†<select id="lEnd"></select></label>
        <label class="note"><input type="checkbox" id="lFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
      </div>
    </div>
    <div class="box d" style="flex:1 1 360px">
      <div><strong>ãƒ‡ã‚£ãƒŠãƒ¼ï¼ˆ17:00â€“24:00ï¼‰</strong> <span class="note">â€»ãƒã‚§ãƒƒã‚¯ã¯ä¸è¦ã€‚æ™‚é–“å…¥åŠ›ã‹ã€Œâ—¯ã€æŒ‡å®šã§é€ä¿¡å¯¾è±¡</span></div>
      <div class="row">
        <label>é–‹å§‹<select id="dStart"></select></label>
        <label>çµ‚äº†<select id="dEnd"></select></label>
        <label class="note"><input type="checkbox" id="dFree"> æ™‚é–“æŒ‡å®šãªã—ï¼ˆâ—¯ï¼‰</label>
      </div>
    </div>
  </div>

  <div class="row" style="margin-top:8px">
    <label style="flex:1">å‚™è€ƒï¼ˆä»»æ„ï¼‰<textarea id="memo" rows="2" style="width:100%"></textarea></label>
  </div>

  <div class="row" style="margin-top:8px">
    <button id="addDraft">ã“ã®æ—¥ã‚’ä¸‹æ›¸ãã«è¿½åŠ /æ›´æ–°</button>
    <button id="removeDraft" class="ghost">ã“ã®æ—¥ã‚’ä¸‹æ›¸ãã‹ã‚‰å‰Šé™¤</button>
  </div>

  <div id="msg" class="msg"></div>
</div>

<!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
<div class="card">
  <div class="row note" style="margin-bottom:8px">
    <span class="tag l">ãƒ©ãƒ³ãƒ</span>
    <span class="tag d">ãƒ‡ã‚£ãƒŠãƒ¼</span>
    <span class="tag s">ä¸‹æ›¸ãã‚ã‚Š</span>
    <span class="note">ï¼ ã‚»ãƒ«ã‚’ã‚¯ãƒªãƒƒã‚¯ï¼é¸æŠï¼å†ã‚¯ãƒªãƒƒã‚¯ï¼è§£é™¤</span>
  </div>
  <div id="cal" class="grid"></div>
</div>

<script>
/* ===== Supabase æ¥ç¶š ===== */
const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ===== è¦ç´  ===== */
const $=id=>document.getElementById(id);
const nameSel=$('nameSel'), lockBtn=$('lockBtn'), lockState=$('lockState');
const dateInp=$('dateInp'), lStart=$('lStart'), lEnd=$('lEnd'), dStart=$('dStart'), dEnd=$('dEnd'), lFree=$('lFree'), dFree=$('dFree'), memo=$('memo');
const msg=$('msg'), selCount=$('selCount');

/* ===== ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ï¼ˆinclude=trueã€display_orderâ†’nameï¼‰ ===== */
async function loadStaff(){
  const { data, error } = await supa
    .from('staff')
    .select('name,include,display_order')
    .eq('include', true)
    .order('display_order', {ascending:true})
    .order('name', {ascending:true});
  if(error){ toast('ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š'+error.message,true); return; }
  nameSel.innerHTML='';
  (data||[]).forEach(r=> nameSel.add(new Option(r.name, r.name)));
  const sv=localStorage.getItem('shift_name');
  if(sv && Array.from(nameSel.options).some(o=>o.value===sv)){ nameSel.value=sv; setLock(true); } else { setLock(false); }
}

/* ===== åå‰ãƒ­ãƒƒã‚¯ ===== */
function setLock(on){
  nameSel.disabled=on;
  lockBtn.textContent= on?'ğŸ”“ å¤‰æ›´':'âœ”ï¸ ãƒ­ãƒƒã‚¯';
  lockState.textContent= on?`ãƒ­ãƒƒã‚¯ä¸­ï¼š${nameSel.value}`:'æœªãƒ­ãƒƒã‚¯';
}
lockBtn.onclick=()=>{
  const on=nameSel.disabled;
  if(on){ localStorage.removeItem('shift_name'); setLock(false); }
  else{
    if(!nameSel.value){ alert('åå‰ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
    localStorage.setItem('shift_name', nameSel.value); setLock(true);
    renderCalendar(); // åå‰ç¢ºå®šã—ãŸã‚‰ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
  }
};

/* ===== æ™‚åˆ»ã‚»ãƒ¬ã‚¯ãƒˆï¼ˆ30åˆ†åˆ»ã¿ï¼‰ ===== */
function fillTimes(sel, from, to){ sel.innerHTML=''; for(let m=from;m<=to;m+=30){ const h=String(Math.floor(m/60)).padStart(2,'0'); const mm=String(m%60).padStart(2,'0'); sel.add(new Option(`${h}:${mm}`,`${h}:${mm}`)); } }
fillTimes(lStart, 10*60, 16*60); fillTimes(lEnd, 10*60, 16*60);
fillTimes(dStart, 17*60, 24*60); fillTimes(dEnd, 17*60, 24*60);
lStart.value="10:00"; lEnd.value="16:00"; dStart.value="17:00"; dEnd.value="24:00";

/* ===== ä¸‹æ›¸ãï¼ˆãƒ¡ãƒ¢ãƒªä¸Šï¼‰: drafts[YYYY-MM-DD] = {l:{free,start,end}, d:{...}, note} ===== */
const drafts = {};
function countSelected(){ selCount.textContent = Object.keys(drafts).length; }
$('addDraft').onclick=()=>{
  const dt = dateInp.value; if(!dt){ alert('æ—¥ä»˜ã‚’é¸ã‚“ã§ãã ã•ã„'); return; }
  const one = { note: (memo.value||'').trim() };
  // ãƒ©ãƒ³ãƒ
  if(lFree.checked || (lStart.value && lEnd.value)){
    one.l = { free: !!lFree.checked, start: lFree.checked?null:lStart.value, end: lFree.checked?null:lEnd.value };
  }
  // ãƒ‡ã‚£ãƒŠãƒ¼
  if(dFree.checked || (dStart.value && dEnd.value)){
    one.d = { free: !!dFree.checked, start: dFree.checked?null:dStart.value, end: dFree.checked?null:dEnd.value };
  }
  if(!one.l && !one.d){ alert('ãƒ©ãƒ³ãƒ/ãƒ‡ã‚£ãƒŠãƒ¼ã©ã¡ã‚‰ã‹ã®æ™‚é–“ã‚’å…¥ã‚Œã‚‹ã‹ã€Œâ—¯ã€ã«ã—ã¦ãã ã•ã„'); return; }
  drafts[dt]=one;
  toast(`${dt} ã‚’ä¸‹æ›¸ãä¿å­˜ã—ã¾ã—ãŸ`);
  countSelected(); renderCalendar(); // é’ã‚¿ã‚°ï¼ˆä¸‹æ›¸ãï¼‰ã‚’åæ˜ 
};
$('removeDraft').onclick=()=>{
  const dt=dateInp.value; if(!dt) return;
  delete drafts[dt];
  countSelected(); renderCalendar(); toast(`${dt} ã®ä¸‹æ›¸ãã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
};

/* ===== ã¾ã¨ã‚ã¦é€ä¿¡ ===== */
$('sendAll').onclick=async()=>{
  clearMsg();
  if(!nameSel.disabled){ alert('åå‰ã‚’ãƒ­ãƒƒã‚¯ã—ã¦ãã ã•ã„'); return; }
  const staff=nameSel.value;
  const rows=[];
  Object.entries(drafts).forEach(([date, v])=>{
    if(v.l){ rows.push({date, staff_name:staff, start_time:v.l.start, end_time:v.l.end, note:v.note||''}); }
    if(v.d){ rows.push({date, staff_name:staff, start_time:v.d.start, end_time:v.d.end, note:v.note||''}); }
  });
  if(rows.length===0){ alert('ä¸‹æ›¸ããŒã‚ã‚Šã¾ã›ã‚“'); return; }

  // UNIQUE(date, staff_name, start_time, end_time) ã‚’å®‰å…¨ã«é€šã™ãŸã‚ upsert
  const { error } = await supa
    .from('shifts')
    .upsert(rows, { onConflict:'date,staff_name,start_time,end_time' });
  if(error){ toast('é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼š'+error.message, true); return; }

  toast(`é€ä¿¡ã—ã¾ã—ãŸï¼ˆ${rows.length}ä»¶ï¼‰âœ”ï¸`);
  // ä¸‹æ›¸ãã‚¯ãƒªã‚¢ & å†æç”»
  for(const k of Object.keys(drafts)) delete drafts[k];
  countSelected(); renderCalendar();
};

/* ===== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ ===== */
let cy, cm;
function pad2(n){return String(n).padStart(2,'0');}
function setToday(){
  const t=new Date(); t.setHours(0,0,0,0);
  cy=t.getFullYear(); cm=t.getMonth()+1;
  if(!dateInp.value) dateInp.value=`${cy}-${pad2(cm)}-${pad2(t.getDate())}`;
}
$('prevBtn').onclick=()=>{ cm--; if(cm===0){cm=12;cy--;} renderCalendar(); };
$('nextBtn').onclick=()=>{ cm++; if(cm===13){cm=1;cy++;} renderCalendar(); };
$('thisBtn').onclick=()=>{ setToday(); renderCalendar(); };
$('toAdmin').onclick=()=> location.href='admin.html';
$('toList').onclick =()=> location.href='shiftlink.html';
$('clearSel').onclick=()=>{ for(const k of Object.keys(drafts)) delete drafts[k]; countSelected(); renderCalendar(); };

async function renderCalendar(){
  $('ymLabel').textContent=`${cy}å¹´${cm}æœˆ`;
  const cal=$('cal'); cal.innerHTML='';
  ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'].forEach(w=>{ const d=document.createElement('div'); d.textContent=w; d.className='dow'; cal.appendChild(d); });

  const first=new Date(cy,cm-1,1);
  for(let i=0;i<first.getDay();i++){ cal.appendChild(document.createElement('div')).className='cell'; }
  const days=new Date(cy,cm,0).getDate();

  const todayStr=(d=>`${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`)(new Date());
  const staff=nameSel.value||'';
  let submitted={}; // {dd:[ 'â—¯' or 'HH:MMã€œ..', ... ]}
  if(staff){
    const start=`${cy}-${pad2(cm)}-01`;
    const end=new Date(start); end.setMonth(end.getMonth()+1);
    const { data } = await supa.from('shifts')
      .select('date,start_time,end_time,staff_name')
      .eq('staff_name', staff).gte('date', start).lt('date', end.toISOString().slice(0,10));
    (data||[]).forEach(r=>{
      const d = +r.date.slice(-2);
      const v = (!r.start_time||!r.end_time)?'â—¯':`${r.start_time}ã€œ${r.end_time}`;
      (submitted[d] ||= []).push(v);
    });
  }

  for(let d=1; d<=days; d++){
    const ds=`${cy}-${pad2(cm)}-${pad2(d)}`;
    const cell=document.createElement('div'); cell.className='cell';
    if(ds===todayStr) cell.classList.add('today');
    if(drafts[ds]) cell.style.outline='2px solid #38bdf8'; // draft highlight
    const num=document.createElement('div'); num.className='day'; num.textContent=d; cell.appendChild(num);

    // æ—¢å­˜æå‡ºã‚¿ã‚°
    if(submitted[d]){
      const wrap=document.createElement('div'); wrap.style.cssText='position:absolute;left:6px;right:6px;bottom:6px;display:flex;flex-direction:column;gap:2px;font-size:.8rem';
      submitted[d].slice(0,3).forEach(t=>{
        const isLunch = t!=='â—¯' ? (t.split('ã€œ')[0] < '16:00') : true; // â—¯ã¯ä»®ã«ãƒ©ãƒ³ãƒè‰²
        const tag=document.createElement('div'); tag.textContent=t; tag.className='tag '+(isLunch?'l':'d');
        wrap.appendChild(tag);
      });
      cell.appendChild(wrap);
    }

    // ä¸‹æ›¸ããŒã‚ã‚‹å°
    if(drafts[ds]){
      const s=document.createElement('div'); s.textContent='ä¸‹æ›¸ãã‚ã‚Š'; s.className='tag s';
      s.style.position='absolute'; s.style.top='28px'; s.style.left='6px';
      cell.appendChild(s);
    }

    cell.onclick=()=>{
      // é¸æŠãƒ»è§£é™¤ï¼šã‚¯ãƒªãƒƒã‚¯ã§ dateInp ã‚’åˆã‚ã›ã‚‹ã ã‘ï¼ˆä¸‹æ›¸ãã¯ãƒœã‚¿ãƒ³ã§ç®¡ç†ï¼‰
      document.querySelectorAll('.cell').forEach(x=>x.classList.remove('selected'));
      cell.classList.add('selected');
      dateInp.value = ds;
      // ä¸‹æ›¸ããŒã‚ã‚Œã°åæ˜ 
      const v = drafts[ds];
      if(v){
        memo.value = v.note || '';
        if(v.l){ lFree.checked=!!v.l.free; lStart.value=v.l.start||'10:00'; lEnd.value=v.l.end||'16:00'; } else { lFree.checked=false; }
        if(v.d){ dFree.checked=!!v.d.free; dStart.value=v.d.start||'17:00'; dEnd.value=v.d.end||'24:00'; } else { dFree.checked=false; }
      }
    };

    cal.appendChild(cell);
  }
}

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function toast(t,isErr=false){ msg.textContent=t; msg.className='msg '+(isErr?'err':'ok'); }
function clearMsg(){ msg.textContent=''; msg.className='msg'; }

/* ===== init ===== */
(async function init(){
  setToday();
  await loadStaff();
  // åˆå›ã¯ä»Šæ—¥ã‚’é¸æŠè¡¨ç¤º
  const t=new Date(); document.querySelector('#dateInp').value=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
  renderCalendar();
  // ç›£è¦–ï¼šåå‰å¤‰æ›´æ™‚ã¯ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
  nameSel.onchange=()=>{ if(nameSel.disabled) { localStorage.setItem('shift_name', nameSel.value); } renderCalendar(); };
})();
</script>
</body>
</html>
