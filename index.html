<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KU-DETA ã‚·ãƒ•ãƒˆæå‡ºï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ”¹è‰¯ï¼‹ãƒ‰ãƒ©ãƒ•ãƒˆè¡¨ç¤ºï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --fg:#111827; --muted:#6b7280; --border:#e5e7eb; --bg:#fafafa; --pri:#111827;
      --ok:#0a8; --err:#d22;
      --cell-bg:#ffffff; --cell-submitted:#e6f7ee; --cell-hover:#f3f4f6; --today-ring:#22c55e;
      --sun:#e11d48; --sat:#2563eb; --draft:#fff7cc; /* é€ä¿¡äºˆå®šï¼ˆãƒ‰ãƒ©ãƒ•ãƒˆï¼‰ */
    }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;
         max-width:1000px;margin:32px auto;padding:0 16px;background:var(--bg);color:var(--fg)}
    h1{font-size:1.6rem;margin:0 0 .5rem}
    h2{font-size:1.1rem;margin:20px 0 8px}
    label{display:block;margin:.6rem 0 .2rem;font-weight:600}
    input,select,button,textarea{padding:10px;border:1px solid var(--border);border-radius:10px;font-size:16px;background:#fff}
    button{background:var(--pri);color:#fff;font-weight:700;border:none;cursor:pointer}
    button:hover{opacity:.92}
    .row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap}
    .note{color:var(--muted);font-size:.9rem;margin-top:.35rem}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .help{background:#fff8f8;border:1px solid #ffd6d6;color:#b91c1c;border-radius:10px;padding:10px;margin-top:8px}

    .nav{margin-top:18px}
    .nav a{display:inline-block;margin-right:12px;text-decoration:none;color:var(--pri);font-weight:700}

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ */
    .cal-wrap{margin-top:12px;background:#fff;border:1px solid var(--border);border-radius:12px;overflow:hidden}
    .cal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border)}
    .cal-title{font-weight:800}
    .cal-actions{display:flex;gap:8px}
    .ghost{background:#fff;color:var(--fg);border:1px solid var(--border)}
    .cal-legend{display:flex;gap:12px;align-items:center;color:var(--muted);font-size:.85rem}
    .chip{display:inline-flex;align-items:center;gap:6px}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block;border:1px solid var(--border)}
    .lg-submitted{background:var(--cell-submitted)}
    .lg-today{border-color:var(--today-ring)}
    .lg-selected{background:var(--cell-hover)}
    .lg-draft{background:var(--draft);border-color:#facc15}

    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr)}
    .dow{font-weight:700;font-size:.9rem;color:#374151;padding:8px 0;text-align:center;background:#f7f7f7;border-bottom:1px solid var(--border)}
    .cell{
      min-height:88px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);
      padding:6px;position:relative;background:var(--cell-bg);transition:background-color .15s ease
    }
    .cell:hover{background:var(--cell-hover)}
    .cell:last-child{border-right:0}
    .cell .top{display:flex;gap:6px;align-items:center}
    .cell .day{font-weight:800;font-size:1rem}
    .cell .wday{font-size:.75rem;color:var(--muted)}
    .sun .day{color:var(--sun)} .sat .day{color:var(--sat)}
    .clickable{cursor:pointer}
    .selected{outline:2px solid #111827; outline-offset:-2px; border-radius:6px}
    .today-ring{box-shadow:0 0 0 2px var(--today-ring) inset;border-radius:6px}
    .has-shift{background:var(--cell-submitted)}
    .draft{background:var(--draft)} /* é€ä¿¡äºˆå®šã®è¦‹ãŸç›® */
    .pill{
      position:absolute;bottom:6px;left:6px;right:6px;font-size:.78rem;color:#374151;
      background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:4px 6px;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap
    }
    .flash{animation:flash 900ms ease}
    @keyframes flash{0%{box-shadow:0 0 0 0 rgba(34,197,94,.0)}40%{box-shadow:0 0 0 6px rgba(34,197,94,.35)}100%{box-shadow:0 0 0 0 rgba(34,197,94,.0)}}

    .two-col{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    @media (max-width:900px){ .two-col{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <h1>KUâ€‘DETA ã‚·ãƒ•ãƒˆæå‡º</h1>
  <p class="note">ã¾ãšã¯åå‰ã‚’é¸ã¶ã‹ã€æ–°è¦ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚æ—¥æ›œãŒå·¦ç«¯ã®7åˆ—ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ã€ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨å³ã®ãƒ•ã‚©ãƒ¼ãƒ ã«æ—¥ä»˜ãŒå…¥ã‚Šã¾ã™ã€‚</p>

  <!-- åå‰é¸æŠ + æ–°è¦ç™»éŒ² + ãƒ­ãƒƒã‚¯ -->
  <div class="row">
    <div style="flex:1;min-width:260px">
      <label>ã‚ãªãŸã®åå‰ï¼ˆç™»éŒ²æ¸ˆã¿ï¼‰</label>
      <select id="nameSel"></select>
      <div id="nameHelp" class="help" style="display:none"></div>
    </div>
    <div class="row" style="gap:6px">
      <div>
        <label>æ–°è¦ç™»éŒ²</label>
        <input id="newName" placeholder="ä¾‹ï¼šä¹…ç´ çœŸå¸Œ" />
      </div>
      <button id="addBtn">ï¼‹ ç™»éŒ²</button>
    </div>
    <div>
      <label>ãƒ­ãƒƒã‚¯</label>
      <button id="lockBtn">âœ”ï¸ ãƒ­ãƒƒã‚¯</button>
    </div>
  </div>
  <div id="nameMsg" class="note"></div>

  <div class="two-col">
    <!-- å·¦ï¼šã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ -->
    <section>
      <div class="cal-wrap">
        <div class="cal-head">
          <div class="cal-title" id="calTitle">â€”</div>
          <div class="cal-actions">
            <button id="prevMonth" class="ghost" title="å‰ã®æœˆ">â€¹ å‰æœˆ</button>
            <button id="thisMonth" class="ghost" title="ä»Šæœˆ">ä»Šæœˆ</button>
            <button id="nextMonth" class="ghost" title="æ¬¡ã®æœˆ">æ¬¡æœˆ â€º</button>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;border-bottom:1px solid var(--border)">
          <div class="cal-legend">
            <span class="chip"><span class="dot lg-submitted"></span>æå‡ºæ¸ˆã¿</span>
            <span class="chip"><span class="dot lg-draft"></span>é€ä¿¡äºˆå®š</span>
            <span class="chip"><span class="dot lg-today"></span>ä»Šæ—¥</span>
            <span class="chip"><span class="dot lg-selected"></span>é¸æŠä¸­</span>
          </div>
          <div class="note">é–‹å§‹/çµ‚äº†ã‚’å…¥ã‚Œã‚‹ã¨ã€Œé€ä¿¡äºˆå®šã€ã§è‰²ã¥ãã¾ã™</div>
        </div>
        <div class="cal-grid" id="calGrid">
          <div class="dow">æ—¥</div><div class="dow">æœˆ</div><div class="dow">ç«</div>
          <div class="dow">æ°´</div><div class="dow">æœ¨</div><div class="dow">é‡‘</div><div class="dow">åœŸ</div>
        </div>
      </div>
    </section>

    <!-- å³ï¼šå…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <section>
      <h2>ã“ã®æ—¥ã®ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²</h2>
      <form id="shiftForm">
        <label>æ—¥ä»˜ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠå¯ï¼‰</label>
        <input type="date" id="date" required />

        <div class="row">
          <div style="flex:1;min-width:160px">
            <label>é–‹å§‹</label>
            <input type="time" id="start" required />
          </div>
          <div style="flex:1;min-width:160px">
            <label>çµ‚äº†</label>
            <input type="time" id="end" required />
          </div>
        </div>

        <label>å‚™è€ƒï¼ˆä»»æ„ï¼‰</label>
        <textarea id="note" rows="2" placeholder="é…åˆ»ãƒ»æ—©é€€ãƒ»å¸Œæœ›ãªã©"></textarea>

        <button type="submit" style="margin-top:12px">ğŸ“¨ é€ä¿¡</button>
        <div id="msg" class="note"></div>
      </form>

      <div class="nav">
        <a href="./shiftlist.html">æå‡ºä¸€è¦§ã‚’è¦‹ã‚‹</a>
      </div>

      <h2>æœ€æ–°ã®æå‡º</h2>
      <ul id="list"><li>èª­ã¿è¾¼ã¿ä¸­â€¦</li></ul>
    </section>
  </div>

  <script>
    // ====== Supabaseï¼ˆè‡ªåˆ†ã®å€¤ã«ç½®æ›ï¼‰ ======
    const SUPABASE_URL = "https://wnttziqspjkrinymnodz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndudHR6aXFzcGprcmlueW1ub2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNzE0OTMsImV4cCI6MjA3MDc0NzQ5M30.lKbZM4TCtEyhdU9lBnFPMnRWXMpKybqfIWATaD3m0xI";
    // =========================================
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const $ = id => document.getElementById(id);

    // ==== åå‰ãƒã‚¹ã‚¿ï¼ˆstaffï¼‰ ====
    async function loadStaff(selected=null){
      const help = $('nameHelp'); help.style.display='none'; help.textContent='';
      const { data, error } = await client.from('staff').select('*').eq('include', true).order('name');
      if(error){
        // staff ãƒ†ãƒ¼ãƒ–ãƒ«æœªä½œæˆãªã©ï¼šã‚„ã•ã—ã„æ¡ˆå†…ã«ç½®ãæ›ãˆ
        help.style.display='block';
        help.innerHTML = 'åå‰ãƒã‚¹ã‚¿ï¼ˆstaffï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Supabase ã® SQL Editor ã§ã€<b>staff / shifts ä½œæˆSQL</b>ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚<br>ï¼ˆã“ã®ç”»é¢ä¸‹ã®æŒ‡ç¤ºã®ã€Œâ‘  Supabaseï¼šãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ & æœ€å°ãƒãƒªã‚·ãƒ¼ã€ï¼‰';
        return;
      }
      const sel = $('nameSel'); sel.innerHTML='';
      (data||[]).forEach(r=>{
        const opt = new Option(r.name, r.name);
        if(selected && selected===r.name) opt.selected=true;
        sel.add(opt);
      });
      if(!sel.value && data?.length) sel.value = data[0].name;

      const sv = localStorage.getItem('shiftName');
      if(sv && [...sel.options].some(o=>o.value===sv)){ sel.value=sv; toggleLock(true); }
      refreshMyMonth();
    }
    $('addBtn').onclick = async ()=>{
      const nm = $('newName').value.trim();
      if(!nm){ alert('åå‰ã‚’å…¥åŠ›'); return; }
      $('nameMsg').textContent='ç™»éŒ²ä¸­â€¦';
      const { error } = await client.from('staff').insert({ name: nm });
      if(error){
        $('nameMsg').innerHTML = '<span class="err">ã‚¨ãƒ©ãƒ¼: '+error.message+'</span>';
      }else{
        $('nameMsg').innerHTML = '<span class="ok">ç™»éŒ²ã—ã¾ã—ãŸ âœ”ï¸</span>';
        $('newName').value='';
        await loadStaff(nm);
      }
    };
    function toggleLock(forceOn){
      const sel = $('nameSel');
      const on = forceOn ?? !sel.disabled;
      if(on){
        if(!sel.value){ alert('åå‰ã‚’é¸æŠ'); return; }
        sel.disabled = true; sel.style.opacity=.6; $('lockBtn').textContent='ğŸ”“ å¤‰æ›´';
        localStorage.setItem('shiftName', sel.value);
      }else{
        sel.disabled = false; sel.style.opacity=1; $('lockBtn').textContent='âœ”ï¸ ãƒ­ãƒƒã‚¯';
        localStorage.removeItem('shiftName');
      }
      refreshMyMonth();
    }
    $('lockBtn').onclick = ()=>toggleLock();
    $('nameSel').onchange = ()=>refreshMyMonth();

    // ==== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ====
    const WDAY = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];
    function fmtYMD(y,m,d){ return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
    function parseYMD(s){ const [y,m,d]=s.split('-').map(Number); return {y,m,d}; }

    // ==== ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼çŠ¶æ…‹ ====
    let calYear, calMonth; // 1-12
    let myMonthMap = new Map(); // day -> [{start_time,end_time,note}, ...]

    // å³ãƒ•ã‚©ãƒ¼ãƒ ã®å…¥åŠ›ï¼ˆä»Šå›é€ä¿¡äºˆå®šï¼‰ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
    function updateDraftPreview(){
      // 1) ã¾ãšã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†æç”»ã§ selected/draft åˆ¤å®šã‚’æœ€æ–°ã«
      rebuildCalendar();
      // 2) é¸æŠã‚»ãƒ«ã«ãƒ‰ãƒ©ãƒ•ãƒˆãƒ”ãƒ«ã‚’æç”»
      const date = $('date').value;
      const st = $('start').value, en = $('end').value;
      if(!date || !st || !en) return;
      const {d} = parseYMD(date);
      const grid = $('calGrid');
      const cells = grid.querySelectorAll('.cell.clickable'); // å½“æœˆã®ã¿
      const target = cells[d-1];
      if(target){
        target.classList.add('draft');
        // æ—¢å­˜ãƒ”ãƒ«ã‚’ä¸€æ—¦å‰Šé™¤ï¼ˆå†ç”Ÿæˆï¼‰
        const old = target.querySelector('.pill.draft');
        if(old) old.remove();
        const pill = document.createElement('div');
        pill.className = 'pill draft';
        pill.textContent = `äºˆå®š ${st.slice(0,5)}â€“${en.slice(0,5)}`;
        target.appendChild(pill);
      }
    }

    async function refreshMyMonth(){
      const name = $('nameSel').value;
      if(!name){ myMonthMap = new Map(); rebuildCalendar(); return; }
      const from = fmtYMD(calYear, calMonth, 1);
      const toDate = new Date(calYear, calMonth, 0).getDate();
      const to = fmtYMD(calYear, calMonth, toDate);

      const { data, error } = await client
        .from('shifts')
        .select('date,start_time,end_time,note')
        .eq('staff_name', name)
        .gte('date', from).lte('date', to);

      myMonthMap = new Map();
      if(!error && Array.isArray(data)){
        data.forEach(r=>{
          const d = Number(r.date.slice(-2));
          const arr = myMonthMap.get(d) || [];
          arr.push(r);
          myMonthMap.set(d, arr);
        });
      }
      rebuildCalendar();
    }

    function rebuildCalendar(){
      const grid = $('calGrid');
      while(grid.children.length > 7) grid.removeChild(grid.lastChild);

      const first = new Date(calYear, calMonth-1, 1);
      const last  = new Date(calYear, calMonth, 0);
      const days  = last.getDate();
      const startDow = first.getDay();
      const today = new Date(); today.setHours(0,0,0,0);
      $('calTitle').textContent = `${calYear}å¹´ ${calMonth}æœˆ`;

      for(let i=0;i<startDow;i++){
        const div = document.createElement('div');
        div.className = 'cell muted';
        grid.appendChild(div);
      }

      const selected = $('date').value;
      for(let d=1; d<=days; d++){
        const dow = new Date(calYear, calMonth-1, d).getDay();
        const div = document.createElement('div');
        const ymd = fmtYMD(calYear,calMonth,d);

        let cls = 'cell clickable';
        if(dow===0) cls+=' sun'; else if(dow===6) cls+=' sat';
        if(selected === ymd) cls+=' selected';
        const isToday = (today.getFullYear()===calYear && (today.getMonth()+1)===calMonth && today.getDate()===d);
        if(isToday) cls+=' today-ring';

        const mine = myMonthMap.get(d) || [];
        if(mine.length) cls+=' has-shift';

        div.className = cls;
        div.innerHTML = `
          <div class="top">
            <div class="day">${d}</div>
            <span class="wday">(${WDAY[dow]})</span>
          </div>
        `;

        if(mine.length){
          const first = mine[0];
          const label = `${first.start_time?.slice(0,5) || '--:--'}â€“${first.end_time?.slice(0,5) || '--:--'}${mine.length>1 ? 'ã€€+'+(mine.length-1)+'ä»¶' : ''}`;
          const pill = document.createElement('div');
          pill.className='pill';
          pill.textContent = label;
          div.appendChild(pill);
        }

        div.addEventListener('click', ()=>{
          const wasSelected = ($('date').value === ymd);
          $('date').value = ymd;
          rebuildCalendar();
          if(wasSelected){ $('start').focus(); }
        });

        grid.appendChild(div);
      }

      const rem = grid.children.length % 7;
      if(rem !== 0){
        for(let i=0;i<7-rem;i++){
          const div = document.createElement('div');
          div.className = 'cell muted';
          grid.appendChild(div);
        }
      }

      // é¸æŠã‚»ãƒ«ã«ãƒ‰ãƒ©ãƒ•ãƒˆè¡¨ç¤ºã‚’åæ˜ 
      updateDraftPreview();
    }

    function initCalendarFromToday(){
      const t = new Date();
      calYear = t.getFullYear();
      calMonth = t.getMonth()+1;
      $('date').value = fmtYMD(calYear, calMonth, t.getDate());
      rebuildCalendar();
    }
    $('prevMonth').onclick = ()=>{ calMonth--; if(calMonth===0){ calMonth=12; calYear--; } refreshMyMonth(); };
    $('nextMonth').onclick = ()=>{ calMonth++; if(calMonth===13){ calMonth=1; calYear++; } refreshMyMonth(); };
    $('thisMonth').onclick = ()=>{ const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1; refreshMyMonth(); };

    // å…¥åŠ›å¤‰åŒ–ã§ãƒ‰ãƒ©ãƒ•ãƒˆè‰²ï¼†ãƒ”ãƒ«ã‚’æ›´æ–°
    $('date').addEventListener('change', ()=>{ const {y,m}=parseYMD($('date').value); if(y&&m){ calYear=y; calMonth=m; } updateDraftPreview(); });
    $('start').addEventListener('input', updateDraftPreview);
    $('end').addEventListener('input', updateDraftPreview);

    // ==== é€ä¿¡ ====
    $('shiftForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const staff_name = $('nameSel').value;
      if(!staff_name){ alert('å…ˆã«åå‰ã‚’é¸ã¶ã‹ç™»éŒ²ã—ã¦ãã ã•ã„'); return; }

      const date = $('date').value, st=$('start').value, en=$('end').value;
      if(!date || !st || !en){ alert('æ—¥ä»˜ãƒ»é–‹å§‹ãƒ»çµ‚äº†ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }
      $('msg').textContent='é€ä¿¡ä¸­â€¦';

      const row = { staff_name, date, start_time: st, end_time: en, note: $('note').value.trim() || null };
      const { error } = await client.from('shifts').insert(row);
      if(error){ $('msg').innerHTML = '<span class="err">Error: '+error.message+'</span>'; return; }

      $('msg').innerHTML = '<span class="ok">é€ä¿¡ã—ã¾ã—ãŸ âœ”ï¸</span>';
      // æœˆå†…ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æ›´æ–°â†’æå‡ºè¡¨ç¤ºï¼†ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
      const {d} = parseYMD(date);
      const arr = myMonthMap.get(d) || []; arr.unshift({start_time:st, end_time:en, note:row.note}); myMonthMap.set(d, arr);
      rebuildCalendar();
      const grid = $('calGrid'); const cellList = grid.querySelectorAll('.cell.clickable'); const target = cellList[d-1];
      if(target){ target.classList.add('flash'); setTimeout(()=>target.classList.remove('flash'), 1000); }

      e.target.reset(); $('date').value = date; updateDraftPreview(); // é¸æŠç¶­æŒï¼†ãƒ‰ãƒ©ãƒ•ãƒˆæ¶ˆå»
      loadList();
    });

    // ==== æœ€æ–°10ä»¶ ====
    async function loadList(){
      const { data, error } = await client
        .from('shifts')
        .select('*')
        .order('date', { ascending:false })
        .order('created_at', { ascending:false })
        .limit(10);
      if(error){ $('list').innerHTML = '<li class="err">èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</li>'; return; }
      if(!data.length){ $('list').innerHTML = '<li>ã¾ã æå‡ºã¯ã‚ã‚Šã¾ã›ã‚“</li>'; return; }
      $('list').innerHTML = data.map(s =>
        `<li>${s.date} ï½œ ${s.staff_name} ï½œ ${s.start_time}â€“${s.end_time} ${s.note? 'ï¼ˆ'+s.note+'ï¼‰':''}</li>`
      ).join('');
    }

    // ==== åˆæœŸãƒ­ãƒ¼ãƒ‰ ====
    (async ()=>{
      await loadStaff();
      const t=new Date(); calYear=t.getFullYear(); calMonth=t.getMonth()+1;
      initCalendarFromToday();
      refreshMyMonth();
      loadList();
    })();
  </script>
</body>
</html>
